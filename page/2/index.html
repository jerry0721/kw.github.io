<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="K.W. 时间囊">
<meta property="og:url" content="https://kuwork.github.io/page/2/index.html">
<meta property="og:site_name" content="K.W. 时间囊">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="K.W. 时间囊">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kuwork.github.io/page/2/"/>





  <title> K.W. 时间囊 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">K.W. 时间囊</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">停下来休息的时候,不要忘记别人还在奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/04/18/Android-GridInputView-密码输入框-车牌输入框-自定义键盘输入-/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/18/Android-GridInputView-密码输入框-车牌输入框-自定义键盘输入-/" itemprop="url">
                  Android GridInputView 密码输入框/车牌输入框 自定义键盘输入
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-18T16:11:00+08:00">
                2017-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-6bb6ca40c2f27039.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这几天产品又找我麻烦了。让我精简车牌的输入过程。这就是成果。对一年未更新的老项目<a href="https://github.com/Jungerr/GridPasswordView" target="_blank" rel="noopener">GridPasswordView 项目</a>改动较多，填了不少坑，也不少给自己挖。</p>
<h2 id="具体效果如下："><a href="#具体效果如下：" class="headerlink" title="具体效果如下："></a>具体效果如下：</h2><p><img src="https://github.com/kuwork/GridPasswordView/raw/master/demo/platenumber_demo.gif" alt="车牌输入"></p>
<p>增加选中框，支持中间修改、删除，支持多种键盘。</p>
<h2 id="原效果如下："><a href="#原效果如下：" class="headerlink" title="原效果如下："></a>原效果如下：</h2><p><img src="https://camo.githubusercontent.com/a7c72f6fc86e8e839c58d1795d294cd0480534e2/687474703a2f2f6a756e676572722e71696e6975646e2e636f6d2f6772696470617373776f7264766965775f302e322e676966" alt=""></p>
<p>原来效果完全支持。增加单词连续输入.解决绘制bug等等。</p>
<h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> gpvPlateNumber.togglePasswordVisibility();</span><br><span class="line">        gpvPlateNumber.setOnPasswordChangedListener(<span class="keyword">new</span> GridPasswordView.OnPasswordChangedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeInput</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (position == <span class="number">0</span>) &#123;</span><br><span class="line">                    viewKeyboard.setKeyboard(<span class="keyword">new</span> Keyboard(MainActivity.<span class="keyword">this</span>, R.xml.provice));</span><br><span class="line">                    viewKeyboard.setVisibility(View.VISIBLE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &gt;= <span class="number">1</span> &amp;&amp; position &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    viewKeyboard.setKeyboard(<span class="keyword">new</span> Keyboard(MainActivity.<span class="keyword">this</span>, R.xml.english));</span><br><span class="line">                    viewKeyboard.setVisibility(View.VISIBLE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &gt;= <span class="number">2</span> &amp;&amp; position &lt; <span class="number">6</span>) &#123;</span><br><span class="line">                    viewKeyboard.setKeyboard(<span class="keyword">new</span> Keyboard(MainActivity.<span class="keyword">this</span>, R.xml.qwerty_without_chinese));</span><br><span class="line">                    viewKeyboard.setVisibility(View.VISIBLE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &gt;= <span class="number">6</span> &amp;&amp; position &lt; <span class="number">7</span>) &#123;</span><br><span class="line">                    viewKeyboard.setKeyboard(<span class="keyword">new</span> Keyboard(MainActivity.<span class="keyword">this</span>, R.xml.qwerty));</span><br><span class="line">                    viewKeyboard.setVisibility(View.VISIBLE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                viewKeyboard.setVisibility(View.GONE);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(String psw)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInputFinish</span><span class="params">(String psw)</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>本来想把键盘独立出来的。但是时间比较紧，想凑合着用先。<br>项目地址：<a href="https://github.com/kuwork/GridPasswordView" target="_blank" rel="noopener">https://github.com/kuwork/GridPasswordView</a></p>
<p>我的实际使用效果：<br><img src="http://upload-images.jianshu.io/upload_images/3020228-e165fa614fb01b62.gif?imageMogr2/auto-orient/strip" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/27/Android-Small-官方使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/27/Android-Small-官方使用指南/" itemprop="url">
                  Android Small 官方使用指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-27T09:34:00+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-116e04cc176ef3d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Small使用指南，您了解Small所需要的一切。"></p>
<p>你是否曾经在入门的道路上受阻？半路被坑埋了？现在不用怕了，更加详尽的官方教程来了。</p>
<h1 id="Small使用指南上线了"><a href="#Small使用指南上线了" class="headerlink" title="Small使用指南上线了"></a><a href="http://code.wequick.net/Small/cn/home" target="_blank" rel="noopener">Small使用指南</a>上线了</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/18/使用Gradle发布aar-jar项目到JCenter仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/18/使用Gradle发布aar-jar项目到JCenter仓库/" itemprop="url">
                  使用Gradle发布aar/jar项目到JCenter仓库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T17:35:57+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-7d38ce9eb0b416f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<hr>
<h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><p>发布自己的android library（也就是aar/jar）到公共的jcenter仓库，所有的人都能用gradle最简单的方式引用。为什么选择jcenter，它兼容maven，而且支持更多形式仓库，android studio最新版本已经默认jcenter了。</p>
<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>Android Studio 2.2.2</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="http://www.cnblogs.com/qianxudetianxia/p/4322331.html" target="_blank" rel="noopener">使用Gradle发布Android开源项目到JCenter</a></p>
<p>在这个基础上，修正一些导入库问题。</p>
<h2 id="一、注册账号"><a href="#一、注册账号" class="headerlink" title="一、注册账号"></a>一、注册账号</h2><p>在 <a href="https://bintray.com/signup/oss" target="_blank" rel="noopener">https://bintray.com/signup/oss</a> 上注册一个账号。我是以github账号直接登陆的。<br><strong>注意看上面的地址，直接使用，首页那个按钮是坑货。</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-157100f9d3c13514.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页企业注册按钮"></p>
<p><strong>这才是真的个人注册页面！</strong><br><img src="http://upload-images.jianshu.io/upload_images/3020228-d73943d910d78ece.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="个人注册页面"></p>
<h2 id="二、记录API-Key"><a href="#二、记录API-Key" class="headerlink" title="二、记录API Key"></a>二、记录API Key</h2><p>注册后，在 <a href="https://bintray.com/profile/edit" target="_blank" rel="noopener">https://bintray.com/profile/edit</a> 页面的左边菜单的最下面有API Key，点击后：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-9e1532e71cc32d0d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>复制明文API key，后面会用到。</p>
<p>然后创建一个Maven仓库。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-4be6bee8028159df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>注意名称必须是maven。类型当然也是Maven。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-4f3fa25e89f5516b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="三、新建项目（以RxBus为例）"><a href="#三、新建项目（以RxBus为例）" class="headerlink" title="三、新建项目（以RxBus为例）"></a>三、新建项目（以RxBus为例）</h2><p>在Android Studio中New一个Project。完成之后在RxBus的根目录下会有一个build.gradle,在buildscript/dependencies中添加两个classpath：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classpath <span class="string">'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.7.3'</span></span><br><span class="line">classpath <span class="string">'com.github.dcendents:android-maven-gradle-plugin:1.5'</span></span><br></pre></td></tr></table></figure>
<p>这里注意 <strong>版本太旧，会报错</strong>。</p>
<p>这是两个帮助发布项目的插件，完整的project build.gradle请查看<a href="https://github.com/kuwork/rxbus/blob/master/build.gradle#L9L10" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="四、新建模块"><a href="#四、新建模块" class="headerlink" title="四、新建模块"></a>四、新建模块</h2><p>在当前Project中New一个Module，比如我这里叫rxbus，是一个完整的Android Library，就可以以aar/jar的形式发布了。完成之后在rxbus下也会有一个build.gradle，这个build.gradle是今天的重中之重。</p>
<h2 id="五、构建build-gradle"><a href="#五、构建build-gradle" class="headerlink" title="五、构建build.gradle"></a>五、构建build.gradle</h2><p>默认的build.gradle大概是这样的：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.library'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">"25.0.2"</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">9</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName version</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</span><br><span class="line">        exclude <span class="string">group:</span> <span class="string">'com.android.support'</span>, <span class="string">module:</span> <span class="string">'support-annotations'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    compile <span class="string">'com.jakewharton.rxrelay2:rxrelay:2.0.0'</span></span><br><span class="line">    provided <span class="string">'io.reactivex.rxjava2:rxjava:2.0.1'</span></span><br><span class="line">    provided <span class="string">'io.reactivex.rxjava2:rxandroid:2.0.1'</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们一步步修改补充这个build.gradle<br>1.添加插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.github.dcendents.android-maven'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.jfrog.bintray'</span></span><br></pre></td></tr></table></figure>
<p>2.定义版本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">version = <span class="string">"0.1"</span></span><br></pre></td></tr></table></figure>
<p>3.定义相关网站<br>有单独的官方网站那是最好的，没用的话就用git网址就可以了。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> siteUrl = <span class="string">'https://github.com/kuwork/rxbus'</span> <span class="comment">// project homepage</span></span><br><span class="line"><span class="keyword">def</span> gitUrl = <span class="string">'https://github.com/kuwork/rxbus.git'</span> <span class="comment">// project git</span></span><br></pre></td></tr></table></figure>
<p>4.定义Group<br>举个例子，当我们引用recylerview的时候是这样的：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.android.support:recyclerview-v7:21.0.2'</span></span><br></pre></td></tr></table></figure>
<p>引号内字符串以”:”分割为三部分，第一部分就是group，第二部分是name， 第三部分是上面定义的version。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根节点添加group = "com.kw"</span></span><br></pre></td></tr></table></figure>
<p>5.定义pom并打包aar/jar<br>上传到jcenter至少需要四个文件，除了打包的aar之外，还需要pom和javadoc，source，否则是通不过jcenter审核的。不过不用紧张，这些我们都可以用脚本生成。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">install &#123;</span><br><span class="line">    repositories.mavenInstaller &#123;</span><br><span class="line">        <span class="comment">// This generates POM.xml with proper parameters</span></span><br><span class="line">        pom &#123;</span><br><span class="line">            project &#123;</span><br><span class="line">                packaging <span class="string">'jar'</span></span><br><span class="line">                name <span class="string">'RxBus'</span></span><br><span class="line">                url siteUrl</span><br><span class="line">                licenses &#123;</span><br><span class="line">                    license &#123;</span><br><span class="line">                        name <span class="string">'The Apache Software License, Version 2.0'</span></span><br><span class="line">                        url <span class="string">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                developers &#123;</span><br><span class="line">                    developer &#123;</span><br><span class="line">                        id <span class="string">'rxbus'</span></span><br><span class="line">                        name <span class="string">'com.kw.rxbus'</span></span><br><span class="line">                        email <span class="string">'kuwork@126.com'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                scm &#123;</span><br><span class="line">                    connection gitUrl</span><br><span class="line">                    developerConnection gitUrl</span><br><span class="line">                    url siteUrl</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.打包javadocjar和sourcejar<br>这两个也是上传到jcenter必须要的。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">task sourcesJar(<span class="string">type:</span> Jar) &#123;</span><br><span class="line">    from android.sourceSets.main.java.srcDirs</span><br><span class="line">    classifier = <span class="string">'sources'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task javadoc(<span class="string">type:</span> Javadoc) &#123;</span><br><span class="line">    source = android.sourceSets.main.java.srcDirs</span><br><span class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task javadocJar(<span class="string">type:</span> Jar, <span class="string">dependsOn:</span> javadoc) &#123;</span><br><span class="line">    classifier = <span class="string">'javadoc'</span></span><br><span class="line">    from javadoc.destinationDir</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">artifacts &#123;</span><br><span class="line">    archives javadocJar</span><br><span class="line">    archives sourcesJar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.上传到Jcenter仓库<br>上传到jcenter的网站BinTray，需要用户验证，需要2个值：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例值， 仅供参考</span></span><br><span class="line">bintray.user=用户名 <span class="comment">// your bintray user </span></span><br><span class="line">namebintray.apikey=******** <span class="comment">// your bintray api key</span></span><br></pre></td></tr></table></figure>
<p>第二个API Key就是你在上面记录的API Key。因为这个属于个人隐私，一般不能传到网上去，所以需要在记录到LessCode下的local.properties中(利用gitignore忽略这个文件到git)，然后脚本再从local.properties中读取这两个值。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties()</span><br><span class="line"><span class="keyword">boolean</span> isHasFile = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (project.rootProject.file(<span class="string">'local.properties'</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">    isHasFile = <span class="literal">true</span></span><br><span class="line">    properties.load(project.rootProject.file(<span class="string">'local.properties'</span>).newDataInputStream())</span><br><span class="line">&#125;</span><br><span class="line">bintray &#123;</span><br><span class="line">    user = isHasFile ? properties.getProperty("bintray.user") : System.getenv(<span class="string">"bintray.user"</span>)</span><br><span class="line">    key = isHasFile ? properties.getProperty("bintray.apikey") : System.getenv(<span class="string">"bintray.apikey"</span>)</span><br><span class="line">    configurations = [<span class="string">'archives'</span>]</span><br><span class="line">    pkg &#123;</span><br><span class="line">        repo = <span class="string">"maven"</span></span><br><span class="line">        name = <span class="string">"rxbus"</span> <span class="comment">//项目名称</span></span><br><span class="line">        websiteUrl = siteUrl</span><br><span class="line">        vcsUrl = gitUrl</span><br><span class="line">        licenses = [<span class="string">"Apache-2.0"</span>]</span><br><span class="line">        publish = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的build.gradle,请参考<a href="https://github.com/kuwork/rxbus/blob/master/rxbus/build.gradle" target="_blank" rel="noopener">rxbus/build.gradle</a>。</p>
<p>8.执行<br>根据上面的build.gradle,会产生几个特别的gradle任务：<br>通过gradlew执行这些任务即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gradlew javadocJar</span><br><span class="line">gradlew sourcesJar</span><br><span class="line">gradlew install</span><br><span class="line">gradlew bintrayUpload</span><br></pre></td></tr></table></figure>
<p><strong> PS </strong></p>
<ul>
<li>如果上传的版本号一样，在执行gradlew bintrayUpload时失败</li>
</ul>
<p>或者通过Android Studio的最右边栏的Gradle窗口分别可视化操作，点击执行：<img src="http://upload-images.jianshu.io/upload_images/3020228-ad3f1489a142efa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>9.请求审核<br>当bintrayUpload成功之后，<br>在我的主页<strong><a href="https://bintray.com/你的用户名/maven" target="_blank" rel="noopener">https://bintray.com/你的用户名/maven</a></strong> 会看到你提交了一个项目：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-d6456765a5b70002.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>点击项目名称，进入详情页，右下角找到<br><img src="http://upload-images.jianshu.io/upload_images/3020228-1559f9a41f5d4ae0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>鼠标放上去它会提示你去提交审核，点击进入后，随便写什么都可以了。<br>只要上面没问题，一般审核很快，几个小时就差不多了。</p>
<p><strong>PS</strong></p>
<ul>
<li>如果你开始像我一样没注意就注册了一个企业账号。那样就看不到这个按钮了。</li>
<li>即使看到按钮也未必能跳转（一开始我使用bintray-release，可以上传成功，无法提交Jcenter，点击会出现POM.xml缺失提示）。</li>
</ul>
<p>小结<br>相对于android源码或者jar包的形式，开发者可能更乐意以这种方式开源自己的android框架或者组件。<br>对于使用者来说，引用方式更简单了<br>对于开发者开说，能够被中心仓库接受，是一种认可。</p>
<p>更多参考，请查看<a href="https://github.com/kuwork/rxbus" target="_blank" rel="noopener">基于Rxjava2+RxDelay 的RxBus</a>。</p>
<h4 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h4><p>发布自己的android library（也就是aar/jar）到公共的jcenter仓库，所有的人都能用gradle最简单的方式引用。为什么选择jcenter，它兼容maven，而且支持更多形式仓库，android studio最新版本已经默认jcenter了。</p>
<h4 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h4><p>Android Studio 2.2.2</p>
<h4 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="http://www.cnblogs.com/qianxudetianxia/p/4322331.html" target="_blank" rel="noopener">使用Gradle发布Android开源项目到JCenter</a></p>
<p>在这个基础上，修正一些导入库问题。</p>
<h2 id="一、注册账号-1"><a href="#一、注册账号-1" class="headerlink" title="一、注册账号"></a>一、注册账号</h2><p>在<a href="https://bintray.com/signup/oss上注册一个账号。我是以github账号直接登陆的。" target="_blank" rel="noopener">https://bintray.com/signup/oss上注册一个账号。我是以github账号直接登陆的。</a><br><strong>注意看上面的地址，直接使用，首页那个按钮是坑货。</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-157100f9d3c13514.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="首页企业注册按钮"></p>
<p><strong>这才是真的个人注册页面！</strong><br><img src="http://upload-images.jianshu.io/upload_images/3020228-d73943d910d78ece.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="个人注册页面"></p>
<h2 id="二、记录API-Key-1"><a href="#二、记录API-Key-1" class="headerlink" title="二、记录API Key"></a>二、记录API Key</h2><p>注册后，在<a href="https://bintray.com/profile/edit页面的左边菜单的最下面有API" target="_blank" rel="noopener">https://bintray.com/profile/edit页面的左边菜单的最下面有API</a> Key，点击后：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-9e1532e71cc32d0d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>复制明文API key，后面会用到。</p>
<p>然后创建一个Maven仓库。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-4be6bee8028159df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>注意名称必须是maven。类型当然也是Maven。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-4f3fa25e89f5516b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="三、新建项目（以RxBus为例）-1"><a href="#三、新建项目（以RxBus为例）-1" class="headerlink" title="三、新建项目（以RxBus为例）"></a>三、新建项目（以RxBus为例）</h2><p>在Android Studio中New一个Project。完成之后在RxBus的根目录下会有一个build.gradle,在buildscript/dependencies中添加两个classpath：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classpath <span class="string">'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.7.3'</span></span><br><span class="line">classpath <span class="string">'com.github.dcendents:android-maven-gradle-plugin:1.5'</span></span><br></pre></td></tr></table></figure>
<p>这里注意 <strong>版本太旧，会报错</strong>。</p>
<p>这是两个帮助发布项目的插件，完整的project build.gradle请查看<a href="https://github.com/kuwork/rxbus/blob/master/build.gradle#L9L10" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="四、新建模块-1"><a href="#四、新建模块-1" class="headerlink" title="四、新建模块"></a>四、新建模块</h2><p>在当前Project中New一个Module，比如我这里叫rxbus，是一个完整的Android Library，就可以以aar/jar的形式发布了。完成之后在rxbus下也会有一个build.gradle，这个build.gradle是今天的重中之重。</p>
<h2 id="五、构建build-gradle-1"><a href="#五、构建build-gradle-1" class="headerlink" title="五、构建build.gradle"></a>五、构建build.gradle</h2><p>默认的build.gradle大概是这样的：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.library'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">"25.0.2"</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">9</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName version</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</span><br><span class="line">        exclude <span class="string">group:</span> <span class="string">'com.android.support'</span>, <span class="string">module:</span> <span class="string">'support-annotations'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    compile <span class="string">'com.jakewharton.rxrelay2:rxrelay:2.0.0'</span></span><br><span class="line">    provided <span class="string">'io.reactivex.rxjava2:rxjava:2.0.1'</span></span><br><span class="line">    provided <span class="string">'io.reactivex.rxjava2:rxandroid:2.0.1'</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们一步步修改补充这个build.gradle</p>
<ol>
<li><p>添加插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.github.dcendents.android-maven'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.jfrog.bintray'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义版本</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">version = <span class="string">"0.1"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义相关网站<br>有单独的官方网站那是最好的，没用的话就用git网址就可以了。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> siteUrl = <span class="string">'https://github.com/kuwork/rxbus'</span> <span class="comment">// project homepage</span></span><br><span class="line"><span class="keyword">def</span> gitUrl = <span class="string">'https://github.com/kuwork/rxbus.git'</span> <span class="comment">// project git</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义Group<br>举个例子，当我们引用recylerview的时候是这样的：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.android.support:recyclerview-v7:21.0.2'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>引号内字符串以”:”分割为三部分，第一部分就是group，第二部分是name， 第三部分是上面定义的version。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根节点添加group = "com.kw"</span></span><br></pre></td></tr></table></figure></p>
<ol start="5">
<li><p>定义pom并打包aar/jar<br>上传到jcenter至少需要四个文件，除了打包的aar之外，还需要pom和javadoc，source，否则是通不过jcenter审核的。不过不用紧张，这些我们都可以用脚本生成。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">install &#123;</span><br><span class="line">    repositories.mavenInstaller &#123;</span><br><span class="line">        <span class="comment">// This generates POM.xml with proper parameters</span></span><br><span class="line">        pom &#123;</span><br><span class="line">            project &#123;</span><br><span class="line">                packaging <span class="string">'jar'</span></span><br><span class="line">                name <span class="string">'RxBus'</span></span><br><span class="line">                url siteUrl</span><br><span class="line">                licenses &#123;</span><br><span class="line">                    license &#123;</span><br><span class="line">                        name <span class="string">'The Apache Software License, Version 2.0'</span></span><br><span class="line">                        url <span class="string">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                developers &#123;</span><br><span class="line">                    developer &#123;</span><br><span class="line">                        id <span class="string">'rxbus'</span></span><br><span class="line">                        name <span class="string">'com.kw.rxbus'</span></span><br><span class="line">                        email <span class="string">'kuwork@126.com'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                scm &#123;</span><br><span class="line">                    connection gitUrl</span><br><span class="line">                    developerConnection gitUrl</span><br><span class="line">                    url siteUrl</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包javadocjar和sourcejar<br>这两个也是上传到jcenter必须要的。</p>
</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">task sourcesJar(<span class="string">type:</span> Jar) &#123;</span><br><span class="line">    from android.sourceSets.main.java.srcDirs</span><br><span class="line">    classifier = <span class="string">'sources'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task javadoc(<span class="string">type:</span> Javadoc) &#123;</span><br><span class="line">    source = android.sourceSets.main.java.srcDirs</span><br><span class="line">    classpath += project.files(android.getBootClasspath().join(File.pathSeparator))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task javadocJar(<span class="string">type:</span> Jar, <span class="string">dependsOn:</span> javadoc) &#123;</span><br><span class="line">    classifier = <span class="string">'javadoc'</span></span><br><span class="line">    from javadoc.destinationDir</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">artifacts &#123;</span><br><span class="line">    archives javadocJar</span><br><span class="line">    archives sourcesJar</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.上传到Jcenter仓库<br>上传到jcenter的网站BinTray，需要用户验证，需要2个值：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例值， 仅供参考</span></span><br><span class="line">bintray.user=用户名 <span class="comment">// your bintray user </span></span><br><span class="line">namebintray.apikey=******** <span class="comment">// your bintray api key</span></span><br></pre></td></tr></table></figure></p>
<p>第二个API Key就是你在上面记录的API Key。因为这个属于个人隐私，一般不能传到网上去，所以需要在记录到LessCode下的local.properties中(利用gitignore忽略这个文件到git)，然后脚本再从local.properties中读取这两个值。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties()</span><br><span class="line"><span class="keyword">boolean</span> isHasFile = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (project.rootProject.file(<span class="string">'local.properties'</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">    isHasFile = <span class="literal">true</span></span><br><span class="line">    properties.load(project.rootProject.file(<span class="string">'local.properties'</span>).newDataInputStream())</span><br><span class="line">&#125;</span><br><span class="line">bintray &#123;</span><br><span class="line">    user = isHasFile ? properties.getProperty("bintray.user") : System.getenv(<span class="string">"bintray.user"</span>)</span><br><span class="line">    key = isHasFile ? properties.getProperty("bintray.apikey") : System.getenv(<span class="string">"bintray.apikey"</span>)</span><br><span class="line">    configurations = [<span class="string">'archives'</span>]</span><br><span class="line">    pkg &#123;</span><br><span class="line">        repo = <span class="string">"maven"</span></span><br><span class="line">        name = <span class="string">"rxbus"</span> <span class="comment">//项目名称</span></span><br><span class="line">        websiteUrl = siteUrl</span><br><span class="line">        vcsUrl = gitUrl</span><br><span class="line">        licenses = [<span class="string">"Apache-2.0"</span>]</span><br><span class="line">        publish = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整的build.gradle,请参考<a href="https://github.com/kuwork/rxbus/blob/master/rxbus/build.gradle" target="_blank" rel="noopener">rxbus/build.gradle</a>。</p>
<p>8.执行<br>根据上面的build.gradle,会产生几个特别的gradle任务：<br>通过gradlew执行这些任务即可。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gradlew javadocJar</span><br><span class="line">gradlew sourcesJar</span><br><span class="line">gradlew install</span><br><span class="line">gradlew bintrayUpload</span><br></pre></td></tr></table></figure></p>
<p><strong> PS </strong></p>
<ul>
<li>如果上传的版本号一样，在执行gradlew bintrayUpload时失败</li>
</ul>
<p>或者通过Android Studio的最右边栏的Gradle窗口分别可视化操作，点击执行：<img src="http://upload-images.jianshu.io/upload_images/3020228-ad3f1489a142efa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>9.请求审核<br>当bintrayUpload成功之后，<br>在我的主页<strong><a href="https://bintray.com/你的用户名/maven" target="_blank" rel="noopener">https://bintray.com/你的用户名/maven</a></strong> 会看到你提交了一个项目：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-d6456765a5b70002.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>点击项目名称，进入详情页，右下角找到<br><img src="http://upload-images.jianshu.io/upload_images/3020228-1559f9a41f5d4ae0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>鼠标放上去它会提示你去提交审核，点击进入后，随便写什么都可以了。<br>只要上面没问题，一般审核很快，几个小时就差不多了。</p>
<p><strong>PS</strong></p>
<ul>
<li>如果你开始像我一样没注意就注册了一个企业账号。那样就看不到这个按钮了。</li>
<li>即使看到按钮也未必能跳转（一开始我使用bintray-release，可以上传成功，无法提交Jcenter，点击会出现POM.xml缺失提示）。</li>
</ul>
<p>小结<br>相对于android源码或者jar包的形式，开发者可能更乐意以这种方式开源自己的android框架或者组件。<br>对于使用者来说，引用方式更简单了<br>对于开发者开说，能够被中心仓库接受，是一种认可。</p>
<p>更多参考，请查看<a href="https://github.com/kuwork/rxbus" target="_blank" rel="noopener">基于Rxjava2+RxDelay 的RxBus</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/18/基于-RxJava-2-和-RxRelay-实现-RxBus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/18/基于-RxJava-2-和-RxRelay-实现-RxBus/" itemprop="url">
                  基于 RxJava 2 和 RxRelay 实现 RxBus
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T17:35:00+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-6bb6ca40c2f27039.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>相信大家都对EventBus这个很热门的工具很熟悉了，最近更新开发新框架的缘故，接触到Retrofit 2 和 RxJava 2 ，自然而然地使用RxBus来代替EventBus。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-1f5797262a5f9dda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RxJava"></p>
<h1 id="一辆有意思的BUS"><a href="#一辆有意思的BUS" class="headerlink" title="一辆有意思的BUS"></a>一辆有意思的BUS</h1><p>“Bus”这个词其实很形象的说明总线这个概念。那什么是总线？</p>
<p>总线是系统传送信息的公共通信干线，各个部件在总线上传递消息。RxBus实现了一种事件总线，一条公共的通信通道，上面跑着各种信息，Android中的各个组件或是控件都可以向它发送各种信息，在各个组件或控件中只要订阅这条总线，每当总线收到消息的时候，这些订阅者同样就能收到这些消息。</p>
<h1 id="RxBus-最基本的实现"><a href="#RxBus-最基本的实现" class="headerlink" title="RxBus 最基本的实现"></a>RxBus 最基本的实现</h1><p>支持注解方式订阅事件。 支持粘滞事件。 支持3种Bus: Publish Bus( RxBus，参见 <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/PublishSubject.html" target="_blank" rel="noopener">PublishSubject</a> ) Behavior Bus(参见 <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/BehaviorSubject.html" target="_blank" rel="noopener">BehaviorSubject</a>) Replay Bus(参见<a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/ReplaySubject.html" target="_blank" rel="noopener">ReplaySubject</a>)</p>
<p>这三种都是基于Subject类，它负责在非Rx-Apis之间充当桥梁。但是也存在问题。他没有能力去处理onComplete 或 onError事件.如果在下游发生onError / onComplete ，上游将受到影响。</p>
<h1 id="ReRelay开源项目"><a href="#ReRelay开源项目" class="headerlink" title="ReRelay开源项目"></a><a href="https://github.com/JakeWharton/RxRelay" target="_blank" rel="noopener">ReRelay</a>开源项目</h1><p><a href="https://github.com/JakeWharton" target="_blank" rel="noopener">JakeWharton</a> 大神已经帮你们处理好这些问题。</p>
<p>Relays 是既是Observable也是Consumer的<a href="https://github.com/ReactiveX/RxJava/" target="_blank" rel="noopener">RxJava</a> 类型，它同样能够很容易在non-Rx api和 Rx api之间搭起桥梁,而不必要担心下游的触发的终止状态（onComplete 或 onError）。</p>
<h1 id="RxBus-下载使用"><a href="#RxBus-下载使用" class="headerlink" title="RxBus 下载使用"></a>RxBus 下载使用</h1><p>Maven:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kw<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rxbus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Gradle:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.kw:rxbus:1.0.1'</span></span><br></pre></td></tr></table></figure>
<p>这个库 并不含有 RxAndroid 和 RxJava ，请自行添加</p>
<h1 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h1><h2 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RxBus.getInstance().send(<span class="keyword">new</span> UserEvent(<span class="number">1</span>,<span class="string">"名字"</span>));</span><br></pre></td></tr></table></figure>
<h2 id="接受事件"><a href="#接受事件" class="headerlink" title="接受事件"></a>接受事件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册</span></span><br><span class="line">disposable = RxBus.getInstance().register(UserEvent.class, AndroidSchedulers.mainThread(), <span class="keyword">new</span> Consumer&lt;UserEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(UserEvent userEvent)</span> </span>&#123;</span><br><span class="line">                btnNext.setText(userEvent.getName());</span><br><span class="line">                Toast.makeText(getBaseContext(), userEvent.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">                Log.d(<span class="string">"AActivity"</span>, <span class="string">"onNext:"</span> + Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"空指针错误"</span>);<span class="comment">//发生错误之后，会取消订阅</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> Consumer&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//发生错误后仅仅会进入一次，因为发生错误之后，会取消订阅</span></span><br><span class="line">                Toast.makeText(getBaseContext(), throwable.getMessage(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//上下两段代码具有相同意义</span></span><br><span class="line">disposable=RxBus.getInstance().toObservable(UserEvent.class)</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;UserEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(UserEvent userEvent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                btnNext.setText(userEvent.getName());</span><br><span class="line">                Toast.makeText(getBaseContext(),userEvent.toString(),Toast.LENGTH_SHORT).show();</span><br><span class="line">                Log.d(<span class="string">"AActivity"</span>,<span class="string">"onNext:"</span>+Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"空指针错误"</span>);<span class="comment">//发生错误之后，会取消订阅</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">new</span> Consumer&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//发生错误后仅仅会进入一次，因为发生错误之后，会取消订阅</span></span><br><span class="line">                Toast.makeText(getBaseContext(),throwable.getMessage(),Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//解除</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    RxBus.getInstance().unregister(disposable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Relay&lt;Object&gt; bus = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RxBus instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//禁用构造方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bus = PublishRelay.create().toSerialized();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxBus <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RxBus.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> RxBus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        bus.accept(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">toObservable</span><span class="params">(Class&lt;T&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus.ofType(eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用时，需要你定义一些事件类型，例如上面的UserEvent，该类型只会传递给订阅该类型的观察者。这主要归功于ofType操作符。</p>
<p>这里仅仅实现了广播事件，基于ReRelay还可以实现其他方式。</p>
<p>如果有什么不理解的，请浏览<a href="https://github.com/kuwork/rxbus" target="_blank" rel="noopener">基于Rxjava2+RxRelay 的RxBus</a>源码。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/07/酷狗-Android-App-插件化实施过程(转载)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/07/酷狗-Android-App-插件化实施过程(转载)/" itemprop="url">
                  酷狗Android App插件化实施过程(转载)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-07T12:04:00+08:00">
                2017-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.diycode.cc/topics/442" target="_blank" rel="noopener">原文在此</a></p>
<h2 id="什么是插件化框架"><a href="#什么是插件化框架" class="headerlink" title="什么是插件化框架"></a>什么是插件化框架</h2><p>插件化框架可以在主程序不重新安装的情况下，针对单个业务模块进行加载达到模块更新的目的，整个加载更新过程，对用户来说也是无感知的。<br>正式因为这样，新需求比起传统更新方式覆盖率和覆盖速度都会更高和更快，对于大型开发团队，各个业务模块开发小组组也不需要再等所有组的需求开发完统一发布版本，发版本可以单独针对小组内单个功能发布了，有了这些优点才使得这1年来插件化框架如此流行的重要原因。</p>
<h2 id="目前网上流行的主流的插件化技术核心主要分两类："><a href="#目前网上流行的主流的插件化技术核心主要分两类：" class="headerlink" title="目前网上流行的主流的插件化技术核心主要分两类："></a>目前网上流行的主流的插件化技术核心主要分两类：</h2><p>一类是360公司开源的DroidPlugin，特点在宿主程序上打造一个纯粹的环境，可以让一个个普通apk（插件）不安装就可以正常使用，并且插件之前资源和代码都是相互独立互相不干扰也不能访问，为了达到这样的目的，框架hook了大量的系统api。<br>另一类是从dynamic-load-apk 开始，通过反射少量api，达到插件代码和资源与宿主合并，达到相互调用的结果，目前大部分都是框架从底层代码合并和资源合并用的手法都差不多，只是各个框架在这基础上对插件化的理解不一样，为各自的项目做了不少的业务封装。</p>
<h2 id="常用的类加载方法是："><a href="#常用的类加载方法是：" class="headerlink" title="常用的类加载方法是："></a>常用的类加载方法是：</h2><p><img src="http://upload-images.jianshu.io/upload_images/3020228-790cb15023b056f7.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="常见的资源加载方式是："><a href="#常见的资源加载方式是：" class="headerlink" title="常见的资源加载方式是："></a>常见的资源加载方式是：</h2><p><img src="http://upload-images.jianshu.io/upload_images/3020228-345422740186f2fc.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>目前看来怎么加载代码，怎么加载资源、怎么动态声明和启动android组件。网上大部分开源的开源框架都很好的解决了这些怎么实现的问题，很完美的做到了从0到1。但是对于一个有几十个开发人员千万级别的大型的app来说，单解决了这些问题还是不够的。插件框架的稳定性、从原有代码到插件化的迁移成本、后期维护成本等等方面都需要考虑到。<br>所以兼容性、迁移成本、后期维护成本是我们在插件化选型时最基本的考虑因素。<br>首先兼容性、后期维护成本，大家都了解到由于android系统的碎片化，android官方提供的api也存在着不少的兼容性问题，况且针对创新能力如此强大的国内手机厂商，国产手机也额外的多了不少兼容性问题。<br>具体例子：常用到的资源加载方式，放在vivo的部分手机就不能使用原因是其ROM把系统的Resources封装成为了VivoResources直接导致了反射失败插件资源无法加载，同样的Nubia的部分手机也是。所以基于这样在做插件化的时候hook系统的api就应该尽量的少，因为hook的api不确定性太多了，而且在这部分的开发过程肯定不会有任何文档提供参考的，遇到问题就干撸代码吧。<br>处理兼容性的工作量越大其实后期的维护成本就越高，至少如果android一个新版本出来了首先要看的是之前hook的官方api有没有被改掉。如果有问题还要再针对新的版本寻求新的实现，这部分工作量是非常大的。这也是我们不选择DroidPlugin的重要原因，从网上的能找到的所有资料并没有看到DroidPlugin的兼容性能达到多少能适配多少台手机。但是预判一下DroidPlugin hook了大量的api比起其他框架hook两个，这部分后续维护成本也是足够喝一壶的。<br>迁移成本，其实很多大型的项目实现插件化，在这个调整的过程中对代码结构，调用逻辑等等的修改肯定是有的。怎么保证这个改动是最少的，也是我们的考虑之一毕竟有改动就会产生bug,比较幸运的是，我们从打包脚本上下手在保证传统的项目结构和逻辑调用不改变的情况下实现模块插件化。让插件化先跑起来，在实现之后再让各个业务小组针对插件化的建议慢慢的完善和封装插件和宿主之间的协议和约定。</p>
<h2 id="插件化迁移过程："><a href="#插件化迁移过程：" class="headerlink" title="插件化迁移过程："></a>插件化迁移过程：</h2><p>首先，看看我们酷狗原有的基础项目结构：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-626c18cb11b7bb78.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>项目底层是一个公用library 提供大部分的公共的基础模块，酷狗作为application作为主程序，其他听看唱其他业务模块也作为一个个library,各个业务组关联公共模块和酷狗主程序，在各自的业务模块下开发、调试。当发版本的时候就统一在打包平台上让酷狗关联所有业务模块 然后统一打包，这是最常见的项目组成架构业务模块有项目级别的代码分离而且业务项目依赖公共基础库。<br>项目优化目标</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-e0433d10b851a6f1.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>优化后，业务组之前的开发方式完全不变，项目结构对比优化前完整保留，打包之后每个业务模块是一个个插件可以单独加载运行，每个插件都是只包含插件自己的资源和代码（不包含公共库），插件可以正常访问宿主的资源和代码，只要宿主保留了插件所需的资源和代码，无论宿主怎么改变都可以启动插件。<br>在这个过程中主要需要解决的问题有：<br>打包插件只保留插件本身的代码，打包后插件不改变任何调用逻辑能顺利调用回宿主逻辑。<br>决插件和宿主资源冲突问题，插件只保留本身资源，插件能访问到宿主资源。<br>重新编译之后怎么保证旧的宿主能支持新的插件。</p>
<p>首先怎么把原来跟底层项目依赖的业务模块 单独打成一个插件包 只保留业务模块的代码<br><img src="http://upload-images.jianshu.io/upload_images/3020228-4b738046f6eedc7f.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>我们拿听模块做个例子先编译宿主程序也就是酷狗项目和底层基础库，一直编译完javac这时候主项目资源R.java和映射表都可以得到，然后把编译出来的class打包成common.jar把common项目资源复制到一个空壳项目commonres。<br>接着修改听项目的属性把它从一个library变成一个application，关联让它不直接关联基础库，而是让它关联 commonn.jar 和 commonres，其中common.jar做提供编译。<br>按照这样编译下去，听项目编译出来的apk就只包含自己的代码了。<br>接下来解决资源问题,正常的资源查找方式</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-fc2a1c38bb3dc1bb.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>应用层获取资源 是用资源id直接去获取，Resources先根据我们的id去资源映射表去查找这个资源的名称是，拿到资源名称不对应文件的资源只需要执行从资源ID到资源名称的转换即可，而对应有文件的资源还需要根据资源名称来打开对应的文件。经过反射 resources 里面包含了多个映射表的目录，查找的时候会按照顺序先查宿主再查各个插件的映射表。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-15677b21b89a4889.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>资源冲突问题因为上面项目结构调整之后，插件和宿主都是application编译时候就会出资源id相同，插件做资源id查找的时候就会有可能查找到宿主的资源，所以只要修改了resources.arsc和代码层用到的R.java的id就可以解决冲突了常见的修改方式是修改插件的id的pp段。</p>
<p>程序编译到这里，修改关联后的插件项目还保留了一份commonres资源，跟宿主的程序上的是一摸一样的，能不能修改资源id来解决呢，答案是肯定的,因为插件和宿主查找资源的逻辑是一样的，只要插件代码调用中相同的资源id即R.java里面的id,修改为宿主资源id，资源查找的时候就会顺利的到宿主的resources.arsc去查找资源了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-51ffa658bb030a4b.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>最后，删除插件resources.arsc多余的资源id和插件多余的资源文件。这样下来 最终得出的插件包 就是只含有插件代码和插件资源的 而且还能随意访问宿主资源和代码。<br>最后我们看看整体的编译流程。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-6f119a0b55fd5051.png!web?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><strong>与微信资源混淆工具的兼容性问题</strong><br>插件化工具主要在编译时修改ID和去除其他多余资源，资源混淆工具主要是把名称和路径改短不修改ID，所以并不冲突。<br>只要保证读写操作都是严格按照 resources.arsc 的格式去写就可以了。<br>接下来最后一个问题,重新编译之后怎么保证旧的宿主能支持新的插件,简单说就是多程序怎么一起 做代码混淆,怎么保持宿主的资源ID。</p>
<p><strong> 多项目一起混淆：</strong></p>
<p>我们选择的是统一做混淆，为什么不能先混淆整体混淆一个项目然后再混淆第二个项目的时候保持用上个项目的mapping 继续混淆,一直这样编译下去？<br>主要因为插件和宿主公共库之间并没有固定接口，单独混淆原来直接关联调用的方法就会被混淆移除掉。<br>我们还记得插件模块和common基础模块本来就是直接关联、直接调用的，后面我们改变项目结构让插件独立出来了，但是这部分调用还是存在的。<br>一旦单独混淆他们之间关联的代码就会被移除掉，宿主公共库的final静态变量混淆后也会消失，插件也没法调用得到。<br>其实正常来说，宿主和插件之间的调用本来就是需要先有固定的接口做好解耦 规范好所有的调用，宿主提供一套完整的api给插件使用，然后混淆的时候 keep好各自边界 。 这样对于后续插件版本更新和管理才是最正确的。<br>为什么这个问题到现在才聊呢，因为让各个业务模块组为了插件化然后去封装接口，等他们解耦封装好才来做的话时间太长了，所以我们先用这种方式让他们不需要做任何封装和解耦就能用，后续再要求他们慢慢的规范好这部分的接口。</p>
<p><strong> 怎么keep资源问题</strong></p>
<p>我们知道资源id的生成是按照资源名称随机生成的，一旦添加或者修改了某个资源名称所有的资源id都有可能改变。 如果不能固定资源id 每次编译都id都变的话插件也无法下发给用户使用。<br>解决方案是在编译的时候根据宿主R.java的生成ids.xml和public.xml下次编译把ids.xml和public.xml放到宿主的/res/value目录下编译可保持id不变，这样即使下次宿主的其他资源改变了，只要插件用到的所有资源没有改变，新打出来的插件 一样是可以给旧的宿主使用的。<br>到这里一个完成的插件包已经出来了，剩下的就是 按照基本的加载方式，把这个插件加载进去就顺利完成了。</p>
<p><strong>最后在宿主实现插件管理功能，这部分纯粹就是基本的业务逻辑了。</strong></p>
<ol>
<li>下载校验插件差异包。 （我们生成新的插件包上次到服务器，服务器就会与原始插件做差异对比，然后生成文件级别的差异文件，下发给用户）</li>
<li>合并差异包对比插件版本号。</li>
<li>加载前黑名单和白名单检验。（某些插件版本必须强制加载，某些强制不能加载）</li>
<li>启动时加载插件资源映射表。（保证一启动就可以查询到所以资源，而且这个反射效率很高，不耗时，也不耗内存速度也很快）。</li>
<li>插件代码选择合适时机懒加载。 （因为加载dex的时候，需要耗时，5.0以下做opt,5.0以上做oat,而且时间还不短，所以需要挑合适的时机做懒加载。）</li>
</ol>
<p>最后，本文主要是我们在插件化过程中遇到一些问题的解决方案，其实每个解决方案都会有各自的取舍，也无谁优谁劣，如有更好的方案欢迎下面留言交流。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/04/Android-Small-源码分析(二)-插件加载过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/04/Android-Small-源码分析(二)-插件加载过程/" itemprop="url">
                  Android Small 源码分析(二) 插件加载过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-04T20:01:00+08:00">
                2017-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://upload-images.jianshu.io/upload_images/3020228-169bce07d656247a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></h2><p>这一节我们要继续接着上一节的内容，来讲讲插件的加载过程。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-f0f22004632a5c15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt=""></p>
<h1 id="二-插件加载过程：从Bundle-步入-BundleLauncher"><a href="#二-插件加载过程：从Bundle-步入-BundleLauncher" class="headerlink" title="二. 插件加载过程：从Bundle 步入 BundleLauncher"></a>二. 插件加载过程：从Bundle 步入 BundleLauncher</h1><p>　　上一节我们读到loadBundle中，里面涉及一个方法prepareForLaunch，我没有继续往下详解，搬来这里继续给大家做个介绍。</p>
<h2 id="1-步入BundleLauncher的-loadBundle的前期准备。"><a href="#1-步入BundleLauncher的-loadBundle的前期准备。" class="headerlink" title="(1)步入BundleLauncher的 loadBundle的前期准备。"></a>(1)步入BundleLauncher的 loadBundle的前期准备。</h2> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadBundles</span><span class="params">(List&lt;Bundle&gt; bundles)</span> </span>&#123;</span><br><span class="line">        sPreloadBundles = bundles;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare bundle</span></span><br><span class="line">        <span class="keyword">for</span> (Bundle bundle : bundles) &#123;</span><br><span class="line">            bundle.prepareForLaunch();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareForLaunch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mIntent != <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mApplicableLauncher == <span class="keyword">null</span> &amp;&amp; sBundleLaunchers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (BundleLauncher launcher : sBundleLaunchers) &#123;</span><br><span class="line">                <span class="keyword">if</span> (launcher.resolveBundle(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                    mApplicableLauncher = launcher;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　sBundleLaunchers这个变量已经很熟悉，在前面已经多次出现了,我们来回忆一下。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-0a210bfa61589540.png?watermark/1/image/aHR0cDovL29od2NrdWpzdS5ia3QuY2xvdWRkbi5jb20vJUU1JUE0JUI0JUU1JTgzJThGJUU2JUIwJUI0JUU1JThEJUIwLnBuZw==/gravity/NorthEast/imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br>　　里面只有三个类ApkBundleLauncher、ActivityLauncher、WebBundleLauncher，前面已经作了部分解释，从上图可知。三者的祖先都是BundleLauncher，resolveBundle方法定义在此处。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when loading bundles by &#123;<span class="doctag">@link</span> Bundle#loadLaunchableBundles(Small.OnCompleteListener)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method try to preload a bundle, if succeed, load it later.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bundle the loading bundle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;tt&gt;true&lt;/tt&gt; if the &lt;tt&gt;bundle&lt;/tt&gt; is resolved</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolveBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!preloadBundle(bundle)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        loadBundle(bundle);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　这里会继续调用preloadBundle的方法来判断，然后我发现preloadBundle在ActivityLauncher和SoBundleLauncher(直接影响ApkBundleLauncher、WebBundleLauncher)中重载了。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-7810dfd0f2c6f929.png?watermark/1/image/aHR0cDovL29od2NrdWpzdS5ia3QuY2xvdWRkbi5jb20vJUU1JUE0JUI0JUU1JTgzJThGJUU2JUIwJUI0JUU1JThEJUIwLnBuZw==/gravity/SouthEast/imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p>
<p>1.ActivityLauncher的preloadBundle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preloadBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (sActivityClasses == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">       String pkg = bundle.getPackageName();</span><br><span class="line">       <span class="keyword">return</span> (pkg == <span class="keyword">null</span> || pkg.equals(<span class="string">"main"</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>　　sActivityClasses是在ActivityLauncher setUp被填充的，它里面有宿主已经注册好的Activity。sActivityClasses一般不会为null，因此都进入判断pkg地方，pkg即包路径，因此preloadBundle会返回false，resolveBundle也会返回false，导致ActivityLauncher会被略过。<br>　　ActivityLauncher 它的作用是启动宿主的Activity。如果bundle.json里pkg为空或者pkg为”main”的bundle，ActivityLauncher也不做特殊处理，因为loadBundle在ActivityLauncher中不被重载，仍为空方法。当启动的时候，把bundle里的uri当作Activity的类名。URI转换为Activity的名字规则如下：如果URI是空的，默认是MainActivity，否则使用URI,如果类不存在，加“Activity”后缀再进行查找。</p>
<p>2.SoBundleLauncher的preloadBundle<br>　　<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preloadBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        String packageName = bundle.getPackageName();</span><br><span class="line">        <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if supporting</span></span><br><span class="line">        String[] types = getSupportingTypes();</span><br><span class="line">        <span class="keyword">if</span> (types == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> supporting = <span class="keyword">false</span>;</span><br><span class="line">        String bundleType = bundle.getType();</span><br><span class="line">        <span class="keyword">if</span> (bundleType != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">//这里为了解除对先前版本对包名的限制(*.lib.*或者*.app.*)，如果在bundle.json声明type属性为“lib”或者“app”,将忽略包名限制</span></span><br><span class="line">            <span class="comment">// Consider user-defined type in `bundle.json'</span></span><br><span class="line">            <span class="keyword">for</span> (String type : types) &#123;</span><br><span class="line">                <span class="keyword">if</span> (type.equals(bundleType)) &#123;</span><br><span class="line">                    supporting = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Consider explicit type specify in package name as following:</span></span><br><span class="line">            <span class="comment">//  - com.example.[type].any</span></span><br><span class="line">            <span class="comment">//  - com.example.[type]any</span></span><br><span class="line">            String[] pkgs = packageName.split(<span class="string">"\\."</span>);</span><br><span class="line">            <span class="keyword">int</span> N = pkgs.length;</span><br><span class="line">            String aloneType = N &gt; <span class="number">1</span> ? pkgs[N - <span class="number">2</span>] : <span class="keyword">null</span>;</span><br><span class="line">            String lastComponent = pkgs[N - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">for</span> (String type : types) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((aloneType != <span class="keyword">null</span> &amp;&amp; aloneType.equals(type))</span><br><span class="line">                        || lastComponent.startsWith(type)) &#123;</span><br><span class="line">                    supporting = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!supporting) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize the extract path</span></span><br><span class="line">        File extractPath = getExtractPath(bundle);<span class="comment">//重载在ApkBundleLauncher和WebBundleLauncher中，定义不同的路径。</span></span><br><span class="line">        <span class="keyword">if</span> (extractPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!extractPath.exists()) &#123;</span><br><span class="line">                extractPath.mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">            bundle.setExtractPath(extractPath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//至此，存储的目录准备好了</span></span><br><span class="line">        <span class="comment">// Select the bundle entry-point, `built-in' or `patch'</span></span><br><span class="line">        File plugin = bundle.getBuiltinFile();</span><br><span class="line">        BundleParser parser = BundleParser.parsePackage(plugin, packageName);</span><br><span class="line">        File patch = bundle.getPatchFile();</span><br><span class="line">        BundleParser patchParser = BundleParser.parsePackage(patch, packageName);</span><br><span class="line">        <span class="keyword">if</span> (parser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (patchParser == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parser = patchParser; <span class="comment">// use patch</span></span><br><span class="line">                plugin = patch;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (patchParser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (patchParser.getPackageInfo().versionCode &lt;= parser.getPackageInfo().versionCode) &#123;</span><br><span class="line">                <span class="comment">//排除补丁版本号过低</span></span><br><span class="line">                Log.d(TAG, <span class="string">"Patch file should be later than built-in!"</span>);</span><br><span class="line">                patch.delete();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parser = patchParser; <span class="comment">// use patch</span></span><br><span class="line">                plugin = patch;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bundle.setParser(parser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if the plugin has not been modified</span></span><br><span class="line">        <span class="keyword">long</span> lastModified = plugin.lastModified();</span><br><span class="line">        <span class="keyword">long</span> savedLastModified = Small.getBundleLastModified(packageName);</span><br><span class="line">        <span class="keyword">if</span> (savedLastModified != lastModified) &#123;<span class="comment">//文件已被修改</span></span><br><span class="line">            <span class="comment">// If modified, verify (and extract) each file entry for the bundle</span></span><br><span class="line">            <span class="keyword">if</span> (!parser.verifyAndExtract(bundle, <span class="keyword">this</span>)) &#123;<span class="comment">//校验CRC、签名等，通过安排解压IO事项</span></span><br><span class="line">                bundle.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// Got it, but disabled</span></span><br><span class="line">            &#125;</span><br><span class="line">            Small.setBundleLastModified(packageName, lastModified);<span class="comment">//标记最后修改时间</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Record version code for upgrade</span></span><br><span class="line">        PackageInfo pluginInfo = parser.getPackageInfo();</span><br><span class="line">        bundle.setVersionCode(pluginInfo.versionCode);</span><br><span class="line">        bundle.setVersionName(pluginInfo.versionName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　BundleParser 是一个精简版的<a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/pm/PackageParser.java" target="_blank" rel="noopener">PackageParser.java</a>，用来解析AndroidManifest文件,获取package.versionCode，package.versionName，package.theme，activities，同时也会收集每个Activity对应的intent-filter。 这个类里还定义了一个内部类R，R文件里包含一个styleable类，此文件定义了平台公共资源ID，例如版本号id，版本名称id，主题Id等。</p>
<h2 id="2-步入BundleLauncher的-loadBundle"><a href="#2-步入BundleLauncher的-loadBundle" class="headerlink" title="(2)步入BundleLauncher的 loadBundle"></a>(2)步入BundleLauncher的 loadBundle</h2><p>　　这里loadBundle方法在SoBundleLauncher子类(ApkBundleLauncher、AssetBundleLauncher)中被重载，先挑一个简短的看看，也就是AssetBundleLauncher的loadBundle。</p>
<ol>
<li>AssetBundleLauncher的loadBundle<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">       String packageName = bundle.getPackageName();</span><br><span class="line">       File unzipDir = <span class="keyword">new</span> File(getBasePath(), packageName);</span><br><span class="line">       File indexFile = <span class="keyword">new</span> File(unzipDir, getIndexFileName());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Prepare index url</span></span><br><span class="line">       String uri = indexFile.toURI().toString();</span><br><span class="line">       <span class="keyword">if</span> (bundle.getQuery() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           uri += <span class="string">"?"</span> + bundle.getQuery();</span><br><span class="line">       &#125;</span><br><span class="line">       URL url;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           url = <span class="keyword">new</span> URL(uri);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">           Log.e(TAG, <span class="string">"Failed to parse url "</span> + uri + <span class="string">" for bundle "</span> + packageName);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       String scheme = url.getProtocol();</span><br><span class="line">       <span class="keyword">if</span> (!scheme.equals(<span class="string">"http"</span>) &amp;&amp;</span><br><span class="line">               !scheme.equals(<span class="string">"https"</span>) &amp;&amp;</span><br><span class="line">               !scheme.equals(<span class="string">"file"</span>)) &#123;</span><br><span class="line">           Log.e(TAG, <span class="string">"Unsupported scheme "</span> + scheme + <span class="string">" for bundle "</span> + packageName);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       bundle.setURL(url);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>　　这个过程主要是尝试将默认的index.html 转换成URL对象。</p>
<ol start="2">
<li>ApkBundleLauncher的loadBundle<br>　　这里主要是通过BundleParser解释AndroidManifest.xml，收集其中的activities，初始化LoadedApk的一些信息，加载Dex文件以及lib库。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">    String packageName = bundle.getPackageName();</span><br><span class="line"></span><br><span class="line">    BundleParser parser = bundle.getParser();</span><br><span class="line">    parser.collectActivities();</span><br><span class="line">    PackageInfo pluginInfo = parser.getPackageInfo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the bundle</span></span><br><span class="line">    String apkPath = parser.getSourcePath();</span><br><span class="line">    <span class="keyword">if</span> (sLoadedApks == <span class="keyword">null</span>) sLoadedApks = <span class="keyword">new</span> ConcurrentHashMap&lt;String, LoadedApk&gt;();</span><br><span class="line">    LoadedApk apk = sLoadedApks.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (apk == <span class="keyword">null</span>) &#123;</span><br><span class="line">        apk = <span class="keyword">new</span> LoadedApk();</span><br><span class="line">        apk.packageName = packageName;</span><br><span class="line">        apk.path = apkPath;</span><br><span class="line">        apk.nonResources = parser.isNonResources();</span><br><span class="line">        <span class="keyword">if</span> (pluginInfo.applicationInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            apk.applicationName = pluginInfo.applicationInfo.className;</span><br><span class="line">        &#125;</span><br><span class="line">        apk.packagePath = bundle.getExtractPath();</span><br><span class="line">        apk.optDexFile = <span class="keyword">new</span> File(apk.packagePath, FILE_DEX);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load dex</span></span><br><span class="line">        <span class="keyword">final</span> LoadedApk fApk = apk;</span><br><span class="line">        Bundle.postIO(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fApk.dexFile = DexFile.loadDex(fApk.path, fApk.optDexFile.getPath(), <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Extract native libraries with specify ABI</span></span><br><span class="line">        String libDir = parser.getLibraryDirectory();</span><br><span class="line">        <span class="keyword">if</span> (libDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            apk.libraryPath = <span class="keyword">new</span> File(apk.packagePath, libDir);</span><br><span class="line">        &#125;</span><br><span class="line">        sLoadedApks.put(packageName, apk);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pluginInfo.activities == <span class="keyword">null</span>) &#123;</span><br><span class="line">        bundle.setLaunchable(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record activities for intent redirection</span></span><br><span class="line">    <span class="keyword">if</span> (sLoadedActivities == <span class="keyword">null</span>) sLoadedActivities = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ActivityInfo&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ActivityInfo ai : pluginInfo.activities) &#123;</span><br><span class="line">        sLoadedActivities.put(ai.name, ai);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record intent-filters for implicit action</span></span><br><span class="line">    ConcurrentHashMap&lt;String, List&lt;IntentFilter&gt;&gt; filters = parser.getIntentFilters();</span><br><span class="line">    <span class="keyword">if</span> (filters != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sLoadedIntentFilters == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sLoadedIntentFilters = <span class="keyword">new</span> ConcurrentHashMap&lt;String, List&lt;IntentFilter&gt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        sLoadedIntentFilters.putAll(filters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set entrance activity</span></span><br><span class="line">    bundle.setEntrance(parser.getDefaultActivityName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　使用sLoadedActivities记录插件中的activities来实现Intent重定向，使用sLoadedIntentFilters记录intent-filters来实现隐式调用。</p>
<h2 id="3-重新回到Bundle-loadBundles，分发到各个launcher-postSetUp"><a href="#3-重新回到Bundle-loadBundles，分发到各个launcher-postSetUp" class="headerlink" title="(3)重新回到Bundle.loadBundles，分发到各个launcher postSetUp()"></a>(3)重新回到Bundle.loadBundles，分发到各个launcher postSetUp()</h2><p>　　postSetUp前后都等待WebView 初始化完成，避免WebView asset路径影响。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadBundles</span><span class="params">(List&lt;Bundle&gt; bundles)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Wait for the things to be done on UI thread before `postSetUp`,</span></span><br><span class="line">        <span class="comment">// as on 7.0+ we should wait a WebView been initialized. (#347)</span></span><br><span class="line">        <span class="keyword">while</span> (sRunningUIActionCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BundleLauncher launcher : sBundleLaunchers) &#123;</span><br><span class="line">            launcher.postSetUp();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait for the things to be done on UI thread before `postSetUp`,</span></span><br><span class="line">        <span class="comment">// as on 7.0+ we should wait a WebView been initialized. (#347)</span></span><br><span class="line">        <span class="keyword">while</span> (sRunningUIActionCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　有效的postSetUp仅存与ApkBundleLauncher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSetUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.postSetUp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sLoadedApks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Could not find any APK bundles!"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collection&lt;LoadedApk&gt; apks = sLoadedApks.values();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Merge all the resources in bundles and replace the host one</span></span><br><span class="line">        <span class="keyword">final</span> Application app = Small.getContext();</span><br><span class="line">        String[] paths = <span class="keyword">new</span> String[apks.size() + <span class="number">1</span>];</span><br><span class="line">        paths[<span class="number">0</span>] = app.getPackageResourcePath(); <span class="comment">// add host asset path</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (LoadedApk apk : apks) &#123;</span><br><span class="line">            <span class="keyword">if</span> (apk.nonResources) <span class="keyword">continue</span>; <span class="comment">// ignores the empty entry to fix #62</span></span><br><span class="line">            paths[i++] = apk.path; <span class="comment">// add plugin asset path</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i != paths.length) &#123;</span><br><span class="line">            paths = Arrays.copyOf(paths, i);</span><br><span class="line">        &#125;</span><br><span class="line">        ReflectAccelerator.mergeResources(app, sActivityThread, paths);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Merge all the dex into host's class loader</span></span><br><span class="line">        ClassLoader cl = app.getClassLoader();</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> N = apks.size();</span><br><span class="line">        String[] dexPaths = <span class="keyword">new</span> String[N];</span><br><span class="line">        DexFile[] dexFiles = <span class="keyword">new</span> DexFile[N];</span><br><span class="line">        <span class="keyword">for</span> (LoadedApk apk : apks) &#123;</span><br><span class="line">            dexPaths[i] = apk.path;</span><br><span class="line">            dexFiles[i] = apk.dexFile;</span><br><span class="line">            <span class="keyword">if</span> (Small.getBundleUpgraded(apk.packageName)) &#123;</span><br><span class="line">                <span class="comment">// If upgraded, delete the opt dex file for recreating</span></span><br><span class="line">                <span class="keyword">if</span> (apk.optDexFile.exists()) apk.optDexFile.delete();</span><br><span class="line">                Small.setBundleUpgraded(apk.packageName, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        ReflectAccelerator.expandDexPathList(cl, dexPaths, dexFiles);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expand the native library directories for host class loader if plugin has any JNIs. (#79)</span></span><br><span class="line">        List&lt;File&gt; libPathList = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">        <span class="keyword">for</span> (LoadedApk apk : apks) &#123;</span><br><span class="line">            <span class="keyword">if</span> (apk.libraryPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                libPathList.add(apk.libraryPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (libPathList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ReflectAccelerator.expandNativeLibraryDirectories(cl, libPathList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Trigger all the bundle application `onCreate' event</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> LoadedApk apk : apks) &#123;</span><br><span class="line">            String bundleApplicationName = apk.applicationName;</span><br><span class="line">            <span class="keyword">if</span> (bundleApplicationName == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Class applicationClass = Class.forName(bundleApplicationName);</span><br><span class="line">                Bundle.postUI(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BundleApplicationContext appContext = <span class="keyword">new</span> BundleApplicationContext(app, apk);</span><br><span class="line">                            Application bundleApplication = Instrumentation.newApplication(</span><br><span class="line">                                    applicationClass, appContext);</span><br><span class="line">                            sHostInstrumentation.callApplicationOnCreate(bundleApplication);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lazy init content providers</span></span><br><span class="line">        <span class="keyword">if</span> (mLazyInitProviders != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Method m = sActivityThread.getClass().getDeclaredMethod(</span><br><span class="line">                        <span class="string">"installContentProviders"</span>, Context.class, List.class);</span><br><span class="line">                m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                m.invoke(sActivityThread, app, mLazyInitProviders);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to lazy init content providers: "</span> + mLazyInitProviders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Free temporary variables</span></span><br><span class="line">        sLoadedApks = <span class="keyword">null</span>;</span><br><span class="line">        sProviders = <span class="keyword">null</span>;</span><br><span class="line">        sActivityThread = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　这里可以看到它通过ReflectAccelerator.mergeResources去合并资源，里面特意增加对Android7.0的WebView Assets处理。这些过程都在反射的协助下完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AssetManager newAssetManager;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">24</span>) &#123;</span><br><span class="line">    newAssetManager = newAssetManager();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// On Android 7.0+, this should contains a WebView asset as base. #347</span></span><br><span class="line">    newAssetManager = app.getAssets();</span><br><span class="line">&#125;</span><br><span class="line">addAssetPaths(newAssetManager, assetPaths);</span><br></pre></td></tr></table></figure>
<p>　　继续通过ReflectAccelerator.expandDexPathList合并Dex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">expandDexPathList</span><span class="params">(ClassLoader cl, String[] dexPaths, DexFile[] dexFiles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">14</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> V9_13.expandDexPathList(cl, dexPaths, dexFiles);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> V14_.expandDexPathList(cl, dexPaths, dexFiles);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　ReflectAccelerator.expandNativeLibraryDirectories继续加载JNI Native库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandNativeLibraryDirectories</span><span class="params">(ClassLoader classLoader, List&lt;File&gt; libPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v = Build.VERSION.SDK_INT;</span><br><span class="line">        <span class="keyword">if</span> (v &lt; <span class="number">14</span>) &#123;</span><br><span class="line">            V9_13.expandNativeLibraryDirectories(classLoader, libPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v &lt; <span class="number">23</span>) &#123;</span><br><span class="line">            V14_22.expandNativeLibraryDirectories(classLoader, libPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            V23_.expandNativeLibraryDirectories(classLoader, libPath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　往下就对每个插件的Application的OnCreate事件进行分发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Trigger all the bundle application `onCreate' event</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> LoadedApk apk : apks) &#123;</span><br><span class="line">            String bundleApplicationName = apk.applicationName;</span><br><span class="line">            <span class="keyword">if</span> (bundleApplicationName == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Class applicationClass = Class.forName(bundleApplicationName);</span><br><span class="line">                Bundle.postUI(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BundleApplicationContext appContext = <span class="keyword">new</span> BundleApplicationContext(app, apk);</span><br><span class="line">                            Application bundleApplication = Instrumentation.newApplication(</span><br><span class="line">                                    applicationClass, appContext);</span><br><span class="line">                            sHostInstrumentation.callApplicationOnCreate(bundleApplication);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>　　这里还会加载Provider的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lazy init content providers</span></span><br><span class="line">        <span class="keyword">if</span> (mLazyInitProviders != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Method m = sActivityThread.getClass().getDeclaredMethod(</span><br><span class="line">                        <span class="string">"installContentProviders"</span>, Context.class, List.class);</span><br><span class="line">                m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                m.invoke(sActivityThread, app, mLazyInitProviders);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to lazy init content providers: "</span> + mLazyInitProviders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>　　Small.preSetUp 已有对providers的处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get providers</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = thread.getClass().getDeclaredField(<span class="string">"mBoundApplication"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object<span class="comment">/*AppBindData*/</span> data = f.get(thread);</span><br><span class="line">            f = data.getClass().getDeclaredField(<span class="string">"providers"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            providers = (List&lt;ProviderInfo&gt;) f.get(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to get providers from thread: "</span> + thread);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　这里重新加载，是为了增添一些容错处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onException</span><span class="params">(Object obj, Throwable e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (sProviders != <span class="keyword">null</span> &amp;&amp; e.getClass().equals(ClassNotFoundException.class)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> errorOnInstallProvider = <span class="keyword">false</span>;</span><br><span class="line">                StackTraceElement[] stacks = e.getStackTrace();</span><br><span class="line">                <span class="keyword">for</span> (StackTraceElement st : stacks) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (st.getMethodName().equals(<span class="string">"installProvider"</span>)) &#123;</span><br><span class="line">                        errorOnInstallProvider = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (errorOnInstallProvider) &#123;</span><br><span class="line">                    <span class="comment">// We'll reinstall this content provider later, so just ignores it!!!</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">FIXME:</span> any better way to get the class name?</span></span><br><span class="line">                    String msg = e.getMessage();</span><br><span class="line">                    <span class="keyword">final</span> String prefix = <span class="string">"Didn't find class \""</span>;</span><br><span class="line">                    <span class="keyword">if</span> (msg.startsWith(prefix)) &#123;</span><br><span class="line">                        String providerClazz = msg.substring(prefix.length());</span><br><span class="line">                        providerClazz = providerClazz.substring(<span class="number">0</span>, providerClazz.indexOf(<span class="string">"\""</span>));</span><br><span class="line">                        <span class="keyword">for</span> (ProviderInfo info : sProviders) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (info.name.equals(providerClazz)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (mLazyInitProviders == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    mLazyInitProviders = <span class="keyword">new</span> ArrayList&lt;ProviderInfo&gt;();</span><br><span class="line">                                &#125;</span><br><span class="line">                                mLazyInitProviders.add(info);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onException(obj, e);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>　　至此，启动流程的插件加载也说完了。整个启动过程基本就到这里了。</p>
<p>　　下一节我会介绍继续Small的更新流程的源码。</p>
<p>　　敬请期待！！!</p>
<p><a href="http://www.jianshu.com/p/3724ee20ad99" target="_blank" rel="noopener">第一节:Android Small 源码分析(一) 启动流程</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/02/04/Android-Small-源码分析(一)-启动流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/04/Android-Small-源码分析(一)-启动流程/" itemprop="url">
                  Android Small 源码分析(一) 启动流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-04T19:56:00+08:00">
                2017-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://upload-images.jianshu.io/upload_images/3020228-169bce07d656247a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></h2><p>　　17年春节前这段时间一直抱着Small(aarVersion = ‘1.1.0-alpha1’)，打算从零开始一个新的项目。心想Small源代码也该好好看看，究竟从哪里开始才好呢？ 还是从官方例子出发，从启动开始深入。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-f0f22004632a5c15.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt=""></p>
<p>　　首先从Small在Github 上的<a href="https://github.com/wequick/Small/tree/master/Android" target="_blank" rel="noopener">Sample</a>项目开始了解Small的基本状况，如果要深入了解Small 的具体实现，就必须深入到其中的<a href="https://github.com/wequick/Small/tree/master/Android/DevSample" target="_blank" rel="noopener">DevSample</a>项目，因为这才是Small的源码所在。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-249f65821b3b2a15.png?watermark/1/image/aHR0cDovL29od2NrdWpzdS5ia3QuY2xvdWRkbi5jb20vJUU1JUE0JUI0JUU1JTgzJThGJUU2JUIwJUI0JUU1JThEJUIwLnBuZw==/gravity/NorthEast/imageMogr2/auto-orient/strip%7CimageView2/2/h/400" alt="源码目录结构"></p>
<p>　　通过UML工具（CodeIris 插件）可以一窥其内部，得到相关的类图，这里是以Smalll类为源头，省略一部分类，大致了解到核心所在。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-297abc8def84be8a.png?watermark/1/image/aHR0cDovL29od2NrdWpzdS5ia3QuY2xvdWRkbi5jb20vJUU1JUE0JUI0JUU1JTgzJThGJUU2JUIwJUI0JUU1JThEJUIwLnBuZw==/gravity/SouthEast/imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p>
<p>　　从实际应用Small过程中，想必会关注到bundle.json这个文件，可以看得出BundleLaucher 是个关键类。因此将其抽取出来，分析关联的类结构(这里省略覆盖方法)。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-0a210bfa61589540.png?watermark/1/image/aHR0cDovL29od2NrdWpzdS5ia3QuY2xvdWRkbi5jb20vJUU1JUE0JUI0JUU1JTgzJThGJUU2JUIwJUI0JUU1JThEJUIwLnBuZw==/gravity/NorthEast/imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p>
<p>　　BundleLauncher以及 SoBundleLauncher 都是抽象类，具体的应用得细看ApkBundleLauncher、ActivityLauncher这两个类，我会在后面具体分析到。</p>
<p>　　到此，我们已经大致了解Small的源码目录结构，我们要退一步从Small Sample项目开始，也就是用实际应用的项目开始溯源。</p>
<h1 id="一-Small-启动流程"><a href="#一-Small-启动流程" class="headerlink" title="一. Small 启动流程"></a>一. Small 启动流程</h1><p>##（一）Small 预处理<br>　　首先我们看一下宿主app的Application类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// This should be the very first of the application lifecycle.</span></span><br><span class="line">        <span class="comment">// It's also ahead of the installing of content providers by what we can avoid</span></span><br><span class="line">        <span class="comment">// the ClassNotFound exception on if the provider is unimplemented in the host.</span></span><br><span class="line">        Small.preSetUp(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">// Optional</span></span><br><span class="line">        Small.setBaseUri(<span class="string">"http://m.wequick.net/demo/"</span>);<span class="comment">//设定基本的跳转地址</span></span><br><span class="line">        Small.setWebViewClient(<span class="keyword">new</span> MyWebViewClient());<span class="comment">//设置网页的基本回调</span></span><br><span class="line">        Small.setLoadFromAssets(BuildConfig.LOAD_FROM_ASSETS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebViewClient</span> <span class="keyword">extends</span> <span class="title">WebViewClient</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　Small.java内部基本都是静态方法，是Small框架的程序入口。在Application的构造方法中调用Small.preSetUp(this)，意思就是这应该在application的生命周期中最早调用的，也是安装Content Providers 之前，可以避免在宿主中发生ClassNotFound 异常.<br>　　具体来看看preSetUp里面吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preSetUp</span><span class="params">(Application context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sContext = context;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register default bundle launchers</span></span><br><span class="line">        registerLauncher(<span class="keyword">new</span> ActivityLauncher());</span><br><span class="line">        registerLauncher(<span class="keyword">new</span> ApkBundleLauncher());</span><br><span class="line">        registerLauncher(<span class="keyword">new</span> WebBundleLauncher());</span><br><span class="line">        Bundle.onCreateLaunchers(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>　　通过Bundle.registerLauncher方法添加三个BundleLauncher到Bundle.sBundleLaunchers列表，在通过 Bundle.onCreateLaunchers启动这三者的onCreate方法，但其实只有ApkBundleLauncher覆盖了OnCreate 方法。<br>　　ApkBundleLauncher是bundle加载的管理类，我们看看它的OnCreate是怎么定义的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(app);</span><br><span class="line"></span><br><span class="line">        Object<span class="comment">/*ActivityThread*/</span> thread;</span><br><span class="line">        List&lt;ProviderInfo&gt; providers;</span><br><span class="line">        Instrumentation base;</span><br><span class="line">        ApkBundleLauncher.InstrumentationWrapper wrapper;</span><br><span class="line">        Field f;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过getActivityThread反射获取ActivityThread的对象</span></span><br><span class="line">        thread = ReflectAccelerator.getActivityThread(app);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将自定义的InstrumentationWrapper替换掉原来的mInstumentation</span></span><br><span class="line">       <span class="comment">// Small通过占坑的方式管理Activity的.重点就在这里</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = thread.getClass().getDeclaredField(<span class="string">"mInstrumentation"</span>);<span class="comment">//取得mInstrumentation属性</span></span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            base = (Instrumentation) f.get(thread);</span><br><span class="line">            wrapper = <span class="keyword">new</span> ApkBundleLauncher.InstrumentationWrapper(base);</span><br><span class="line">            f.set(thread, wrapper);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to replace instrumentation for thread: "</span> + thread);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 继续替换Message Handler，用于恢复Activity Info 到真实的Activity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = thread.getClass().getDeclaredField(<span class="string">"mH"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Handler ah = (Handler) f.get(thread);</span><br><span class="line">            f = Handler.class.getDeclaredField(<span class="string">"mCallback"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            f.set(ah, <span class="keyword">new</span> ApkBundleLauncher.ActivityThreadHandlerCallback());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to replace message handler for thread: "</span> + thread);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取App的provider列表</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = thread.getClass().getDeclaredField(<span class="string">"mBoundApplication"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object<span class="comment">/*AppBindData*/</span> data = f.get(thread);</span><br><span class="line">            f = data.getClass().getDeclaredField(<span class="string">"providers"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            providers = (List&lt;ProviderInfo&gt;) f.get(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to get providers from thread: "</span> + thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存到全局变量，便于以后替换管理</span></span><br><span class="line">        sActivityThread = thread;</span><br><span class="line">        sProviders = providers;</span><br><span class="line">        sHostInstrumentation = base;</span><br><span class="line">        sBundleInstrumentation = wrapper;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　ApkBundleLauncher.InstrumentationWrapper 这个是关键类，Android activities受<a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/app/Instrumentation.java" target="_blank" rel="noopener">Instrumentation</a>监控。每一个Activity由<a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/app/Activity.java" target="_blank" rel="noopener">Activity</a>的startActivityForResult<br>方法启动，通过instrumentation的execStartActivity方法激活生命周期；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity( <span class="comment">// Override entry 1</span></span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　在<a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener">ActivityThread</a>的performLaunchActivity方法中通过instrumentation的newActivity方法实例化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity( <span class="comment">// Override entry 2</span></span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　Small 想要做到动态注册Activity，首先在宿主manifest中注册一个命名特殊的占坑activity来欺骗startActivityForResult以获得生命周期，再欺骗performLaunchActivity来获得插件activity实例。又为了处理之间的信息传递，因此有了后面的ActivityThreadHandlerCallback。</p>
<p>##（二）LaunchActivity 启动初始化<br>　　Small.setUp这个方法需要放在OnStart()中执行，避免一些问题的产生，初始化完成之后，回调onComplete方法。完成加载之后，之后就交给插件的业务逻辑了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line"></span><br><span class="line">        SharedPreferences sp = LaunchActivity.<span class="keyword">this</span>.getSharedPreferences(<span class="string">"profile"</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">final</span> SharedPreferences.Editor se = sp.edit();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> tStart = System.nanoTime();</span><br><span class="line">        se.putLong(<span class="string">"setUpStart"</span>, tStart);</span><br><span class="line">        Small.setUp(LaunchActivity.<span class="keyword">this</span>, <span class="keyword">new</span> net.wequick.small.Small.OnCompleteListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> tEnd = System.nanoTime();</span><br><span class="line">                se.putLong(<span class="string">"setUpFinish"</span>, tEnd).apply();</span><br><span class="line">                <span class="keyword">long</span> offset = tEnd - tStart;</span><br><span class="line">                <span class="keyword">if</span> (offset &lt; MIN_INTRO_DISPLAY_TIME) &#123;</span><br><span class="line">                    <span class="comment">// 这个延迟仅为了让 "Small Logo" 显示足够的时间, 实际应用中不需要</span></span><br><span class="line">                    getWindow().getDecorView().postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            Small.openUri(<span class="string">"main"</span>, LaunchActivity.<span class="keyword">this</span>);</span><br><span class="line">                            finish();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, (MIN_INTRO_DISPLAY_TIME - offset) / <span class="number">1000000</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Small.openUri(<span class="string">"main"</span>, LaunchActivity.<span class="keyword">this</span>);</span><br><span class="line">                    finish();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　现在我们跟踪进setUp方法，看看里面究竟做了什么。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(Context context, OnCompleteListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Tips for CODE-BREAKING</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">                    <span class="string">"Please call `Small.preSetUp' in your application first"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sHasSetUp) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                listener.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Bundle.loadLaunchableBundles(listener);</span><br><span class="line">        sHasSetUp = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　可以看到Small确认还没初始化之后，就递给了Bundle类，在其内部执行静态方法loadLaunchableBundles，我们继续往下看。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadLaunchableBundles</span><span class="params">(Small.OnCompleteListener listener)</span> </span>&#123;</span><br><span class="line">       Context context = Small.getContext();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> synchronous = (listener == <span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">if</span> (synchronous) &#123;</span><br><span class="line">           loadBundles(context);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Asynchronous</span></span><br><span class="line">       <span class="keyword">if</span> (sThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">           sThread = <span class="keyword">new</span> LoadBundleThread(context);</span><br><span class="line">           sHandler = <span class="keyword">new</span> LoadBundleHandler(listener);</span><br><span class="line">           sThread.start();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　这个方法很简单，启动一个LoadBundleThread线程，一个Handler处理完成后的事项。在LoadBundleThread里面我们肯定会看到bundle.json的处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBundleThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        Context mContext;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoadBundleThread</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">            mContext = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            loadBundles(mContext);</span><br><span class="line">            sHandler.obtainMessage(MSG_COMPLETE).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　这里和之前的版本比较，会发现少了Bundle.setupLaunchers(Context)方法，仔细往下就会发现其实它被延后到loadBundles内部了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadBundles</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        JSONObject manifestData;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File patchManifestFile = getPatchManifestFile();<span class="comment">// app路径/file/bundle.json</span></span><br><span class="line">            String manifestJson = getCacheManifest();<span class="comment">//SharedPreferences的bundle.json字段</span></span><br><span class="line">            <span class="keyword">if</span> (manifestJson != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Load from cache and save as patch</span></span><br><span class="line">                <span class="keyword">if</span> (!patchManifestFile.exists()) patchManifestFile.createNewFile();</span><br><span class="line">                PrintWriter pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileOutputStream(patchManifestFile));</span><br><span class="line">                pw.print(manifestJson);</span><br><span class="line">                pw.flush();</span><br><span class="line">                pw.close();</span><br><span class="line">                <span class="comment">// Clear cache</span></span><br><span class="line">                setCacheManifest(<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (patchManifestFile.exists()) &#123;</span><br><span class="line">                <span class="comment">// Load from patch</span></span><br><span class="line">                BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(patchManifestFile));</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sb.append(line);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                br.close();</span><br><span class="line">                manifestJson = sb.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Load from built-in `assets/bundle.json'</span></span><br><span class="line">                InputStream builtinManifestStream = context.getAssets().open(BUNDLE_MANIFEST_NAME);</span><br><span class="line">                <span class="keyword">int</span> builtinSize = builtinManifestStream.available();</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[builtinSize];</span><br><span class="line">                builtinManifestStream.read(buffer);</span><br><span class="line">                builtinManifestStream.close();</span><br><span class="line">                manifestJson = <span class="keyword">new</span> String(buffer, <span class="number">0</span>, builtinSize);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Parse manifest file</span></span><br><span class="line">            manifestData = <span class="keyword">new</span> JSONObject(manifestJson);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Manifest manifest = parseManifest(manifestData);</span><br><span class="line">        <span class="keyword">if</span> (manifest == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        setupLaunchers(context);</span><br><span class="line"></span><br><span class="line">        loadBundles(manifest.bundles);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　由上可知，处理bundle.json 有位置优先级关系：manifestJson &gt; patchManifestFile &gt; assets/bundle.json ，也就是SharedPreferences &gt; File &gt; Assets 。因此，我们最初的配置在Assets里面的bundle.json 会在最后处理。<br>　　接着回到先前提及的setupLaunchers，回忆一下，在preSetUp中我们看到添加了3个BundleLauncher，这里就是对三者的setUp进行调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupLaunchers</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sBundleLaunchers == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BundleLauncher launcher : sBundleLaunchers) &#123;</span><br><span class="line">            launcher.setUp(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p><strong>ActivityLauncher的setUp方法</strong><br>　　我们继续跟踪进去，首先看看ActivityLauncher的setUp方法,它将注册在宿主的activities添加到sActivityClasses里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityLauncher</span> <span class="keyword">extends</span> <span class="title">BundleLauncher</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUp(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the registered classes in host's manifest file</span></span><br><span class="line">        PackageInfo pi;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pi = context.getPackageManager().getPackageInfo(</span><br><span class="line">                    context.getPackageName(), PackageManager.GET_ACTIVITIES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException ignored) &#123;</span><br><span class="line">            <span class="comment">// Never reach</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityInfo[] as = pi.activities;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sActivityClasses = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (ActivityInfo ai : as) &#123;</span><br><span class="line">                sActivityClasses.add(ai.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ApkBundleLauncher的setUp方法<br>　　这里与之前的ApkBundleLauncher的onCreate方法相呼应，通过动态代理的方式，将Intent参数重新包装来完成上面所说的欺骗方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApkBundleLauncher</span> <span class="keyword">extends</span> <span class="title">SoBundleLauncher</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUp(context);</span><br><span class="line"></span><br><span class="line">        Field f;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AOP for pending intent</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = TaskStackBuilder.class.getDeclaredField(<span class="string">"IMPL"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">final</span> Object impl = f.get(TaskStackBuilder.class);</span><br><span class="line">            InvocationHandler aop = <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    Intent[] intents = (Intent[]) args[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">for</span> (Intent intent : intents) &#123;</span><br><span class="line">                        sBundleInstrumentation.wrapIntent(intent);</span><br><span class="line">                        intent.setAction(Intent.ACTION_MAIN);</span><br><span class="line">                        intent.addCategory(Intent.CATEGORY_LAUNCHER);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> method.invoke(impl, args);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Object newImpl = Proxy.newProxyInstance(context.getClassLoader(), impl.getClass().getInterfaces(), aop);</span><br><span class="line">            f.set(TaskStackBuilder.class, newImpl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            ignored.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>　　我们进去wrapIntent看看,如果不是精确命中，intent.getComponent()为空，因此首先处理交给宿主的冲突问题，如果是系统或者宿主的Action，直接退出；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">wrapIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">            ComponentName component = intent.getComponent();</span><br><span class="line">            String realClazz;</span><br><span class="line">            <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Try to resolve the implicit action which has registered in host.</span></span><br><span class="line">                component = intent.resolveActivity(Small.getContext().getPackageManager());</span><br><span class="line">                <span class="keyword">if</span> (component != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// A system or host action, nothing to be done.</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Try to resolve the implicit action which has registered in bundles.</span></span><br><span class="line">                realClazz = resolveActivity(intent);</span><br><span class="line">                <span class="keyword">if</span> (realClazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Cannot resolved, nothing to be done.</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realClazz = component.getClassName();</span><br><span class="line">                <span class="keyword">if</span> (realClazz.startsWith(STUB_ACTIVITY_PREFIX)) &#123;</span><br><span class="line">                    <span class="comment">// Re-wrap to ensure the launch mode works.</span></span><br><span class="line">                    realClazz = unwrapIntent(intent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sLoadedActivities == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            ActivityInfo ai = sLoadedActivities.get(realClazz);</span><br><span class="line">            <span class="keyword">if</span> (ai == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Carry the real(plugin) class for incoming `newActivity' method.</span></span><br><span class="line">            intent.addCategory(REDIRECT_FLAG + realClazz);</span><br><span class="line">            String stubClazz = dequeueStubActivity(ai, realClazz);</span><br><span class="line">            intent.setComponent(<span class="keyword">new</span> ComponentName(Small.getContext(), stubClazz));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　否则尝试处理插件内的冲突(<strong>resolveActivity(intent)</strong>),初始失败则退出。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">resolveActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sLoadedIntentFilters == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;Map.Entry&lt;String, List&lt;IntentFilter&gt;&gt;&gt; it =</span><br><span class="line">            sLoadedIntentFilters.entrySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        Map.Entry&lt;String, List&lt;IntentFilter&gt;&gt; entry = it.next();</span><br><span class="line">        List&lt;IntentFilter&gt; filters = entry.getValue();</span><br><span class="line">        <span class="keyword">for</span> (IntentFilter filter : filters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (filter.hasAction(Intent.ACTION_VIEW)) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> match uri</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (filter.hasCategory(Intent.CATEGORY_DEFAULT)) &#123;</span><br><span class="line">                <span class="comment">// custom action</span></span><br><span class="line">                <span class="keyword">if</span> (filter.hasAction(intent.getAction())) &#123;</span><br><span class="line">                    <span class="comment">// hit</span></span><br><span class="line">                    <span class="keyword">return</span> entry.getKey();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　如果精确命中，先解开(<strong>unwrapIntent(intent);</strong>),后面重新选取一个未使用的activity坑与之使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> String[] mStubQueue;</span><br><span class="line">  <span class="comment">/** Get an usable stub activity clazz from real activity */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">dequeueStubActivity</span><span class="params">(ActivityInfo ai, String realActivityClazz)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (ai.launchMode == ActivityInfo.LAUNCH_MULTIPLE) &#123;</span><br><span class="line">          <span class="comment">// In standard mode, the stub activity is reusable.</span></span><br><span class="line">          <span class="comment">// Cause the `windowIsTranslucent' attribute cannot be dynamically set,</span></span><br><span class="line">          <span class="comment">// We should choose the STUB activity with translucent or not here.</span></span><br><span class="line">          Resources.Theme theme = Small.getContext().getResources().newTheme();</span><br><span class="line">          theme.applyStyle(ai.getThemeResource(), <span class="keyword">true</span>);</span><br><span class="line">          TypedArray sa = theme.obtainStyledAttributes(</span><br><span class="line">                  <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; android.R.attr.windowIsTranslucent &#125;);</span><br><span class="line">          <span class="keyword">boolean</span> translucent = sa.getBoolean(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">          sa.recycle();</span><br><span class="line">          <span class="keyword">return</span> translucent ? STUB_ACTIVITY_TRANSLUCENT : STUB_ACTIVITY_PREFIX;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> availableId = -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">int</span> stubId = -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">int</span> countForMode = STUB_ACTIVITIES_COUNT;</span><br><span class="line">      <span class="keyword">int</span> countForAll = countForMode * <span class="number">3</span>; <span class="comment">// 3=[singleTop, singleTask, singleInstance]</span></span><br><span class="line">      <span class="keyword">if</span> (mStubQueue == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Lazy init</span></span><br><span class="line">          mStubQueue = <span class="keyword">new</span> String[countForAll];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> offset = (ai.launchMode - <span class="number">1</span>) * countForMode;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; countForMode; i++) &#123;</span><br><span class="line">          String usedActivityClazz = mStubQueue[i + offset];</span><br><span class="line">          <span class="keyword">if</span> (usedActivityClazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (availableId == -<span class="number">1</span>) availableId = i;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (usedActivityClazz.equals(realActivityClazz)) &#123;</span><br><span class="line">              stubId = i;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (stubId != -<span class="number">1</span>) &#123;</span><br><span class="line">          availableId = stubId;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableId != -<span class="number">1</span>) &#123;</span><br><span class="line">          mStubQueue[availableId + offset] = realActivityClazz;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">          Log.e(TAG, <span class="string">"Launch mode "</span> + ai.launchMode + <span class="string">" is full"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> STUB_ACTIVITY_PREFIX + ai.launchMode + availableId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">unwrapIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">      Set&lt;String&gt; categories = intent.getCategories();</span><br><span class="line">      <span class="keyword">if</span> (categories == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Get plugin activity class name from categories</span></span><br><span class="line">      Iterator&lt;String&gt; it = categories.iterator();</span><br><span class="line">      <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">          String category = it.next();</span><br><span class="line">          <span class="keyword">if</span> (category.charAt(<span class="number">0</span>) == REDIRECT_FLAG) &#123;</span><br><span class="line">              <span class="keyword">return</span> category.substring(<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>ApkBundleLauncher的setUp方法的setUp方法<br>　　启动一个新的android 本身的WebView，这里作者特别注释到：在Android7.0上，在第一次创建WebView的时候，它会用WebView的Assets路径替换掉原Application Assets路径，一旦发生我们先前所做的努力化为泡影，因此我们尽可能将它推到前面设置。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.setUp(context);</span><br><span class="line">       <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">24</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">       Bundle.postUI(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="comment">// In android 7.0+, on firstly create WebView, it will replace the application</span></span><br><span class="line">               <span class="comment">// assets with the one who has join the WebView asset path.</span></span><br><span class="line">               <span class="comment">// If this happens after our assets replacement,</span></span><br><span class="line">               <span class="comment">// what we have done would be come to naught!</span></span><br><span class="line">               <span class="comment">// So, we need to push it enOOOgh ahead! (#347)</span></span><br><span class="line">               <span class="keyword">new</span> android.webkit.WebView(Small.getContext());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>　　准备工作都完成了，接着到调用loadBundles的方法，加载所有模块，这里在 <strong>prepareForLaunch()</strong> 包含了很多处理，这里暂且不详细讲了，不然又要扯很远再回来，下一节会详细讲。<br>　　等待这一切完成之后，就通过Handler通知完成，回到LaunchActivity的OnStart内继续执行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadBundles</span><span class="params">(List&lt;Bundle&gt; bundles)</span> </span>&#123;</span><br><span class="line">        sPreloadBundles = bundles;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare bundle</span></span><br><span class="line">        <span class="keyword">for</span> (Bundle bundle : bundles) &#123;</span><br><span class="line">            bundle.prepareForLaunch();<span class="comment">//会产生IO操作</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle I/O</span></span><br><span class="line">        <span class="keyword">if</span> (sIOActions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ExecutorService executor = Executors.newFixedThreadPool(sIOActions.size());</span><br><span class="line">            <span class="keyword">for</span> (Runnable action : sIOActions) &#123;</span><br><span class="line">                executor.execute(action);</span><br><span class="line">            &#125;</span><br><span class="line">            executor.shutdown();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!executor.awaitTermination(LOADING_TIMEOUT_MINUTES, TimeUnit.MINUTES)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to load bundles! (TIMEOUT &gt; "</span></span><br><span class="line">                            + LOADING_TIMEOUT_MINUTES + <span class="string">"minutes)"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            sIOActions = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait for the things to be done on UI thread before `postSetUp`,</span></span><br><span class="line">        <span class="comment">// as on 7.0+ we should wait a WebView been initialized. (#347)</span></span><br><span class="line">        <span class="keyword">while</span> (sRunningUIActionCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify `postSetUp' to all launchers</span></span><br><span class="line">        <span class="keyword">for</span> (BundleLauncher launcher : sBundleLaunchers) &#123;</span><br><span class="line">            launcher.postSetUp();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait for the things to be done on UI thread after `postSetUp`,</span></span><br><span class="line">        <span class="comment">// like creating a bundle application.</span></span><br><span class="line">        <span class="keyword">while</span> (sRunningUIActionCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Free all unused temporary variables</span></span><br><span class="line">        <span class="keyword">for</span> (Bundle bundle : bundles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bundle.parser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bundle.parser.close();</span><br><span class="line">                bundle.parser = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            bundle.mBuiltinFile = <span class="keyword">null</span>;</span><br><span class="line">            bundle.mExtractPath = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>　　至此，启动流程基本讲完了，插件的加载过程，也就是prepareForLaunch()部分，我将在下一节再详细介绍。<br>　　敬请期待！！!</p>
<p><a href="http://www.jianshu.com/p/0dbccfbd86ff" target="_blank" rel="noopener">第二节:Android Small 源码分析(二) 插件加载过程</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/01/22/使用-git-以子目录形式引入外部项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/使用-git-以子目录形式引入外部项目/" itemprop="url">
                  使用 git 以子目录形式引入外部项目
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-22T16:48:00+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-1a4b894c8278b34b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600/q/50" alt=""> 在<a href="http://www.jianshu.com/p/819f55379339" target="_blank" rel="noopener">此前的文章</a>里有简单说明submodule 的使用方法，却没有对其详细说明。</p>
<h1 id="submodule-子模块存在的问题"><a href="#submodule-子模块存在的问题" class="headerlink" title="submodule 子模块存在的问题"></a>submodule 子模块存在的问题</h1><p>Git 通过子模块处理这个问题。子模块允许你将一个 Git 仓库当作另外一个Git仓库的子目录。这允许你克隆另外一个仓库到你的项目中并且保持你的提交相对独立。</p>
<p>使用子模块并非没有任何缺点。首先，你在子模块目录中工作时必须相对小心。当你运行<strong>git submodule update</strong>，它会检出项目的指定版本，但是不在分支内。这叫做获得一个分离的头—-这意味着 HEAD 文件直接指向一次提交，而不是一个符号引用。问题在于你通常并不想在一个分离的头的环境下工作，因为太容易丢失变更了。如果你先执行了一次submodule update，然后在那个子模块目录里不创建分支就进行提交，然后再次从上层项目里运行<strong>git submodule update</strong>同时不进行提交，Git会毫无提示地覆盖你的变更。技术上讲你不会丢失工作，但是你将失去指向它的分支，因此会很难取到。</p>
<p>为了避免这个问题，当你在子模块目录里工作时应使用<strong>git checkout -b work</strong>创建一个分支。当你再次在子模块里更新的时候，它仍然会覆盖你的工作，但是至少你拥有一个可以回溯的指针。</p>
<p>切换带有子模块的分支同样也很有技巧。如果你创建一个新的分支，增加了一个子模块，然后切换回不带该子模块的分支，你仍然会拥有一个未被追踪的子模块的目录。</p>
<h1 id="使用SourceTree-快速Clone带Submodule的项目。"><a href="#使用SourceTree-快速Clone带Submodule的项目。" class="headerlink" title="使用SourceTree 快速Clone带Submodule的项目。"></a>使用SourceTree 快速Clone带Submodule的项目。</h1><p>使用最近版本的SourceTree ，就可以在clone 项目的过程自动完成子模块的拉取。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-7ebb70de761cb4cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="SourceTree"></p>
<p>直接点击右侧–子模块–项目名，可以进入子模块的版本控制页操作。</p>
<p>==&gt;&gt;&gt; <a href="">详细介绍</a></p>
<h1 id="另一种解决方式：Subtree-子树"><a href="#另一种解决方式：Subtree-子树" class="headerlink" title="另一种解决方式：Subtree 子树"></a>另一种解决方式：Subtree 子树</h1><p>现在你已经看到了子模块系统的麻烦之处，让我们来看一下解决相同问题的另一途径。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/01/22/在SourceTree中使用Git-Submodule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/在SourceTree中使用Git-Submodule/" itemprop="url">
                  在SourceTree中使用Git Submodule
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-22T16:48:00+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在开发的过程中我们的项目可能会引用其他的版本库中的代码, 例如公司已经累积了一套公用的函式库, 被多个项目调用; 很显然地, 不能把公用函式库的文件直接放到我们开发中的项目中, 这样不但项目的冗馀, 也增加维护的难度, 无疑是替自己找麻烦.</p>
<p>这时候我们就可以使用Git中submodule功能, 来管理我们的子模版, 在这裡我们配合使用GUI SourceTree(以下就简称ST吧), 以下就进入正文….</p>
<ol>
<li>准备工作</li>
</ol>
<p>首先我们先建立两个Repository分别叫smMain以及smLibA, 并把它们push到Git Server, 在这裡就不多说了.</p>
<p>bitbucket</p>
<p>smMain: <a href="https://git.coding.net/kuwork/testbranch.git" target="_blank" rel="noopener">https://git.coding.net/kuwork/testbranch.git</a></p>
<p>smLabA: <a href="https://bitbucket.org/youngce/smliba" target="_blank" rel="noopener">https://bitbucket.org/youngce/smliba</a></p>
<ol>
<li>加入Submodule</li>
</ol>
<p>在{path}/smMain中使用git submodule add命令添加submodule</p>
<p>git submodule add <a href="mailto:https://youngce@bitbucket.org/youngce/smliba.git" target="_blank" rel="noopener">https://youngce@bitbucket.org/youngce/smliba.git</a> libs/smlibA libs/smlibA表示将子模块clone到{path}/smMain/libs/smlibA路径下, 成功讯息如下图,</p>
<p>2014-10-24_1202</p>
<p>在smMain资料夹中可以发现多一个libs资料夹了, 在ST也出现了uncommitted changes以及submodules了</p>
<p>2014-10-24_1224 接下来Commit再Push就好了.</p>
<p>其实我们可以从上图的libs/smlibA的档案内容看出来, 在smMain的repository就只是记录subproject 的commit id 而已.</p>
<ol>
<li>Submodule更新</li>
</ol>
<p>当发现smLibA更新时, 如何在smMain也进行更新呢??</p>
<p>首先我先更新一下smLibA,</p>
<p>2014-10-24_1357 点击smMain的Tag, 然后点开Submodules, 在smLaibA上点击两下</p>
<p>2014-10-24_1359 这时会开启一个名为smLibA的新Tag, 这个smLibA指的smMain下的smLibA, 接下来就按下Pull做更新了</p>
<p>2014-10-24_1205 回到smMain会发现新的uncommitted, libs/smLibA中的subproject commit已经被修改为最新的commit id了</p>
<p>2014-10-24_1411</p>
<p>最后别忘了commit+push就完成了.</p>
<ol>
<li>Submodule修改</li>
</ol>
<p>在开发的过程可能会解决一些子项目的Bug或增加函式, 那如何做这样的修改并更新到子项目的repository呢??</p>
<p>在这裡, 将由smMain中修改smLibA, 最后再push到真正的smLibA的repository.</p>
<p>就直接由smMain资料夹中对libA.txt做修改吧!! 在修改完后你会发现ST中smMain并没有出现uncommitted,</p>
<p>那刚刚的修改是跑去哪裡了呢?? 开启submodule的smLibA看看吧!! 其实你可以想像submodule是存在于</p>
<p>git repository中的repository(submodule), git repository只记录目前repository(submodule), 是对应到哪个</p>
<p>commit id, 而repository(submodule)自己管理自己修改.</p>
<p>2014-10-24_1424</p>
<p>接著commit+push, 别以为这样就结束了, 我们还要去确定smMain的subproject commit有没有被修改, 要不然</p>
<p>下次Pull下来的时候我们submodule就不是我们修改过的!!</p>
<p>2014-10-24_1446</p>
<p>最后就Commit+Push吧!!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/01/22/GIT使用(整理)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/22/GIT使用(整理)/" itemprop="url">
                  GIT使用(整理)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-22T16:48:00+08:00">
                2017-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id=""><a href="#" class="headerlink" title=""></a><img src="http://upload-images.jianshu.io/upload_images/3020228-b3802e34ff6b868e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></h2><p>这篇东西是根据我以前写的<a href="http://ohwckujsu.bkt.clouddn.com/GIT%E4%BD%BF%E7%94%A8-%E6%95%B4%E7%90%86.svg" target="_blank" rel="noopener">思维导图</a>整理得来的，大致收集了几种场景以供不时之需。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-1a4b894c8278b34b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600/q/50" alt=""></p>
<h1 id="简要介绍"><a href="#简要介绍" class="headerlink" title="简要介绍"></a>简要介绍</h1><h2 id="工作区和暂存区的定义"><a href="#工作区和暂存区的定义" class="headerlink" title="工作区和暂存区的定义"></a>工作区和暂存区的定义</h2><p>首先我们来看一下git的基本目录结构，在你转换一个普通目录以前，是看不到.git文件夹的，git init 之后就会产生，Linux或者Mac下属于隐藏文件夹，在Windows下容易Ctrl+A随手就删掉了，删除时留心一下。</p>
<p><img src="http://ohwckujsu.bkt.clouddn.com/Git.svg" alt=""></p>
<ul>
<li><strong>工作区（Working Directory）</strong>：就是你在电脑里能看到的目录</li>
<li><strong>版本库（Repository）</strong>：工作区有一个隐藏目录.git，这个不算工作区，而是Git的版本库。<br>Git的版本库里存了很多东西，其中最重要的就是称为stage（或者叫index）的暂存区，还有Git为我们自动创建的第一个分支master，以及指向master的一个指针叫HEAD。</li>
</ul>
<h2 id="HEAD指针"><a href="#HEAD指针" class="headerlink" title="HEAD指针"></a>HEAD指针</h2><p>在Git中，用HEAD表示当前版本，也就是最新的提交3628164…882e1e0（注意我的提交ID和你的肯定不一样），上一个版本就是<strong>HEAD^</strong>，上上一个版本就是<strong>HEAD^^</strong>，当然往上100个版本写100个^比较容易数不过来，所以写成<strong>HEAD~100</strong>。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-cb3507864f7f5a6d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt=""></p>
<p>当执行git reset命令时，git会把老的HEAD拷贝到文件.git/ORIG_HEAD中，在命令中可以使用ORIG_HEAD引用这个commit.</p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li>git status 查看当前状态</li>
<li>git add 把文件修改添加到暂存区</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单独添加文件</span></span><br><span class="line">git add README</span><br><span class="line"><span class="comment"># 添加所有更改的文件</span></span><br><span class="line">git add .</span><br></pre></td></tr></table></figure>
<ul>
<li>git commit 把暂存区的所有内容提交到当前分支</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在add完之后使用，提交修改</span></span><br><span class="line">git commit -m <span class="string">"注释"</span></span><br><span class="line"><span class="comment"># 将在跟踪中的文件一次性提交</span></span><br><span class="line">git commit -a -m <span class="string">"注释"</span></span><br><span class="line"><span class="comment"># 使用上一次的提交信息重新提交</span></span><br><span class="line">git commit -a -c</span><br></pre></td></tr></table></figure>
<ul>
<li>git diff</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对比工作区和版本库里面最新版本</span></span><br><span class="line"> git diff HEAD -- filename</span><br></pre></td></tr></table></figure>
<ul>
<li>git reset</li>
</ul>
<p>不同参数的说明：</p>
<p>  A. –hard：重设（reset） index和working directory，自从<commit>以来在working directory中的任何改变都被丢弃，并把HEAD指向<commit>。</commit></commit></p>
<p>  B. –soft：index和working directory中的内容不作任何改变，仅仅把HEAD指向<commit>。这个模式的效果是，执行完毕后，自从<commit>以来的所有改变都会显示在git status的”Changes to be committed”中。</commit></commit></p>
<p>  C. –mixed：仅reset index，但是不reset working directory。这个模式是默认模式，即当不显示告知git reset模式时，会使用mixed模式。这个模式的效果是，working directory中文件的修改都会被保留，不会丢弃，但是也不会被标记成”Changes to be committed”，但是会打出什么还未被更新的报告。</p>
<p>  D.–merge：避免在回滚时清除working tree</p>
<p>  E. –keep:把在某一版本之后的commit清除掉，但是保持working tree不变</p>
<ul>
<li>git log</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单行 精简显示commit记录</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</span><br></pre></td></tr></table></figure>
<p>还有一些美化的用法，可以百度一下。这里不讲了</p>
<hr>
<p>接下来讲一下，使用git开发的各种情景。在搭建好git环境以后，可以针对各种情景快速熟悉git操作。</p>
<h1 id="情景一-创建版本库"><a href="#情景一-创建版本库" class="headerlink" title="情景一:  创建版本库"></a>情景一:  创建版本库</h1><p>如果你已经有一个项目文件夹或者创建一个空文件夹，进入文件夹创建本地Git仓库来进行版本管理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹</span></span><br><span class="line">mkdir floder</span><br><span class="line"><span class="comment"># 进入文件夹</span></span><br><span class="line"><span class="built_in">cd</span> floder</span><br><span class="line"><span class="comment"># git初始化</span></span><br><span class="line">git init</span><br></pre></td></tr></table></figure>
<p>或者你可以clone一个远程仓库到本地。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存在远程仓库，从远程拷贝</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:michaelliao/gitskills.git</span><br><span class="line"><span class="comment"># 关联到远程的空仓库</span></span><br><span class="line">git remote add origin git@github.com:michaelliao/learngit.git</span><br><span class="line"><span class="comment"># 将本地版本仓库推送到远程仓库</span></span><br><span class="line">git push origin mater</span><br></pre></td></tr></table></figure>
<h1 id="情景二-提交修改"><a href="#情景二-提交修改" class="headerlink" title="情景二:提交修改"></a>情景二:提交修改</h1><p>修改readme.txt文件之后，提交到本地仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加readme.txt到缓存区</span></span><br><span class="line">git add readme.txt</span><br><span class="line"><span class="comment"># 提交缓存区到版本库的当前支线</span></span><br><span class="line">git commit -m <span class="string">"添加一个说明文件"</span></span><br></pre></td></tr></table></figure>
<p>添加所有修改的文件，提交到本地仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加所有更改到缓存区</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交缓存区到版本库的当前支线</span></span><br><span class="line">git commit -m <span class="string">"注释"</span></span><br></pre></td></tr></table></figure>
<p>跳过暂存，直接提交所有修改到本地仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接提交本地的修改到当前支线</span></span><br><span class="line">git commit -a -m <span class="string">"注释"</span></span><br></pre></td></tr></table></figure>
<h1 id="情景三-撤销文件最近一次修改"><a href="#情景三-撤销文件最近一次修改" class="headerlink" title="情景三:撤销文件最近一次修改"></a>情景三:撤销文件最近一次修改</h1><p>常常发现自己错误的修改了一下文件，而它偏偏又commit了，除了查看修改进行恢复,还可以直接恢复。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从暂存或者版本库恢复到修改前</span></span><br><span class="line">git checkout -- readme.txt</span><br></pre></td></tr></table></figure>
<p>readme.txt自修改后还<strong>没有被放到暂存区</strong>，现在，撤销修改就回到和版本库一模一样的状态；</p>
<p>readme.txt已经<strong>添加到暂存区</strong>后，又作了修改，现在，撤销修改就回到添加到暂存区后的状态。</p>
<p><strong>git checkout – file命令中的–很重要，没有–，就变成了“创建一个新分支”的命令</strong></p>
<h1 id="情景四-发现当前的修改已经背离原意，一切回到当前版本"><a href="#情景四-发现当前的修改已经背离原意，一切回到当前版本" class="headerlink" title="情景四:发现当前的修改已经背离原意，一切回到当前版本"></a>情景四:发现当前的修改已经背离原意，一切回到当前版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放弃当前工作区以及缓存区的修改，恢复到当前版本</span></span><br><span class="line">git reset --hard HEAD</span><br></pre></td></tr></table></figure>
<h1 id="情景五-发现之前的提交都是错误的，回到正确的版本"><a href="#情景五-发现之前的提交都是错误的，回到正确的版本" class="headerlink" title="情景五:发现之前的提交都是错误的，回到正确的版本"></a>情景五:发现之前的提交都是错误的，回到正确的版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放弃当前工作区以及缓存区的修改，恢复到上一个版本</span></span><br><span class="line">git reset --hard HEAD^</span><br><span class="line"><span class="comment"># 放弃当前工作区以及缓存区的修改，恢复到上上个版本</span></span><br><span class="line">git reset --hard HEAD^^</span><br><span class="line"><span class="comment"># 放弃当前工作区以及缓存区的修改，恢复到特定版本</span></span><br><span class="line">git reset --hard SHA1</span><br></pre></td></tr></table></figure>
<h1 id="情景六-并行开发"><a href="#情景六-并行开发" class="headerlink" title="情景六:并行开发"></a>情景六:并行开发</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从当前分支中新建分支feature1-1,并切换到feature1-1分支</span></span><br><span class="line">git checkout -b  feature1-1</span><br><span class="line"><span class="comment"># 开发..</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 各种commit 之后,回到master分支</span></span><br><span class="line">git checkout master</span><br><span class="line"><span class="comment"># 将feature1-1分支合并到master分支(合并分支时，如果可能，Git会用Fast forward模式，</span></span><br><span class="line"><span class="comment"># 但这种模式下，删除分支后，会丢掉分支信息;git log 看不到分支的提交历史)</span></span><br><span class="line">git merge feature1-1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从当前分支中新建分支feature1-1,并切换到feature1-1分支</span></span><br><span class="line">git checkout -b  feature1-1</span><br><span class="line"><span class="comment"># 开发..</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 各种commit 之后,回到master分支</span></span><br><span class="line">git checkout master</span><br><span class="line"><span class="comment"># 将feature1-1分支合并到master分支(请注意--no-ff参数，表示禁用Fast forward：)</span></span><br><span class="line">git merge --no-ff -m <span class="string">"merge with no-ff"</span> feature1-1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将feature1-1分支的文件filename检出到当前分支</span></span><br><span class="line">git checkout feature1-1 -- filename</span><br></pre></td></tr></table></figure>
<h1 id="情景七-发现最近的几次提交不属于当前支线，应该另辟一条支线"><a href="#情景七-发现最近的几次提交不属于当前支线，应该另辟一条支线" class="headerlink" title="情景七:发现最近的几次提交不属于当前支线，应该另辟一条支线"></a>情景七:发现最近的几次提交不属于当前支线，应该另辟一条支线</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新的分支feature</span></span><br><span class="line">git branch feature1</span><br><span class="line"><span class="comment">#放弃当前分支的3次版本修改</span></span><br><span class="line">git reset --hard~3</span><br><span class="line"><span class="comment">#切换到feature1分支继续开发</span></span><br><span class="line">git checkout feature1</span><br></pre></td></tr></table></figure>
<h1 id="情景八-提交之后，发现代码没有完整提交，想重新编辑后提交"><a href="#情景八-提交之后，发现代码没有完整提交，想重新编辑后提交" class="headerlink" title="情景八:提交之后，发现代码没有完整提交，想重新编辑后提交"></a>情景八:提交之后，发现代码没有完整提交，想重新编辑后提交</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最近一次提交代码到版本库</span></span><br><span class="line">		git commit ...</span><br><span class="line"><span class="comment"># 保持working tree不变，回到上一个版本</span></span><br><span class="line">git reset --soft HEAD^</span><br><span class="line"><span class="comment"># 修改文件</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 重新使用之前那次commit的注释、作者、日期等信息,</span></span><br><span class="line"><span class="comment"># 把所有修改、删除的文件(不含未跟踪文件)重新提交.</span></span><br><span class="line">git commit -a -c ORIG_HEAD</span><br></pre></td></tr></table></figure>
<h1 id="情景九-放弃最近的几个版本，需要记录此次改变"><a href="#情景九-放弃最近的几个版本，需要记录此次改变" class="headerlink" title="情景九:放弃最近的几个版本，需要记录此次改变"></a>情景九:放弃最近的几个版本，需要记录此次改变</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放弃最近的三个版本,并生成一次commit</span></span><br><span class="line">git revert HEAD~3</span><br><span class="line"><span class="comment"># 放弃最近的第五个到第二个(不包含)，但不自动生成commit，仅仅修改index和working tree</span></span><br><span class="line">git revert -n master~5..master~2</span><br></pre></td></tr></table></figure>
<h1 id="情景十-完成分支开发，删除分支"><a href="#情景十-完成分支开发，删除分支" class="headerlink" title="情景十:完成分支开发，删除分支"></a>情景十:完成分支开发，删除分支</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除本地分支</span></span><br><span class="line">git branch -d  feature1-1</span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">git branch -D feature1-1</span><br></pre></td></tr></table></figure>
<h1 id="情景十一-标签的使用"><a href="#情景十一-标签的使用" class="headerlink" title="情景十一:标签的使用"></a>情景十一:标签的使用</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在当前支线的最近commit上打上"v1.0"的标签</span></span><br><span class="line">git tag v1.0</span><br><span class="line"><span class="comment"># 在SHA1对应的commit上打上"v1.0"的标签</span></span><br><span class="line">git tag v1.0 SHA1</span><br><span class="line"><span class="comment"># 查看标签V1.0的信息</span></span><br><span class="line">git show v1.0</span><br></pre></td></tr></table></figure>
<h1 id="情景十二-当前开发工作还不能提交到版本库，但迫切开启fixbug支线"><a href="#情景十二-当前开发工作还不能提交到版本库，但迫切开启fixbug支线" class="headerlink" title="情景十二:当前开发工作还不能提交到版本库，但迫切开启fixbug支线"></a>情景十二:当前开发工作还不能提交到版本库，但迫切开启fixbug支线</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存当前工作空间进栈</span></span><br><span class="line">git stash</span><br><span class="line"><span class="comment"># 切换到主线，工作区的内容丢失</span></span><br><span class="line">git checkout master</span><br><span class="line"><span class="comment"># 进行修复工作</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 重新切换到之前的支线dev</span></span><br><span class="line">git checkout dev</span><br><span class="line"><span class="comment"># 列出栈中内容</span></span><br><span class="line">git stash list</span><br><span class="line"><span class="comment"># 工作区的内容出栈</span></span><br><span class="line">git stash pop</span><br><span class="line">git stash apply stash@&#123;0&#125;</span><br><span class="line">git stash drop stash@&#123;0&#125;</span><br></pre></td></tr></table></figure>
<h1 id="情景十三-多库项目独立管理"><a href="#情景十三-多库项目独立管理" class="headerlink" title="情景十三:多库项目独立管理"></a>情景十三:多库项目独立管理</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url：项目路径 path：本地路径</span></span><br><span class="line">git submodule add url path</span><br><span class="line"><span class="comment"># 模块列表</span></span><br><span class="line">git submodule</span><br><span class="line"><span class="comment"># 第一次导入项目需要初始化</span></span><br><span class="line">git submodule init</span><br><span class="line"><span class="comment"># 更新所有的模块</span></span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Kuwork" />
          <p class="site-author-name" itemprop="name">Kuwork</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kuwork</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
