<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="K.W. 时间囊">
<meta property="og:url" content="https://kuwork.github.io/index.html">
<meta property="og:site_name" content="K.W. 时间囊">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="K.W. 时间囊">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kuwork.github.io/"/>





  <title> K.W. 时间囊 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">K.W. 时间囊</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">停下来休息的时候,不要忘记别人还在奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2018/07/22/Android-FixedTextView-字体大小自适应文本框/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/22/Android-FixedTextView-字体大小自适应文本框/" itemprop="url">
                  Android FixedTextView 字体大小自适应文本框
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-22T18:23:00+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://upload-images.jianshu.io/upload_images/3020228-98c2350657b39db4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>心血来潮，换一种方式重写几年前写的FixedTextView，不再一个字一个字计算适合的字体大小，使用StaticLayout来自动实现固定区域换行绘制文本。 <strong>效果图：</strong> <img src="https://upload-images.jianshu.io/upload_images/3020228-e30a3514bfb03cb8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><strong>代码不多：</strong> 测试布局</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center_horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"文本宽度小于内容宽度"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"30dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"30dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了,多了几个字"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"不同高度，限制行数"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"30dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"60dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"相同高度，相同行数，限制字体大小"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"60dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.kw.ui.fixedtextview.FixedTextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"60dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"#FF0000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMaxLine</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvMinTextSize</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvText</span>=<span class="string">"以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:ftvTextColor</span>=<span class="string">"#FFFFFF"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>FixedTextView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kw.ui.fixedtextview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.RequiresApi;</span><br><span class="line"><span class="keyword">import</span> android.text.Layout;</span><br><span class="line"><span class="keyword">import</span> android.text.StaticLayout;</span><br><span class="line"><span class="keyword">import</span> android.text.TextPaint;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedTextView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mMaxLine;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字体颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最小文字大小，默认为-1时，不做限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mMinTextSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mText;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextPaint mPaint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FixedTextView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FixedTextView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FixedTextView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi</span>(api = Build.VERSION_CODES.LOLLIPOP)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FixedTextView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</span><br><span class="line">        init(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.FixedTextView);</span><br><span class="line">        mMaxLine = a.getInt(R.styleable.FixedTextView_ftvMaxLine, <span class="number">1</span>);</span><br><span class="line">        mTextColor = a.getColor(R.styleable.FixedTextView_ftvTextColor, Color.parseColor(<span class="string">"#333333"</span>));</span><br><span class="line">        mMinTextSize = a.getDimension(R.styleable.FixedTextView_ftvMinTextSize, -<span class="number">1</span>);</span><br><span class="line">        mText = a.getString(R.styleable.FixedTextView_ftvText);</span><br><span class="line">        a.recycle();</span><br><span class="line"></span><br><span class="line">        mPaint = <span class="keyword">new</span> TextPaint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        mPaint.setColor(mTextColor);</span><br><span class="line">        mPaint.setTextSize(mMinTextSize);</span><br><span class="line">        mPaint.setStyle(Paint.Style.FILL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="keyword">int</span> mWidth = canvas.getWidth();</span><br><span class="line">        <span class="keyword">int</span> mHeight = canvas.getHeight();</span><br><span class="line">        <span class="keyword">int</span> width = (<span class="keyword">int</span>) Math.floor(mWidth - getPaddingLeft() - getPaddingRight());</span><br><span class="line">        <span class="keyword">int</span> height = (<span class="keyword">int</span>) Math.floor(mHeight - getPaddingTop() - getPaddingBottom());</span><br><span class="line">        <span class="comment">// 最小字体高度</span></span><br><span class="line">        <span class="keyword">float</span> minTextHeight = (<span class="keyword">float</span>) Math.floor(height / mMaxLine);</span><br><span class="line">        <span class="comment">// 最大字体高度</span></span><br><span class="line">        <span class="keyword">float</span> maxTextHeight = height;</span><br><span class="line">        <span class="keyword">float</span> textSize = Math.max(mMinTextSize, maxTextHeight);</span><br><span class="line">        StaticLayout staticLayout = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            mPaint.setTextSize(textSize);</span><br><span class="line">            staticLayout = <span class="keyword">new</span> StaticLayout(mText, mPaint, width, Layout.Alignment.ALIGN_NORMAL, <span class="number">1f</span>, <span class="number">0f</span>, <span class="keyword">false</span>);</span><br><span class="line">            textSize -= <span class="number">0.1f</span>;</span><br><span class="line">            <span class="keyword">if</span> (mMinTextSize != -<span class="number">1</span> &amp;&amp; textSize &lt;= mMinTextSize) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (staticLayout.getLineCount() &gt; mMaxLine);</span><br><span class="line">        <span class="keyword">if</span> (mMinTextSize != -<span class="number">1</span> &amp;&amp; textSize &lt;= mMinTextSize &amp;&amp; staticLayout.getLineCount() &gt; mMaxLine) &#123;</span><br><span class="line">            <span class="keyword">int</span> lineCount = staticLayout.getLineCount();</span><br><span class="line">            <span class="keyword">int</span> lineForVertical = staticLayout.getLineForVertical(height);<span class="comment">//最后一行行号</span></span><br><span class="line">            <span class="keyword">int</span> strMaxLen = mText.length();</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                strMaxLen -= <span class="number">1</span>;</span><br><span class="line">                staticLayout = <span class="keyword">new</span> StaticLayout(mText.substring(<span class="number">0</span>, strMaxLen), mPaint, width, Layout.Alignment.ALIGN_NORMAL, <span class="number">1f</span>, <span class="number">0f</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">while</span> (staticLayout.getLineCount() &gt; lineForVertical);</span><br><span class="line">            String substring = mText.substring(<span class="number">0</span>, strMaxLen - <span class="number">1</span>) + <span class="string">"…"</span>;</span><br><span class="line">            staticLayout = <span class="keyword">new</span> StaticLayout(substring, mPaint, width, Layout.Alignment.ALIGN_NORMAL, <span class="number">1f</span>, <span class="number">0f</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">float</span> dx = getPaddingLeft();</span><br><span class="line">        <span class="comment">// 修正横向居中问题</span></span><br><span class="line">        Rect rect = <span class="keyword">new</span> Rect();</span><br><span class="line">        String text = staticLayout.getText().toString();</span><br><span class="line">        mPaint.getTextBounds(text, <span class="number">0</span>, text.length(), rect);</span><br><span class="line">        <span class="keyword">if</span> (rect.width() &lt; width) &#123;</span><br><span class="line">            dx = (<span class="keyword">float</span>) (getPaddingLeft() + Math.floor(width - rect.width()) / <span class="number">2f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 修正纵向居中问题</span></span><br><span class="line">        <span class="keyword">float</span> dy = getPaddingTop() + (height - staticLayout.getHeight()) / <span class="number">2f</span>;</span><br><span class="line">        canvas.translate(dx, dy);</span><br><span class="line">        staticLayout.draw(canvas);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fixedtextview_attrs.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"FixedTextView"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"ftvMaxLine"</span> <span class="attr">format</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"ftvMinTextSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"ftvTextColor"</span> <span class="attr">format</span>=<span class="string">"reference|color"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"ftvText"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流，谢谢大家的支持。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2018/07/22/Android-RxJava2-0的操作符/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/22/Android-RxJava2-0的操作符/" itemprop="url">
                  Android RxJava2.0的操作符
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-22T18:23:00+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Combining-Observables-Observable的组合操作符"><a href="#Combining-Observables-Observable的组合操作符" class="headerlink" title="Combining Observables(Observable的组合操作符)"></a>Combining Observables(Observable的组合操作符)</h1><p>Error Handling Operators(Observable的错误处理操作符) Combining Observables(Observable的组合操作符)</p>
<h2 id="combineLatest操作符"><a href="#combineLatest操作符" class="headerlink" title="combineLatest操作符"></a>combineLatest操作符</h2><p>combineLatest操作符把两个Observable产生的结果进行合并，合并的结果组成一个新的Observable。这两个Observable中任意一个Observable产生的结果，都和另一个Observable最后产生的结果，按照一定的规则进行合并。流程图如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-ec92b52bbc5285e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//产生0,5,10,15,20数列</span></span><br><span class="line">       Observable&lt;Long&gt; observable1 =</span><br><span class="line">               Observable.interval(<span class="number">0</span>,<span class="number">1000</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">               .map(<span class="keyword">new</span> Function&lt;Long, Long&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> Long <span class="title">apply</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> aLong*<span class="number">5</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">       <span class="comment">//产生0,10,20,30,40数列</span></span><br><span class="line">       Observable&lt;Long&gt; observable2 =</span><br><span class="line">       Observable.interval(<span class="number">500</span>,<span class="number">1000</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">               .map(<span class="keyword">new</span> Function&lt;Long, Long&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> Long <span class="title">apply</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> aLong*<span class="number">10</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">       Observable.combineLatest(observable1, observable2, <span class="keyword">new</span> BiFunction&lt;Long, Long, String&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(Long aLong, Long aLong2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> (<span class="string">""</span>+aLong)+(<span class="string">" "</span>+aLong2);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).subscribeWith(<span class="keyword">new</span> ResourceObserver&lt;String&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               System.out.println(<span class="string">"Sequence complete."</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">               System.err.println(<span class="string">"Error: "</span> + e.getMessage());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String aLong)</span> </span>&#123;</span><br><span class="line">               System.out.println(<span class="string">"Next: "</span> + aLong);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2018/07/04/Android跳转到应用商店详情页面（更全面）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/04/Android跳转到应用商店详情页面（更全面）/" itemprop="url">
                  Android跳转到应用商店详情页面（更全面）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-04T17:52:00+08:00">
                2018-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://upload-images.jianshu.io/upload_images/3020228-a41fe1191d61d0d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>换到新的公司有一段日子，最近有个新需求，优先跳到OS的应用市场的详情页，引导用户进行评价。 这里囊括了大部分的国内市场，如果没有(有可能是包名更新了)，最终采用原始的方式，让用户选择。 （fixed:修复某些老手机会因为找不到任何市场而报错）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by K.W. on 2018/6/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppMarketUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">//小米应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_MI_MARKET = <span class="string">"com.xiaomi.market"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MI_MARKET_PAGE = <span class="string">"com.xiaomi.market.ui.AppDetailActivity"</span>;</span><br><span class="line">    <span class="comment">//魅族应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_MEIZU_MARKET = <span class="string">"com.meizu.mstore"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MEIZU_MARKET_PAGE = <span class="string">"com.meizu.flyme.appcenter.activitys.AppMainActivity"</span>;</span><br><span class="line">    <span class="comment">//VIVO应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_VIVO_MARKET = <span class="string">"com.bbk.appstore"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIVO_MARKET_PAGE = <span class="string">"com.bbk.appstore.ui.AppStoreTabActivity"</span>;</span><br><span class="line">    <span class="comment">//OPPO应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_OPPO_MARKET = <span class="string">"com.oppo.market"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPPO_MARKET_PAGE = <span class="string">"a.a.a.aoz"</span>;</span><br><span class="line">    <span class="comment">//华为应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_HUAWEI_MARKET = <span class="string">"com.huawei.appmarket"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HUAWEI_MARKET_PAGE = <span class="string">"com.huawei.appmarket.service.externalapi.view.ThirdApiActivity"</span>;</span><br><span class="line">    <span class="comment">//ZTE应用商店</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_ZTE_MARKET = <span class="string">"zte.com.market"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZTE_MARKET_PAGE = <span class="string">"zte.com.market.view.zte.drain.ZtDrainTrafficActivity"</span>;</span><br><span class="line">    <span class="comment">//360手机助手</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_360_MARKET = <span class="string">"com.qihoo.appstore"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_360_PAGE = <span class="string">"com.qihoo.appstore.distribute.SearchDistributionActivity"</span>;</span><br><span class="line">    <span class="comment">//酷市场 -- 酷安网</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_COOL_MARKET = <span class="string">"com.coolapk.market"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COOL_MARKET_PAGE = <span class="string">"com.coolapk.market.activity.AppViewActivity"</span>;</span><br><span class="line">    <span class="comment">//应用宝</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_TENCENT_MARKET = <span class="string">"com.tencent.android.qqdownloader"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TENCENT_MARKET_PAGE = <span class="string">"com.tencent.pangu.link.LinkProxyActivity"</span>;</span><br><span class="line">    <span class="comment">//PP助手</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_ALI_MARKET = <span class="string">"com.pp.assistant"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALI_MARKET_PAGE = <span class="string">"com.pp.assistant.activity.MainActivity"</span>;</span><br><span class="line">    <span class="comment">//豌豆荚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_WANDOUJIA_MARKET = <span class="string">"com.wandoujia.phoenix2"</span>;</span><br><span class="line">    <span class="comment">// 低版本可能是 com.wandoujia.jupiter.activity.DetailActivity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WANDOUJIA_MARKET_PAGE = <span class="string">"com.pp.assistant.activity.PPMainActivity"</span>;</span><br><span class="line">    <span class="comment">//UCWEB</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_UCWEB_MARKET = <span class="string">"com.UCMobile"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String UCWEB_MARKET_PAGE = <span class="string">"com.pp.assistant.activity.PPMainActivity"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弹起评价弹窗</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showDialog</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> IntentUtils.Builder(context)</span><br><span class="line">                .to(MarketAlertActivity.class)</span><br><span class="line">                .anim(R.anim.stay, R.anim.stay)</span><br><span class="line">                .build().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入应用市场详情页</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gotoMarket</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">"market://details?id="</span> + AppUtils.getPackageName(context)));</span><br><span class="line">        String[] keys = getKeys(context);</span><br><span class="line">        <span class="keyword">if</span> (keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setClassName(keys[<span class="number">0</span>], keys[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修复某些老手机会因为找不到任何市场而报错</span></span><br><span class="line">       <span class="keyword">if</span> (AppUtils.isIntentAvailable(context, intent)) &#123;</span><br><span class="line">            context.startActivity(intent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ToastUitls.show(context, context.getString(R.string.no_market));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] getKeys(Context context) &#123;</span><br><span class="line">        String[] keys = <span class="keyword">new</span> String[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_MI_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_MI_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = MI_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_VIVO_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_VIVO_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = VIVO_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_OPPO_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_OPPO_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = OPPO_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_HUAWEI_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_HUAWEI_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = HUAWEI_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_ZTE_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_ZTE_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = ZTE_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_COOL_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_COOL_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = COOL_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_360_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_360_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = PACKAGE_360_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_MEIZU_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_MEIZU_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = MEIZU_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_TENCENT_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_TENCENT_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = TENCENT_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_ALI_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_ALI_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = ALI_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_WANDOUJIA_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_WANDOUJIA_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = WANDOUJIA_MARKET_PAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AppUtils.isPackageExist(context, PACKAGE_UCWEB_MARKET)) &#123;</span><br><span class="line">            keys[<span class="number">0</span>] = PACKAGE_UCWEB_MARKET;</span><br><span class="line">            keys[<span class="number">1</span>] = UCWEB_MARKET_PAGE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(keys[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> keys;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppUtils 相关方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取app包名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回包名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getPackageName</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PackageManager manager = context.getPackageManager();</span><br><span class="line">            PackageInfo info = manager.getPackageInfo(context.getPackageName(),</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> info.packageName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packageName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Title</span> isPackageExist</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> .判断package是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2013年12月31日 上午9:49:59</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPackageExist</span><span class="params">(Context context, String packageName)</span> </span>&#123;</span><br><span class="line">        PackageManager manager = context.getPackageManager();</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent().setPackage(packageName);</span><br><span class="line">        List&lt;ResolveInfo&gt; infos = manager.queryIntentActivities(intent,</span><br><span class="line">                PackageManager.GET_INTENT_FILTERS);</span><br><span class="line">        <span class="keyword">if</span> (infos == <span class="keyword">null</span> || infos.size() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测 响应某个Intent的Activity 是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"WrongConstant"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isIntentAvailable</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> PackageManager packageManager = context.getPackageManager();</span><br><span class="line">        List&lt;ResolveInfo&gt; list = packageManager.queryIntentActivities(intent,</span><br><span class="line">                PackageManager.GET_ACTIVITIES);</span><br><span class="line">        <span class="keyword">return</span> list.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PS: 如果没有在相应的市场上线，需要相应屏蔽一些IF判断，如果该市场没有这个APP，一般会进入空白页。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/12/17/NDK-toolchain-交叉编译配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/17/NDK-toolchain-交叉编译配置/" itemprop="url">
                  NDK toolchain 交叉编译配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-17T21:02:00+08:00">
                2017-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-b5697f4aac49c1d5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>前些日子想扩充一下Libdiff+Bzip2，达到能解压Tar包。将Gnu Tar 用ndk的方式编译进来，始终编不过，还有一个方式就是以交叉编译的方式得到so，虽然交叉编译Tar的路子也没走通（最后通过更强大的p7zip解决压缩问题），这里把交叉编译配置过程写一下记录吧。  关于NDK的说明在<a href="https://developer.android.com/ndk/guides/index.html" target="_blank" rel="noopener">这里</a></p>
<p>make-standalone-toolchain.sh脚本位于 $NDK/build/tools/ 目录中，其中 $NDK 是 NDK 的安装根目录。 配置环境变量 : 修改 ~/.bash_profile ,在文件尾部加入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SDK_HOME = 填上SDK父目录路径</span><br><span class="line"><span class="built_in">export</span> NDK=<span class="variable">$SDK_HOME</span>/android-sdks/ndk-bundle</span><br><span class="line"><span class="comment"># darwin-x86_64 是Mac的路径，实际按目录结构修改</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$NDK</span>:<span class="variable">$NDK</span>/shader-tools/darwin-x86_64:<span class="variable">$NDK</span>/build/tools:<span class="variable">$PATH</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预设值，待会才生成的目录</span></span><br><span class="line"><span class="built_in">export</span> SYSROOT=/tmp/my-android-toolchain/sysroot</span><br><span class="line"><span class="built_in">export</span> PATH=/tmp/my-android-toolchain/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CC=arm-linux-androideabi-gcc   <span class="comment"># or export CC=clang</span></span><br><span class="line"><span class="built_in">export</span> CXX=arm-linux-androideabi-g++  <span class="comment"># or export CXX=clang++</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">"-lstdc++"</span></span><br></pre></td></tr></table></figure>
<p>配置了上面的设置，重启终端，make-standalone-toolchain.sh就能被找到。</p>
<p>下面展示了使用make-standalone-toolchain.sh生成预设编译环境的示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make-standalone-toolchain.sh --install-dir=/tmp/my-android-toolchain \</span><br><span class="line">--toolchain=arm-linux-androideabi-4.9 \</span><br><span class="line">--arch=arm --platform=android-15 --force</span><br></pre></td></tr></table></figure>
<p>此命令创建一个名为 /tmp/my-android-toolchain/ 的目录，包含一个 android-15/arch-arm sysroot 的副本，以及适用于 32 位 ARM 架构的工具链二进制文件的副本。</p>
<p>请注意，工具链二进制文件不依赖或包含主机特有的路径，换句话说，您可以将它们安装在任意位置中，甚至移动它们（如果需要）。</p>
<p><strong>这样设置以后就能直接运行项目根目录的configure脚本，无需配置环境参数。</strong></p>
<p>默认情况下，构建系统使用 32 位、基于 ARM 的 GCC 4.8 工具链。不过，您可以通过将 –arch=</p>
<toolchain> 指定为选项来指定一个不同的值。下表显示将用于其他工具链的值：</toolchain>

<p><strong>表. 工具链和对应的值，使用 –arch</strong> 。</p>
<table>
<thead>
<tr>
<th>工具链</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>mips64 编译器</td>
<td>–arch=mips64</td>
</tr>
<tr>
<td>mips GCC 4.8 编译器</td>
<td>–arch=mips</td>
</tr>
<tr>
<td>x86 GCC 4.8 编译器</td>
<td>–arch=x86</td>
</tr>
<tr>
<td>x86_64 GCC 4.8 编译器</td>
<td>–arch=x86_64</td>
</tr>
<tr>
<td>mips GCC 4.8 编译器</td>
<td>–arch=mips</td>
</tr>
</tbody>
</table>
<p>或者，您可以使用 –toolchain=</p>
<toolchain> 选项。下表显示您可以为 <toolchain> 指定的值：</toolchain></toolchain>

<table>
<thead>
<tr>
<th>工具链</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>arm</td>
<td>–toolchain=arm-linux-androideabi-4.8<br></td>
</tr>
</tbody>
</table>
<p>–toolchain=arm-linux-androideabi-4.9<br><br>–toolchain=arm-linux-android-clang3.5<br><br>–toolchain=arm-linux-android-clang3.6<br><br>x86 | –toolchain=x86-linux-android-4.8<br><br>–toolchain=x86-linux-android-4.9<br><br>–toolchain=x86-linux-android-clang3.5<br><br>–toolchain=x86-linux-android-clang3.6<br><br>mips | –toolchain=mips-linux-android-4.8<br><br>–toolchain=mips-linux-android-4.9<br><br>–toolchain=mips-linux-android-clang3.5<br><br>–toolchain=mips-linux-android-clang3.6<br><br>arm64 | –toolchain=aarch64-linux-android-4.9<br><br>–toolchain=aarch64-linux-android-clang3.5<br><br>–toolchain=aarch64-linux-android-clang3.6<br><br>x86_64 | –toolchain=x86_64-linux-android-4.9<br><br>–toolchain=x86_64-linux-android-clang3.5<br><br>–toolchain=x86_64-linux-android-clang3.6<br><br>mips64 | –toolchain=mips64el-linux-android-4.9<br><br>–toolchain=mips64el-linux-android-clang3.5<br><br>–toolchain=mips64el-linux-android-clang3.6<br></p>
<p>注：表 4 并不是一个详尽的列表。其他组合可能也有效，但未经验证。</p>
<p>您可以指定 –stl=stlport 以复制 libstlport，而不是使用默认的 libgnustl。 如果您执行此操作并想链接共享库，则必须以显式方式使用 -lstlport_shared。 此要求与必须为 GNU libstdc++ 使用 -lgnustl_shared 相似。</p>
<p>同样，您可以指定 –stl=libc++ 复制 LLVM libc++ 标头和库。如需链接共享库，您必须以显式方式使用 -lc++_shared。</p>
<p>请注意，如果您忽略 -install-dir 选项，则 make-standalone-toolchain.sh shell 脚本在 tmp/ndk/</p>
<p><toolchain-name>.tar.bz2 中创建一个 tarball。 此 tarball 让您可以轻松存档和重新分发二进制文件。</toolchain-name></p>
<p>此独立工具链还提供了一个额外优势，即：它包含一个 C++ STL 库的工作中副本以及工作中例外和 RTTI 支持。</p>
<p>如需了解更多选项和详细信息，请使用 –help。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/12/01/SQLite锁机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/01/SQLite锁机制/" itemprop="url">
                  SQLite锁机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-01T16:53:00+08:00">
                2017-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-78b087e747a0be9e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h1 id="一、SQLite3-事务与锁状态描述"><a href="#一、SQLite3-事务与锁状态描述" class="headerlink" title="一、SQLite3 事务与锁状态描述"></a>一、SQLite3 事务与锁状态描述</h1><p>SQLite3总共有<strong>三种事务类型</strong>：<strong>BEGIN [ DEFERRED /IMMEDIATE / EXCLUSIVE ] TRANSCATION</strong>，提供以下<strong>五种的文件锁状态</strong>，按锁的级别依次是：<strong>UNLOCKED / SHARED / RESERVERD / PENDING / EXCLUSIVE</strong>。</p>
<p><strong>1). UNLOCKED：无锁</strong> 文件没有持有任何锁，即当前数据库不存在任何读或写的操作。其它的进程可以在该数据库上执行任意的读写操作。此状态为缺省状态。 <strong>2). SHARED：共享锁</strong> 在此状态下，该数据库可以被读取但是不能被写入。在同一时刻可以有任意数量的进程在同一个数据库上持有共享锁，因此读操作是并发的。换句话说，只要有一个或多个共享锁处于活动状态，就不再允许有数据库文件写入的操作存在。 <strong>3). RESERVED：保留锁</strong> 假如某个进程在<strong>将来</strong>的某一时刻打算在当前的数据库中执行写操作，然而此时只是从数据库中读取数据，那么我们就可以简单的理解为数据库文件此时已经拥有了保留锁。当保留锁处于活动状态时，该数据库只能有一个或多个共享锁存在，即<strong>同一数据库的同一时刻只能存在一个保留锁和多个共享锁</strong>。 在Oracle中此类锁被称之为预写锁，不同的是Oracle中锁的粒度可以细化到表甚至到行，因此该种锁在Oracle中对并发的影响程序不像SQLite中这样大。 <strong>4). PENDING：等待锁（写等待）</strong> PENDING锁的意思是说，某个进程正打算在该数据库上执行写操作，然而此时该数据库中却存在很多共享锁(读操作)，那么该写操作就必须处于等待状态，即等待所有共享锁消失为止，与此同时，<strong>新的读操作将不再被允许，以防止写锁饥饿的现象发生</strong>。在此等待期间，该数据库文件的锁状态为PENDING，在等到所有共享锁消失以后，PENDING锁状态的数据库文件将在获取排他锁之后进入EXCLUSIVE状态。 <strong>5). EXCLUSIVE：排它锁（写）</strong> 在执行写操作之前，该进程必须先获取该数据库的排他锁。然而一旦拥有了排他锁，任何其它锁类型都不能与之共存。因此，为了最大化并发效率，SQLite将会最小化排他锁被持有的时间总量。</p>
<h1 id="二、SQLite3-并发控制过程"><a href="#二、SQLite3-并发控制过程" class="headerlink" title="二、SQLite3 并发控制过程"></a>二、SQLite3 并发控制过程</h1><p>SQLite的并发控制机制是采用加锁的方式，实现非常简单，但也非常的巧妙。请仔细阅读下图，它可以帮助更好的理解下面的内容。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-f2e750e2dfe98666.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>当执行select即读操作时，需要获取到SHARED锁（共享锁），当执行insert/update/delete操作(即内存写操作时)，需要进一步获取到RESERVERD锁（保留锁），当进行commit操作(即磁盘写操作时)，需要进一步获取到EXCLUSIVE锁（排它锁）。 对于RESERVERD锁，sqlite3保证同一时间只有一个连接可以获取到保留锁，也就是同一时间只有一个连接可以写数据库(内存)，但是其它连接仍然可以获取SHARED锁，也就是其它连接仍然可以进行读操作（这里可以认为写操作只是对磁盘数据的一份内存拷贝进行修改，并不影响读操作）。 对于EXCLUSIVE锁，是比保留锁更为严格的一种锁，在需要把修改写入磁盘即commit时需要在保留锁/未决锁的基础上进一步获取到排他锁，顾名思义，排他锁排斥任何其它类型的锁，即使是SHARED锁也不行，所以，在一个连接进行commit时，其它连接是不能做任何操作的（包括读）。 PENDING锁（即未决锁），则是比较特殊的一种锁，它可以允许已获取到SHARED锁的事务继续进行，但不允许其它连接再获取SHARED锁，当已存在的SHARED锁都被释放后（事务执行完成），持有未决锁的事务就可以获得commit的机会了。sqlite3使用这种锁来防止writer starvation（写饿死）。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/06/30/Android-增量更新-（二）更新流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/30/Android-增量更新-（二）更新流程/" itemprop="url">
                  Android增量更新（二）更新流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-30T15:17:57+08:00">
                2017-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-c38ad190d8b873ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>接上一节的内容，通过使用 Bsdiff 可以成功实现拆分和合并了。这个时候就要想一下如何完成整个更新的过程。</p>
<h2 id="必须想清楚的问题"><a href="#必须想清楚的问题" class="headerlink" title="必须想清楚的问题"></a>必须想清楚的问题</h2><p>这个时候要注意不再是增量拆分，而是如何平滑得实现应用的更新。</p>
<ul>
<li>优先级问题<br>当检查更新时，存在最新版本的补丁时，优先使用增量更新；如若没有，采用完整更新。</li>
<li>拆分次数问题<br>随着版本不断迭代，由于 Bsdiff 的拆分效能低，不能也没必要做到每个新版本提供以前所有版本的补丁。<br>试想一下，一个版本越久远越是可能与新版本存在较大差异，补丁包大小逐渐接近完整包大小，再者，App随着apk的Size也随之增加，拆分所需的时间、空间也随之增大，发布新版本的处理时间越来越长，增量更新的优势不复存在了，这是不能接受的。<br>在更新版本的时候给予设置向前比较次数，我以3个月为期，对于每月更新的APP可以设为3次。</li>
<li>唯一性问题<br>通常情况下，APP 的版本标识是 包名或者是 application id ，版本号，版本号，我则增加一个类型属性，可以理解为渠道名，这是为了解决一些现实的问题，同一APP给不同客户群体使用，例如测试人员和正式用户，测试人员可以收到内部快速迭代的更新包，而不会影响到正式用户，这样可以给特定用户群开放不同的版本功能，并且能够实现阶段性切换产品线。</li>
<li>完整性检验<br>通过SHA1校验码确认合并前后文件都是一致的，保障合并的成功率</li>
<li>级联删除<br>可以单独删除补丁包数据，相应版本只支持完整更新了；删除完整包数据，就要附带删除所有相关的补丁包数据，避免导致更新系统混乱。</li>
</ul>
<h2 id="界面设计"><a href="#界面设计" class="headerlink" title="界面设计"></a>界面设计</h2><p>目前在用的系统也是由这个雏形发展而来，而我现在并不在负责这个部分的编码，这里公布部分界面以及逻辑原理。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-b70c2c540c0d7d34.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li>1) 产品管理<br>这里的产品管理是以移动产品为标准划分。<br><strong>产品ID</strong>：自动UUID，在各个系统模块中通用，这里仅用于更新模块，也可用于广告投放模块。<br><strong>产品名称</strong>： 必填<br><strong>产品说明</strong>：一个公司里面可能存在很多类似的产品，用于区分细节。<br><strong>包名</strong>：如果上传的是APK包，则和应用市场类似，可以不填，自动获取第一次上传的application id ，以后通过新增版本页面上传是会对比这个参数，不符合就会上传失败，避免脑抽了，出现严重的问题。<br><strong>云端下载</strong>：自身系统的带宽有限，通过把包放到阿里云或者七牛等地方，减低带宽压力。</li>
<li>2）版本管理<br>如图所示。这里会在完整包信息之间插入补丁包信息。补丁包信息必须先于版本信息入库，避免出现查询异常。<br><strong>产品名称</strong>：必选<br><strong>版本类型</strong>：必选<br><strong>包名</strong>：自动获取，产品存在包名，将会进行对比，否则记入产品信息中。<br><strong>版本名</strong>：给普通用户查看的版本信息（字符串）。<br><strong>版本号</strong>：int类型，用于升级的版本信息，新上传的版本号必须大于上一版本。<br><strong>备注</strong>：填入升级信息。<br><strong>向前对比版本数量</strong>：月更新产品，建议设为3次，意思是向上对比不多于3个版本号；周更新产品自己酌情处理。<br><strong>SHA1</strong>：当前文件的SHA1校验码。<br><strong>旧版本SHA1</strong>：之前版本的完整包校验码，用于更新查询接口。</li>
</ul>
<h2 id="提交新版本过程"><a href="#提交新版本过程" class="headerlink" title="提交新版本过程"></a>提交新版本过程</h2><p><img src="http://upload-images.jianshu.io/upload_images/3020228-3de72ae9d669054e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="版本提交流程"></p>
<h2 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h2><p>检查更新接口拥有4个请求参数，如下</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>productId</strong></td>
<td>产品ID</td>
</tr>
<tr>
<td><strong>versionCode</strong></td>
<td>当前版本号</td>
</tr>
<tr>
<td><strong>type</strong></td>
<td>版本类型</td>
</tr>
<tr>
<td><strong>oldsha1code</strong></td>
<td>当前版本的校验码</td>
</tr>
</tbody>
</table>
<p>返回参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>name</strong></td>
<td>产品ID</td>
</tr>
<tr>
<td><strong>updateType</strong></td>
<td>更新类型有三种，inc(增量)、full(完整)、noupdate（无更新）</td>
</tr>
<tr>
<td><strong>versionCode</strong></td>
<td>最新版本号</td>
</tr>
<tr>
<td><strong>versionName</strong></td>
<td>最新版本名</td>
</tr>
<tr>
<td><strong>size</strong></td>
<td>long类型，更新包大小</td>
</tr>
<tr>
<td><strong>sizeOriginal</strong></td>
<td>在增量更新有效时，表示最新包大小</td>
</tr>
<tr>
<td><strong>newSHA</strong></td>
<td>最新包的SHA1校验码</td>
</tr>
<tr>
<td><strong>increaseSHA</strong></td>
<td>补丁包的SHA1校验码</td>
</tr>
<tr>
<td><strong>url</strong></td>
<td>下载链接</td>
</tr>
<tr>
<td><strong>updateList</strong></td>
<td>更新信息</td>
</tr>
</tbody>
</table>
<p>在系统中，版本37的SHA1 是 bbc3be08…4f72f41，最新版本是39，SHA1是d53eca….46474811f,从37到39的补丁包的SHA1 是56efbfce….8628。<br>1）情况一 ：可能当前版本和最新版本不存在补丁包，也可能是当前版本的检验码与服务器记录不符，要求完整更新<br>参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">productId:b6d9f85e...64ef</span><br><span class="line">versionCode:37</span><br><span class="line">type:official</span><br><span class="line">oldsha1code:1c5cae2551....964fcab</span><br></pre></td></tr></table></figure></p>
<p>接口结果:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"updateInfo"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"b6d9f85e...64ef"</span>,</span><br><span class="line">        <span class="attr">"updateType"</span>: <span class="string">"full"</span>,</span><br><span class="line">        <span class="attr">"versionCode"</span>: <span class="number">39</span>,</span><br><span class="line">        <span class="attr">"versionName"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">20185438</span>,</span><br><span class="line">        <span class="attr">"newSHA"</span>: <span class="string">"d53eca....46474811f"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://xxx.com/files/d53/d53ec/xxxx_1.3.3_39.apk"</span>,</span><br><span class="line">        <span class="attr">"updateList"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"versionCode"</span>: <span class="number">39</span>,</span><br><span class="line">                <span class="attr">"versionName"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">                <span class="attr">"updateContent"</span>: <span class="string">"1.【新增】优化月租续期缴费，新增自然月续期\n2.【优化】优化附近车场列表加载速度\n3.【优化】优化修复车位申请异常信息提示\n我们始终努力改善您的体验，提高稳定性以及性能优化"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"versionCode"</span>: <span class="number">38</span>,</span><br><span class="line">                <span class="attr">"versionName"</span>: <span class="string">"1.3.2"</span>,</span><br><span class="line">                <span class="attr">"updateContent"</span>: <span class="string">"1.【新增】预约车位增加车库位置信息和线路导航；\r\n2.【新增】车场列表新增地区选择和条件排序；\r\n3.【优化】优化附近车场信息和显示；\r\n4.【优化】优化月租到期续费；\r\n我们始终努力改善您的体验，提高稳定性以及性能优化。"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2） 情况二：增量更新<br>请求参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">productId:b6d9f85e...64ef</span><br><span class="line">versionCode:37</span><br><span class="line">type:official</span><br><span class="line">oldsha1code:bbc3be08...4f72f41</span><br></pre></td></tr></table></figure></p>
<p>接口结果：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"updateInfo"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"b6d9f85e...64ef"</span>,</span><br><span class="line">        <span class="attr">"updateType"</span>: <span class="string">"inc"</span>,</span><br><span class="line">        <span class="attr">"versionCode"</span>: <span class="number">39</span>,</span><br><span class="line">        <span class="attr">"versionName"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">4049580</span>,</span><br><span class="line">        <span class="attr">"sizeOriginal"</span>: <span class="number">20185438</span>,</span><br><span class="line">        <span class="attr">"newSHA"</span>: <span class="string">"d53eca....46474811f"</span>,</span><br><span class="line">        <span class="attr">"increaseSHA"</span>: <span class="string">"56efbfce....8628"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"http://xxx.com/files/d53/d53ec/xxxx_37_39.patch"</span>,</span><br><span class="line">        <span class="attr">"updateList"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"versionCode"</span>: <span class="number">39</span>,</span><br><span class="line">                <span class="attr">"versionName"</span>: <span class="string">"1.3.3"</span>,</span><br><span class="line">                <span class="attr">"updateContent"</span>: <span class="string">"1.【新增】优化月租续期缴费，新增自然月续期\n2.【优化】优化附近车场列表加载速度\n3.【优化】优化修复车位申请异常信息提示\n我们始终努力改善您的体验，提高稳定性以及性能优化"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"versionCode"</span>: <span class="number">38</span>,</span><br><span class="line">                <span class="attr">"versionName"</span>: <span class="string">"1.3.2"</span>,</span><br><span class="line">                <span class="attr">"updateContent"</span>: <span class="string">"1.【新增】预约车位增加车库位置信息和线路导航；\r\n2.【新增】车场列表新增地区选择和条件排序；\r\n3.【优化】优化附近车场信息和显示；\r\n4.【优化】优化月租到期续费；\r\n我们始终努力改善您的体验，提高稳定性以及性能优化。"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3）情况三：无更新,有两种原因触发，一是最新版本检查更新时出现，也可能是测试版本出现版本号比发布系统上的新。<br>请求参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">productId:b6d9f85e...64ef</span><br><span class="line">versionCode:39</span><br><span class="line">type:official</span><br><span class="line">oldsha1code:d53eca....46474811f</span><br></pre></td></tr></table></figure></p>
<p>接口结果：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"updateInfo"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"b6d9f85e...64ef"</span>,</span><br><span class="line">        <span class="attr">"updateType"</span>: <span class="string">"noupdate"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意：不要在同一文件夹下存放过多文件，会导致磁盘查找缓慢。可以利用像上面的方式利用SHA1来分散存储。</strong><br><img src="http://upload-images.jianshu.io/upload_images/3020228-1c5d3d65f14695e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>服务器这边的情况大致就是这样了，这个只要和后台开发说明白了，很快就能完成，这个接口除了黑盒测试之外，需要仔细过一遍白盒测试，如果存在潜在的问题，会在往后的发布过程中暴露出来，导致严重的更新事故。</p>
<p>第三部分本来想写APP的更新过程的，细想一下，这些年我换了几种网络框架，大致的逻辑也没什么变化，唯有网络框架变化导致代码重构。除非有迫切的原因，这个部分暂时不会写了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/06/30/基于RxJava2和RxRelay实现RxBus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/30/基于RxJava2和RxRelay实现RxBus/" itemprop="url">
                  基于RxJava2和RxRelay实现RxBus
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-30T15:17:57+08:00">
                2017-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-6bb6ca40c2f27039.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>　　相信大家都对EventBus这个很热门的工具很熟悉了，最近更新开发新框架的缘故，接触到Retrofit 2 和 RxJava 2 ，自然而然地使用RxBus来代替EventBus。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-1f5797262a5f9dda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RxJava"></p>
<h4 id="一辆有意思的BUS"><a href="#一辆有意思的BUS" class="headerlink" title="一辆有意思的BUS"></a>一辆有意思的BUS</h4><p>　　“Bus”这个词其实很形象的说明总线这个概念。那什么是总线？</p>
<p>　　总线是系统传送信息的公共通信干线，各个部件在总线上传递消息。RxBus实现了一种事件总线，一条公共的通信通道，上面跑着各种信息，Android中的各个组件或是控件都可以向它发送各种信息，在各个组件或控件中只要订阅这条总线，每当总线收到消息的时候，这些订阅者同样就能收到这些消息。</p>
<h4 id="RxBus-最基本的实现"><a href="#RxBus-最基本的实现" class="headerlink" title="RxBus 最基本的实现"></a>RxBus 最基本的实现</h4><p>支持注解方式订阅事件。<br>支持粘滞事件。<br>支持3种Bus:<br>Publish Bus( RxBus，参见 <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/PublishSubject.html" target="_blank" rel="noopener">PublishSubject</a> )<br>Behavior Bus(参见 <a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/BehaviorSubject.html" target="_blank" rel="noopener">BehaviorSubject</a>)<br>Replay Bus(参见<a href="http://reactivex.io/RxJava/2.x/javadoc/io/reactivex/subjects/ReplaySubject.html" target="_blank" rel="noopener">ReplaySubject</a>)</p>
<p>这三种都是基于Subject类，它负责在非Rx-Apis之间充当桥梁。但是也存在问题。他没有能力去处理onComplete 或 onError事件.如果在下游发生onError / onComplete ，上游将受到影响。</p>
<h4 id="ReRelay开源项目"><a href="#ReRelay开源项目" class="headerlink" title="ReRelay开源项目"></a><a href="https://github.com/JakeWharton/RxRelay" target="_blank" rel="noopener">ReRelay</a>开源项目</h4><p> <a href="https://github.com/JakeWharton" target="_blank" rel="noopener">JakeWharton</a> 大神已经帮你们处理好这些问题。</p>
<p> Relays 是既是Observable也是Consumer的<a href="https://github.com/ReactiveX/RxJava/" target="_blank" rel="noopener">RxJava</a> 类型，它同样能够很容易在non-Rx api和 Rx api之间搭起桥梁,而不必要担心下游的触发的终止状态（onComplete 或 onError）。</p>
<h4 id="RxBus-下载使用"><a href="#RxBus-下载使用" class="headerlink" title="RxBus 下载使用"></a>RxBus 下载使用</h4><p>Maven:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kw<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rxbus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Gradle:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.kw:rxbus:1.0.1'</span></span><br></pre></td></tr></table></figure></p>
<p>这个库 并不含有 RxAndroid 和 RxJava ，请自行添加</p>
<h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><h5 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RxBus.getInstance().send(<span class="keyword">new</span> UserEvent(<span class="number">1</span>,<span class="string">"名字"</span>));</span><br></pre></td></tr></table></figure>
<h5 id="接受事件"><a href="#接受事件" class="headerlink" title="接受事件"></a>接受事件</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册</span></span><br><span class="line">disposable = RxBus.getInstance().register(UserEvent.class, AndroidSchedulers.mainThread(), <span class="keyword">new</span> Consumer&lt;UserEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(UserEvent userEvent)</span> </span>&#123;</span><br><span class="line">                btnNext.setText(userEvent.getName());</span><br><span class="line">                Toast.makeText(getBaseContext(), userEvent.toString(), Toast.LENGTH_SHORT).show();</span><br><span class="line">                Log.d(<span class="string">"AActivity"</span>, <span class="string">"onNext:"</span> + Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"空指针错误"</span>);<span class="comment">//发生错误之后，会取消订阅</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> Consumer&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//发生错误后仅仅会进入一次，因为发生错误之后，会取消订阅</span></span><br><span class="line">                Toast.makeText(getBaseContext(), throwable.getMessage(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//上下两段代码具有相同意义</span></span><br><span class="line">disposable=RxBus.getInstance().toObservable(UserEvent.class)</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;UserEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(UserEvent userEvent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                btnNext.setText(userEvent.getName());</span><br><span class="line">                Toast.makeText(getBaseContext(),userEvent.toString(),Toast.LENGTH_SHORT).show();</span><br><span class="line">                Log.d(<span class="string">"AActivity"</span>,<span class="string">"onNext:"</span>+Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"空指针错误"</span>);<span class="comment">//发生错误之后，会取消订阅</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">new</span> Consumer&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//发生错误后仅仅会进入一次，因为发生错误之后，会取消订阅</span></span><br><span class="line">                Toast.makeText(getBaseContext(),throwable.getMessage(),Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//解除</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    RxBus.getInstance().unregister(disposable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Relay&lt;Object&gt; bus = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RxBus instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//禁用构造方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bus = PublishRelay.create().toSerialized();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxBus <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RxBus.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> RxBus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        bus.accept(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">toObservable</span><span class="params">(Class&lt;T&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus.ofType(eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用时，需要你定义一些事件类型，例如上面的UserEvent，该类型只会传递给订阅该类型的观察者。这主要归功于ofType操作符。</p>
<p>这里仅仅实现了广播事件，基于ReRelay还可以实现其他方式。</p>
<p>如果有什么不理解的，请浏览<a href="https://github.com/kuwork/rxbus" target="_blank" rel="noopener">基于Rxjava2+RxRelay 的RxBus</a>源码。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/06/13/Android-增量更新-（一）-NDK-编译-Bsdiff/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/13/Android-增量更新-（一）-NDK-编译-Bsdiff/" itemprop="url">
                  Android增量更新（一）NDK 编译 Bsdiff
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T17:39:00+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-c38ad190d8b873ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>现在增量更新的项目有基于Bsdiff、Courgette、HDiff ，相关的信息可以问问度娘去。我还是说说我实际在用的吧。</p>
<p>2013年的时候，APP应用市场慢慢浮现了省流量更新，那时公司赶着几个项目，周更的频度，更新环境经常是在测试车辆上，那个时候移动流量还是很蹩脚，我就下定决心尝试实现这个功能，从前台到后台，从无到有。增量更新、Bsdiff 这些词开始进入我的开发视野。那是第一次接触NDK，在eclipse下进行操作，我的神船(已卖出)是Ubuntu， NDK环境的安装都很顺利，避开了Windows下不少坑，也是由于Ubuntu这个原因，得以存活。得到的so库，一直用到现在，换了公司，换了平台。</p>
<p>这几天有空，重新在Mac AS上通过cmake复现一次编译过程。</p>
<h2 id="增量更新原理"><a href="#增量更新原理" class="headerlink" title="增量更新原理"></a>增量更新原理</h2><p>其实增量升级的原理很简单，即首先将应用的旧版本Apk与新版本Apk在服务器做差分，得到更新的部分的补丁，下载需要更新的补丁，跟本地的文件合并，安装即可。例如旧版本的APK有5M，新版的有8M，更新的部分则只能比3M大 (得到的差分包大小并不是简单的相减，因为Bsdiff是在二进制的基础上差分整个APK文件)，使用增量升级的好处显而易见，像我周更的APP（15MB），通常增加功能是1MB-5MB左右，修复Bug的话，可以很小，30KB- 200K，可以暂时忽略心里那根刺，随时随地更新，不担心流量。</p>
<p>整个更新过程的细节留在第二部分再细细说来。</p>
<h2 id="bsdiff-源码下载"><a href="#bsdiff-源码下载" class="headerlink" title="bsdiff 源码下载"></a>bsdiff 源码下载</h2><p>首先，重新找一下<a href="http://www.daemonology.net/bsdiff/" target="_blank" rel="noopener">bsdiff的源码</a>,从这里可以得知bsdiff的信息。</p>
<ul>
<li>版本V4.3</li>
<li>依赖Bzip2</li>
<li>内存饥饿型 bsdiff： max(17*old,9*old+new)+O(1)  bspatch：old+new+O(1) </li>
<li>运行时间差异：bsdiff 耗时长，bspatch 2秒</li>
<li>最大文件大小：2^61-1 = 2Ei-1 bytes</li>
</ul>
<p>了解了这些，对以后出现的问题也心里有数了，bsdiff不适合在移动设备运行，也不适合在服务器端同步运行。接着就是去下一个bzip2的源码了。</p>
<h2 id="bzip2-源码下载"><a href="#bzip2-源码下载" class="headerlink" title="bzip2 源码下载"></a>bzip2 源码下载</h2><p><a href="http://www.bzip.org/downloads.html" target="_blank" rel="noopener">Bzip2</a> 现在版本 1.0.6, 发布于2010-09-20.其他信息也不需要了。</p>
<h2 id="代码修改"><a href="#代码修改" class="headerlink" title="代码修改"></a>代码修改</h2><p>根目录存放 Bsdiff 源码，再建一个bzip2 文件夹放置Bzip2源码</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-0a4b4c8cd6dde108.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>里面有很多多余文件，分批清理一下，剩下来的就干净多了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-d3ebe07233476a9e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这个时候还是存在问题，bsdiff.c 、bspatch.c 是入口文件，肯定存在main函数，改一下，我就加上文件名作为前缀，编译会发现 bzip2recover.c 也有一个main函数，这个main函数直接注释就行了。</p>
<h2 id="AS-项目结构"><a href="#AS-项目结构" class="headerlink" title="AS 项目结构"></a>AS 项目结构</h2><p>说了那么多，我还没说一下我的项目结构。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-d1d73f6484cfffab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>测试APP很简单，提供两个按钮测试功能，信息从Logcat中获取。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-7cc31efadaf74108.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/320" alt=""></p>
<h2 id="开发编译"><a href="#开发编译" class="headerlink" title="开发编译"></a>开发编译</h2><p>添加CMakeLists.txt文件。我也是刚接触Cmake，查了下资料，也细细看了CMakeLists.txt文件里的默认注释，这是第一手资料哇。aux_source_directory和list方法 也是后来才知道，不用抄路径了，很欢喜….</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> For more information about using CMake with Android Studio, <span class="built_in">read</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> documentation: https://d.android.com/studio/projects/add-native-code.html</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sets the minimum version of CMake required to build the native library.</span></span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Creates and names a library, sets it as either STATIC</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or SHARED, and provides the relative paths to its <span class="built_in">source</span> code.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can define multiple libraries, and CMake builds them <span class="keyword">for</span> you.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Gradle automatically packages shared libraries with your APK.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将./src/main/cpp目录（不包含子目录）下所有源文件保存在变量 SRC 中</span></span><br><span class="line">aux_source_directory(./src/main/cpp SRC)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将./src/main/cpp/bzip2目录（不包含子目录）下所有源文件保存在变量 SRC_OTHER 中</span></span><br><span class="line">aux_source_directory(./src/main/cpp/bzip2 SRC_OTHER)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 SRC_OTHER 添加到 SRC 中</span></span><br><span class="line">list(APPEND SRC $&#123;SRC_OTHER&#125;)</span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             bsdiff</span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             $&#123;SRC&#125;</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Searches <span class="keyword">for</span> a specified prebuilt library and stores the path as a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> variable. Because CMake includes system libraries <span class="keyword">in</span> the search path by</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default, you only need to specify the name of the public NDK library</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you want to add. CMake verifies that the library exists before</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> completing its build.</span></span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable.</span><br><span class="line">              log-lib</span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate.</span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specifies libraries CMake should link to your target library. You</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> can link multiple libraries, such as libraries you define <span class="keyword">in</span> this</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> build script, prebuilt third-party libraries, or system libraries.</span></span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.</span><br><span class="line">                       bsdiff</span><br><span class="line">                       # Links the target library to the log library</span><br><span class="line">                       # included in the NDK.</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure>
<p>同步一下，AS为你创建环境，接下来，就需要C层向Java层提供接口调用，这就进入JNI的范畴了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java层接口文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BsdiffUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"bsdiff"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成差分包</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">diff</span><span class="params">(String oldpath, String newpath, String patch)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//旧apk和差分包合并</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * native方法</span></span><br><span class="line"><span class="comment">     * 使用路径为oldApkPath的apk与路径为patchPath的补丁包，合成新的apk，并存储于newApkPath</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldpath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newpath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> patch</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">patch</span><span class="params">(String oldpath, String newpath, String patch)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Android Studio 2.2 之后就方便多了，直接在方法名那，按 Alt+Enter 提示一下，就可以补全C层入口了。<br>这时候文件可能会创建在jni目录下，名字和你的库名字相同，改改就好了,我就拷回cpp目录下，顺带改了一下名字（重复了）。<br><img src="http://upload-images.jianshu.io/upload_images/3020228-839bb4a6b2600edb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-4ec49dec352c7ee4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="image.png"></p>
<p>可以看到，大部分的代码都有了，添加代码去完成我们需要的事情。</p>
<p>创建一个头文件，声明主要的方法。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//native-lib.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bsdiff_main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bspatch_main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> * argv[])</span></span>;</span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_kw_lib_bsdiff_BsdiffUtils_diff(JNIEnv *env, jclass type, jstring oldpath_,</span><br><span class="line">                                        jstring newpath_, jstring patch_) ;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_kw_lib_bsdiff_BsdiffUtils_patch(JNIEnv *env, jclass type, jstring oldpath_,</span><br><span class="line">                                         jstring newpath_, jstring patch_);</span><br></pre></td></tr></table></figure></p>
<p>再修改native-lib.c文件，调用 Bsdiff 的方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"native-lib.h"</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_kw_lib_bsdiff_BsdiffUtils_diff(JNIEnv *env, jclass type, jstring oldpath_,</span><br><span class="line">                                        jstring newpath_, jstring patch_) &#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[<span class="number">4</span>];</span><br><span class="line">    argv[<span class="number">0</span>] = <span class="string">"bsdiff"</span>;</span><br><span class="line">    argv[<span class="number">1</span>] = (*env)-&gt;GetStringUTFChars(env, oldpath_, <span class="number">0</span>);</span><br><span class="line">    argv[<span class="number">2</span>] = (*env)-&gt;GetStringUTFChars(env, newpath_, <span class="number">0</span>);</span><br><span class="line">    argv[<span class="number">3</span>] = (*env)-&gt;GetStringUTFChars(env, patch_, <span class="number">0</span>);</span><br><span class="line">    bsdiff_main(<span class="number">4</span>, (<span class="keyword">char</span> *)argv);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, oldpath_, argv[<span class="number">1</span>]);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, newpath_, argv[<span class="number">2</span>]);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, patch_, argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">free</span>(argv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_kw_lib_bsdiff_BsdiffUtils_patch(JNIEnv *env, jclass type, jstring oldpath_,</span><br><span class="line">                                         jstring newpath_, jstring patch_) &#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[<span class="number">4</span>];</span><br><span class="line">    argv[<span class="number">0</span>] = <span class="string">"bspatch"</span>;</span><br><span class="line">    argv[<span class="number">1</span>] = (*env)-&gt;GetStringUTFChars(env, oldpath_, <span class="number">0</span>);</span><br><span class="line">    argv[<span class="number">2</span>] = (*env)-&gt;GetStringUTFChars(env, newpath_, <span class="number">0</span>);</span><br><span class="line">    argv[<span class="number">3</span>] = (*env)-&gt;GetStringUTFChars(env, patch_, <span class="number">0</span>);</span><br><span class="line">    bspatch_main(<span class="number">4</span>, (<span class="keyword">char</span> *)argv);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, oldpath_, argv[<span class="number">1</span>]);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, newpath_, argv[<span class="number">2</span>]);</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, patch_, argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">free</span>(argv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是很简单呢？这个时候Bsdiff模块完成了，写写测试代码了</p>
<p>MainActivity的布局就不说了，简单的两个按钮，指定点击事件到click方法。必须用线程去处理，这里就简单处理了，后面还有更完善的方式，搞一个UpdateManager。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//旧版本</span></span><br><span class="line">    String old = getsdpath() + <span class="string">"com.ajb.anjubao.intelligent_1.3.2_38.apk"</span>;</span><br><span class="line">    <span class="comment">//新版本</span></span><br><span class="line">    String newp = getsdpath() + <span class="string">"com.ajb.anjubao.intelligent_1.3.3_39.apk"</span>;</span><br><span class="line">    <span class="comment">//差分包</span></span><br><span class="line">    String patch = getsdpath() + <span class="string">"com.ajb.anjubao.intelligent_38_39.patch"</span>;</span><br><span class="line">    <span class="comment">//旧版apk和差分包合并生成的新版apk</span></span><br><span class="line">    String tmp = getsdpath() + <span class="string">"new.apk"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.bt_diff:</span><br><span class="line">                Log.d(<span class="string">"Thread"</span>, <span class="string">"bt_diff Thread ID is "</span> + Thread.currentThread().getId());</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line">                        Log.d(<span class="string">"Thread"</span>, <span class="string">"Thread ID is "</span> + Thread.currentThread().getId());</span><br><span class="line">                        BsdiffUtils.diff(old, newp, patch);</span><br><span class="line">                        <span class="keyword">long</span> s1 = System.currentTimeMillis();</span><br><span class="line">                        Log.d(<span class="string">"bsdiff"</span>, <span class="string">"生成差分包成功，用时:"</span> + (s1 - s) + <span class="string">"ms"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.bt_patch:</span><br><span class="line">                Log.d(<span class="string">"Thread"</span>, <span class="string">"bt_patch Thread ID is "</span> + Thread.currentThread().getId());</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line">                        Log.d(<span class="string">"Thread"</span>, <span class="string">"Thread ID is "</span> + Thread.currentThread().getId());</span><br><span class="line">                        <span class="keyword">long</span> s2 = System.currentTimeMillis();</span><br><span class="line">                        BsdiffUtils.patch(old, tmp, patch);</span><br><span class="line">                        <span class="keyword">long</span> s3 = System.currentTimeMillis();</span><br><span class="line">                        Log.d(<span class="string">"bsdiff"</span>, <span class="string">"差分包合并成功，用时:"</span> + (s3 - s2) + <span class="string">"ms"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getsdpath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Environment.getExternalStorageDirectory().getPath() + File.separator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="如何测试成功与否"><a href="#如何测试成功与否" class="headerlink" title="如何测试成功与否"></a>如何测试成功与否</h2><p>在终端安装 Bsdiff 命令工具。Mac下，我装了Homebrew，直接brew install bsdiff 就有了。<br>在终端拆分两个文件得到一个patch文件，通过sha1sum命令计算SHA1校验码，将这两个文件放到手机中，也进行拆分，部分手机会由于内存问题奔溃，忽略之，毕竟这一步不在手机上运行，拷出patch文件，通过SHA1校验码判断是否一致。</p>
<p>合并之后就简单了，人工判断apk文件是否可以安装就行了，代码上断不能如此简单，这个以后再说。</p>
<p>第一部分到此就结束了，虽然讲解原理的地方不多，见谅。</p>
<p>源代码在这<br><a href="https://github.com/kuwork/LibBsdiff" target="_blank" rel="noopener">GITHUB</a><br><a href="https://coding.net/u/kuwork/p/LibBsdiff/git" target="_blank" rel="noopener">CODING</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/06/08/Android-IPC机制（进程间通信）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/08/Android-IPC机制（进程间通信）/" itemprop="url">
                  Android IPC机制（进程间通信）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-08T10:41:00+08:00">
                2017-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-0caa830385c429df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="一、-什么是IPC？"><a href="#一、-什么是IPC？" class="headerlink" title="一、 什么是IPC？"></a>一、 什么是IPC？</h2><p>IPC，全称Inter-Process Communication，字面意思就是进程间通信或者跨进程通信。那什么是进程呢？它和线程有什么暧昧的关系？<br>进程是系统进行资源分配和调度的基本单位，是操作系统结构的基础；早期表现为一个程序，现在可以看作线程的容器。线程是CPU调度的最小单位。一个进程可以包含一个或者多个线程，进程向系统申请资源，线程使用进程拥有的资源。<br>IPC不是Android所独有的，是现代操作系统都存在的机制，对于Android来说。它是一种基于Linux内核的移动OS，他的进程通信方式不仅仅包含信号量、套接字、管道等等，还包括了Android独有的、特色的Binder机制。</p>
<h2 id="二、-为什么需要多进程？应用场景…"><a href="#二、-为什么需要多进程？应用场景…" class="headerlink" title="二、 为什么需要多进程？应用场景…"></a>二、 为什么需要多进程？应用场景…</h2><p>谈到IPC的使用场景就必须提到多进程，只有面对多进程这种场景下，才需要考虑多进程通信，这是很好理解的。至于一个应用使用多进程的原因，这个可能很多，辟如有些模块由于特殊原因需要运行在独立的进程；又或者为了加大一个应用可使用的内存，通过多进程的方式申请多份内存空间。还有一个情况需要使用IPC，那就是多个应用之间进行数据共享，使用ContentProvider去查询数据时也是一种进程通讯，只是对我们来说透明化了，无法感知到。</p>
<h2 id="三、-Android如何开启多进程模式？"><a href="#三、-Android如何开启多进程模式？" class="headerlink" title="三、 Android如何开启多进程模式？"></a>三、 Android如何开启多进程模式？</h2><p>我们可以通过给四大组件在AndroidMenifest.xml指定指定 android:process属性，亦或是在JNI层fork一个新进程，别无他法，过程看似轻松简单，却暗藏杀机，如何抵消多进程带来的负面影响？</p>
<p>这里有个示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">         android:name=&quot;com.ryg.chapter_2.MainActivity&quot;</span><br><span class="line">         android:configChanges=&quot;orientation|screenSize&quot;</span><br><span class="line">         android:label=&quot;@string/app_name&quot;</span><br><span class="line">         android:launchMode=&quot;standard&quot; &gt;</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">                &lt;action  android:name=&quot;android.intent.action.MAIN&quot;  /&gt;</span><br><span class="line">                &lt;category  android:name=&quot;android.intent.category.LAUNCHER&quot;  /&gt;</span><br><span class="line">         &lt;/intent-filter&gt;</span><br><span class="line">     &lt;/activity</span><br><span class="line">    &lt;activity</span><br><span class="line">         android:name=&quot;com.ryg.chapter_2.SecondActivity&quot;</span><br><span class="line">         android:configChanges=&quot;screenLayout&quot;</span><br><span class="line">         android:label=&quot;@string/app_name&quot;</span><br><span class="line">         android:process=&quot;:remote&quot;  /&gt;</span><br><span class="line">    &lt;activity</span><br><span class="line">         android:name=&quot;com.ryg.chapter_2.ThirdActivity&quot;</span><br><span class="line">         android:configChanges=&quot;screenLayout&quot;</span><br><span class="line">         android:label=&quot;@string/app_name&quot;</span><br><span class="line">         android:process=&quot;com.ryg.chapter_2.remote&quot;  /&gt;</span><br></pre></td></tr></table></figure></p>
<p>眼尖的人都发现了两个android:process属性的值不一样，这意味在他们会在3个不同进程内运行。通过DDMS或者命令adb shell ps 观察。进程名看起来没有什么区别，其实它们是有区别的，进程名以“：”开头的进程会属于当前应用的私有进程，其他应用组件不能通过shareUID的方式让其在同一进程中运行，相反，就是全局进程，可以被共享。<br>ShareUID的方式需要两个应用拥有相同的UID以及相同的签名才可以，在这种情况下，不管他们是否跑在统一进程，他们可以互相访问对方的私有数据，譬如data目录、组件信息等等，如果是的话，那么它们还能共享内存数据，看起来就是一个应用的不同部分。</p>
<h2 id="四、-奇怪现象（哎呀，奇怪了。这个值怎么变了-）"><a href="#四、-奇怪现象（哎呀，奇怪了。这个值怎么变了-）" class="headerlink" title="四、 奇怪现象（哎呀，奇怪了。这个值怎么变了~）"></a>四、 奇怪现象（哎呀，奇怪了。这个值怎么变了~）</h2><p>有的Android开发者会选择在Application或者静态类中储存可变的属性，静态亦或是非静态的，当你开启多进程模式，你会发现你的世界不再简单如旧。</p>
<p>一般来说，使用多进程会造成如下几方面的问题：<br><strong>（1） 静态成员和单例模式完全失效。 </strong><br><strong>（2） 线程同步机制完全失效。 </strong><br><strong>（3） SharedPreferences 的可靠性下降。 </strong><br><strong>（4） Application会多次创建。</strong></p>
<p>我们知道Android为每一个应用分配了一个独立的虚拟机，或者说为每个进程都分配一个独立的虚拟机，不同的虚拟机在内存分配上有不同的地址空间，这就导致在不同的虚拟机中访问同一个类的对象会产生多份副本。既然不是同一块内存了，那就算是使用了进程锁也会失效，因为进程锁也是不同内存对象。SharedPreferences虽然最终写入XML文件，但也有利用内存机制进行加速，在不同进程下，并发写入，也会出现问题。在开启多进程模式下，一般认为Application是程序的入口而不应该变化，但可以通过打印进程名称，得知Application会启动多次，因此用于存储公共信息并不可靠。</p>
<h2 id="五、-IPC基础概念"><a href="#五、-IPC基础概念" class="headerlink" title="五、 IPC基础概念"></a>五、 IPC基础概念</h2><p>Serializable接口、Parcelable接口以及Binder，只有熟悉这三方面的内容后，我们才能更好地理解跨进程通信的各种方式。Serializable和Parcelable接口可以完成对象的序列化过程，当我们需要通过Intent和Binder传输数据时就需要使用Parcelable或者Serializable。</p>
<h3 id="1-如何使用Serializable来完成对象的序列化。"><a href="#1-如何使用Serializable来完成对象的序列化。" class="headerlink" title="1.如何使用Serializable来完成对象的序列化。"></a>1.如何使用Serializable来完成对象的序列化。</h3><p>想让一个对象实现序列化，只需要这个类实现Serializable接口并声明一个serialVersionUID即可，实现起来非常简单，几乎所有工作都被系统自动完成了。如何进行对象的序列化和反序列化也非常简单，只需要采用ObjectOutputStream和ObjectInputStream即可轻松实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ObjectUtil</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 对可序列对象BASE64字符串化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> K.W.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2013年9月19日 上午2:10:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectUtil</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBASE64String</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(obj==<span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ByteArrayOutputStream toByte = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">		ObjectOutputStream oos;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			oos = <span class="keyword">new</span> ObjectOutputStream(toByte);</span><br><span class="line">			oos.writeObject(obj);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 对byte[]进行Base64编码</span></span><br><span class="line">		<span class="keyword">return</span> Base64.encode(toByte.toByteArray());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getObject</span><span class="params">(String base64String)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">byte</span>[] base64Bytes;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			base64Bytes = Base64.decodeToByteArray(base64String);</span><br><span class="line">			ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(base64Bytes);</span><br><span class="line">			ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">			<span class="keyword">return</span> ois.readObject();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-Android中如何使用Parcelable进行序列化操作"><a href="#2-Android中如何使用Parcelable进行序列化操作" class="headerlink" title="2.Android中如何使用Parcelable进行序列化操作"></a>2.Android中如何使用Parcelable进行序列化操作</h3><p><img src="http://upload-images.jianshu.io/upload_images/3020228-82b0dff63c4d1de3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Parcelable 方法说明"></p>
<p> Implements Parcelable的时候需要实现内部的方法：</p>
<p>1）.writeToParcel 将对象数据序列化成一个Parcel对象(序列化之后成为Parcel对象.以便Parcel容器取出数据)</p>
<p>2）.重写describeContents方法,默认值为0</p>
<p>3）.Public static final Parcelable.Creator<t>CREATOR (将Parcel容器中的数据转换成对象数据) 同时需要实现两个方法:<br>　　3.1 CreateFromParcel(从Parcel容器中取出数据并进行转换.)<br>　　3.2 newArray(int size)返回对象数据的大小</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span>&#123;</span><br><span class="line"> <span class="keyword">private</span> String bookName;</span><br><span class="line"> <span class="keyword">private</span> String author;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">int</span> publishDate;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">()</span></span>&#123;</span><br><span class="line">   </span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">getBookName</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bookName;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookName</span><span class="params">(String bookName)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.bookName = bookName;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">getAuthor</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> author;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthor</span><span class="params">(String author)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.author = author;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPublishDate</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> publishDate;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPublishDate</span><span class="params">(<span class="keyword">int</span> publishDate)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.publishDate = publishDate;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel out, <span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">  out.writeString(bookName);</span><br><span class="line">  out.writeString(author);</span><br><span class="line">  out.writeInt(publishDate);</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Book&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Book&gt;()&#123;</span><br><span class="line">   </span><br><span class="line">　　　　 <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Book[] newArray(<span class="keyword">int</span> size)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Book[size];</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Book <span class="title">createFromParcel</span><span class="params">(Parcel in)</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> Book(in);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(Parcel in)</span></span>&#123;</span><br><span class="line">  <span class="comment">//如果元素数据是list类型的时候需要： lits = new ArrayList&lt;?&gt; in.readList(list); </span></span><br><span class="line">  <span class="comment">//否则会出现空指针异常.并且读出和写入的数据类型必须相同.如果不想对部分关键字进行序列化,可以使用transient关键字来修饰以及static修饰.</span></span><br><span class="line">  bookName = in.readString();</span><br><span class="line">  author = in.readString();</span><br><span class="line">  publishDate = in.readInt();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-Parcelable与Serializable的性能比较"><a href="#3-Parcelable与Serializable的性能比较" class="headerlink" title="3.Parcelable与Serializable的性能比较"></a>3.Parcelable与Serializable的性能比较</h3><p>首先Parcelable的性能要强于Serializable的原因我需要简单的阐述一下</p>
<p>  1）. 在内存的使用中,前者在性能方面要强于后者</p>
<p>  2）. 后者在序列化操作的时候会产生大量的临时变量,(原因是使用了反射机制)从而导致GC的频繁调用,因此在性能上会稍微逊色</p>
<p>  3）. Parcelable是以Ibinder作为信息载体的.在内存上的开销比较小,因此在内存之间进行数据传递的时候,Android推荐使用Parcelable,既然是内存方面比价有优势,那么自然就要优先选择.</p>
<p>  4）. 在读写数据的时候,Parcelable是在内存中直接进行读写,而Serializable是通过使用IO流的形式将数据读写入在硬盘上.</p>
<p>  但是：虽然Parcelable的性能要强于Serializable,但是仍然有特殊的情况需要使用Serializable,而不去使用Parcelable,因为Parcelable无法将数据进行持久化,因此在将数据保存在磁盘的时候,仍然需要使用后者,因为前者无法很好的将数据进行持久化.(原因是在不同的Android版本当中,Parcelable可能会不同,因此数据的持久化方面仍然是使用Serializable)</p>
<h2 id="六、-Binder-（AIDL）"><a href="#六、-Binder-（AIDL）" class="headerlink" title="六、 Binder （AIDL）"></a>六、 Binder （AIDL）</h2><p>Binder 是一个可以很深入的话题，这里不打算深入探究Binder的内部。Android 开发中，Binder主要使用在Service中，包括AIDL和Messager。<br>我们来新建一个AIDL，体验下这个过程，还是以上面的BOOK为例子，首先建两个aidl文件：Book.aidl、IBookManager.aidl。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Book.aidl</span><br><span class="line">package com.ajb.kotlintest;</span><br><span class="line">parcelable Book ;</span><br><span class="line"></span><br><span class="line">// IBookManager.aidl</span><br><span class="line">package com.ajb.kotlintest;</span><br><span class="line"></span><br><span class="line">// Declare any non-default types here with import statements</span><br><span class="line">import com.ajb.kotlintest.Book;</span><br><span class="line">interface IBookManager &#123;</span><br><span class="line">    List&lt;Book&gt; getBookList();</span><br><span class="line">    void addBook(in Book book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>build一下就有了java类文件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ajb.kotlintest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Local-side IPC implementation stub class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">ajb</span>.<span class="title">kotlintest</span>.<span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.ajb.kotlintest.IBookManager"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Cast an IBinder object into an com.ajb.kotlintest.IBookManager interface,</span></span><br><span class="line"><span class="comment">         * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.ajb.kotlintest.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.ajb.kotlintest.IBookManager))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((com.ajb.kotlintest.IBookManager) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.ajb.kotlintest.IBookManager.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(DESCRIPTOR);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_getBookList: &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    java.util.List&lt;com.ajb.kotlintest.Book&gt; _result = <span class="keyword">this</span>.getBookList();</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    reply.writeTypedList(_result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_addBook: &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    com.ajb.kotlintest.Book _arg0;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</span><br><span class="line">                        _arg0 = com.ajb.kotlintest.Book.CREATOR.createFromParcel(data);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _arg0 = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.addBook(_arg0);</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">ajb</span>.<span class="title">kotlintest</span>.<span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> java.util.List&lt;com.ajb.kotlintest.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException &#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                java.util.List&lt;com.ajb.kotlintest.Book&gt; _result;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                    _result = _reply.createTypedArrayList(com.ajb.kotlintest.Book.CREATOR);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.ajb.kotlintest.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    <span class="keyword">if</span> ((book != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">                        book.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBookList = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.util.List&lt;com.ajb.kotlintest.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.ajb.kotlintest.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码是系统生成的，它继承了IInterface这个接口，同时它自己也还是个接口，所有可以在Binder中传输的接口都需要继承IInterface接口。首先，它声明了两个方法getBookList和addBook，显然这就是我们在IBookManager.aidl中所声明的方法，同时它还声明了两个整型的id分别用于标识这两个方法，这两个id用于标识在transact过程中客户端所请求的到底是哪个方法。接着，它声明了一个内部类Stub，这个Stub就是一个Binder类，当客户端和服务端都位于同一个进程时，方法调用不会走跨进程的transact过程，而当两者位于不同进程时，方法调用需要走transact过程，这个逻辑由Stub的内部代理类Proxy来完成。这么来看，IBookManager这个接口的确很简单，但是我们也应该认识到，这个接口的核心实现就是它的内部类Stub和Stub的内部代理类Proxy，下面详细介绍针对这两个类的每个方法的含义。</p>
<p><strong>asInterface(android.os.IBinderobj)</strong><br>用于将服务端的Binder对象转换成客户端所需的AIDL接口类型的对象，这种转换过程是区分进程的，如果客户端和服务端位于同一进程，那么此方法返回的就是服务端的Stub对象本身，否则返回的是系统封装后的Stub.proxy对象。</p>
<p><strong>asBinder</strong><br>此方法用于返回当前Binder对象。</p>
<p><strong>onTransact</strong><br>这个方法运行在服务端中的Binder线程池中，当客户端发起跨进程请求时，远程请求会通过系统底层封装后交由此方法来处理。该方法的原型为 public Booleanon Transact(intcode,android.os.Parcel<br> data,android.os.Parcel reply,int flags)。服务端通过code可以确定客户端所请求的目标方法是什么，接着从data中取出目标方法所需的参数（如果目标方法有参数的话），然后执行目标方法。当目标方法执行完毕后，就向reply中写入返回值（如果目标方法有返回值的话），onTransact方法的执行过程就是这样的。需要注意的是，如果此方法返回false，那么客户端的请求会失败，因此我们可以利用这个特性来做权限验证，毕竟我们也不希望随便一个进程都能远程调用我们的服务。</p>
<p><strong>Proxy#getBookList</strong><br>这个方法运行在客户端，当客户端远程调用此方法时，它的内部实现是这样的：首先创建该方法所需要的输入型Parcel对象_data、输出型Parcel对象_reply和返回值对象List；然后把该方法的参数信息写入_data中（如果有参数的话）；接着调用transact方法来发起RPC（远程过程调用）请求，同时当前线程挂起；然后服务端的onTransact方法会被调用，直到RPC过程返回后，当前线程继续执行，并从_reply中取出RPC过程的返回结果；最后返回_reply中的数据。</p>
<p><strong>Proxy#addBook</strong><br>这个方法运行在客户端，它的执行过程和getBookList是一样的，addBook没有返回值，所以它不需要从_reply中取出返回值。</p>
<p>在服务端需要创建一个 BookManagerImpl 的对象并在 Service 的 onBind 方法中返回即可。以下就是一个服务端的典型实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器端</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Book&gt; mBookList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BookManagerImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BookManagerImpl</span> <span class="keyword">extends</span> <span class="title">IBookManager</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mBookList) &#123;</span><br><span class="line">                <span class="keyword">return</span> mBookList;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mBookList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mBookList.contains(book)) &#123;</span><br><span class="line">                    mBookList.add(book);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">linkToDeath</span><span class="params">(DeathRecipient recipient, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.linkToDeath(recipient, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">unlinkToDeath</span><span class="params">(DeathRecipient recipient, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.unlinkToDeath(recipient, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Binder有两个很重要的方法linkToDeath和unlinkToDeath。</strong></p>
<p>Binder运行在服务端进程，如果服务端进程由于某种原因异常终止，这个时候我们到服务端的Binder连接断裂（称之为Binder死亡），会导致我们的远程调用失败。更为关键的是，如果我们不知道Binder连接已经断裂，那么客户端的功能就会受到影响。</p>
<p>为了解决这个问题，Binder中提供了两个配对的方法linkToDeath和unlinkToDeath，通过linkToDeath我们可以给Binder设置一个死亡代理，当Binder死亡时，我们就会收到通知，这个时候我们就可以重新发起连接请求从而恢复连接。那么到底如何给Binder设置死亡代理呢？也很简单。</p>
<p>首先，声明一个DeathRecipient对象。DeathRecipient是一个接口，其内部只有一个方法binderDied，我们需要实现这个方法，当Binder死亡的时候，系统就会回调binderDied方法，然后我们就可以移出之前绑定的binder代理并重新绑定远程服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//客户端（Activity）内</span></span><br><span class="line">        <span class="keyword">private</span> IBinder.DeathRecipient mDeathRecipient = <span class="keyword">new</span> IBinder.DeathRecipient() &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub  </span></span><br><span class="line">            <span class="keyword">if</span> (mBookManager == <span class="keyword">null</span>)  </span><br><span class="line">                <span class="keyword">return</span>;  </span><br><span class="line">            mBookManager.asBinder().unlinkToDeath(mDeathRecipient, <span class="number">0</span>);  </span><br><span class="line">            mBookManager = <span class="keyword">null</span>;  </span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span>重新绑定远程服务</span></span><br><span class="line">　　　　　　　bindService(<span class="keyword">new</span> Intent(<span class="string">"com.ajb.kotlintest.CustomService"</span>).</span><br><span class="line">　　　　　　　　　　setPackage(<span class="string">"com.ajb.kotlintest"</span>), conn, BIND_AUTO_CREATE);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> ServiceConnection conn = <span class="keyword">new</span> ServiceConnection() &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;  </span><br><span class="line">            mBookManager = IBookManager.Stub.asInterface(service);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                service.linkToDeath(mDeathRecipient, <span class="number">0</span>);  </span><br><span class="line">                Toast.makeText(getApplicationContext(), mBookManager.getName(),  </span><br><span class="line">                        Toast.LENGTH_LONG).show();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;  </span><br><span class="line">                <span class="comment">// TODO Auto-generated catch block  </span></span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;; </span><br><span class="line"><span class="comment">//然后在onCreate先bindService一次，由上面处理重绑。</span></span><br></pre></td></tr></table></figure>
<p>这样我们就能简单的传递信息了，但是这其中还有一些坑我们没遇到过，通过IBinder在服务端与客户端之间传递自定义对象，自定义对象需要实现Parcelable接口，就是说他们是在序列化和反序列化之间运作，服务端与客户端之间传递的对象并不是同一个对象。</p>
<h3 id="5-Listener-在Binder中使用"><a href="#5-Listener-在Binder中使用" class="headerlink" title="5.Listener 在Binder中使用"></a>5.Listener 在Binder中使用</h3><p>虽然说多次，跨进程传输客户端的对象会在服务端生成不同的对象，但是生成的对象有一个共同点，就是它们底层的Binder对象是同一个，RemoteCallbackList利用这一特性，在解除注册Listener时，找到和注册时一样Binder对象的listener进行删除。RemoteCallbackList 当客户端死亡，它自动解除客户端持有的 listener，而且由于其线程同步的特性，不需要额外的线程同步工作。</p>
<p>添加注册和解注册的办法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// IBookManager.aidl</span><br><span class="line">package com.ajb.kotlintest;</span><br><span class="line"></span><br><span class="line">// Declare any non-default types here with import statements</span><br><span class="line">import com.ajb.kotlintest.Book;</span><br><span class="line">interface IBookManager &#123;</span><br><span class="line">    List&lt;Book&gt; getBookList();</span><br><span class="line">    void addBook(in Book book);</span><br><span class="line">    void registerListener( IOnNewBookArrivedListener listener);</span><br><span class="line">    void unregisterListener( IOnNewBookArrivedListener listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Service中，添加相关实现代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RemoteCallbackList&lt; IOnNewBookArrivedListener&gt; mListenerList = <span class="keyword">new</span> RemoteCallbackList&lt; IOnNewBookArrivedListener&gt;(); </span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">( IOnNewBookArrivedListener listener)</span> </span></span><br><span class="line"><span class="function">                                           <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    mListenerList. register( listener);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">( IOnNewBookArrivedListener listener)</span> </span></span><br><span class="line"><span class="function">                                           <span class="keyword">throws</span> RemoteException </span>&#123; </span><br><span class="line">    mListenerList. unregister( listener); </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>利用这些就可以在新书到来之时，通知需要知道的监听者，不需要时就解除注册即可。</p>
<h2 id="七、-ContentProvider"><a href="#七、-ContentProvider" class="headerlink" title="七、 ContentProvider"></a>七、 ContentProvider</h2><p>创建一个自定义的ContentProvider很简单，只需要继承ContentProvider类并实现六个抽象方法即可：onCreate、query、update、insert、delete和getType。</p>
<p><strong>onCreate</strong><br>代表ContentProvider的创建，一般来说我们需要做一些初始化工作；</p>
<p><strong>getType</strong><br>用来返回一个Uri请求所对应的MIME类型（媒体类型），比如图片、视频等，这个媒体类型还是有点复杂的，如果我们的应用不关注这个选项，可以直接在这个方法中返回<strong>null</strong>或者<strong> “ */* ” </strong>；Android系统所提供的MediaStore功能就是文件类型的ContentProvider，详细实现可以参考MediaStore。</p>
<p><strong>query、update、insert、delete</strong><br>剩下的四个方法对应于CRUD操作，即实现对数据表的增删改查功能。</p>
<p>根据Binder的工作原理，我们知道这六个方法均运行在ContentProvider的进程中，除了onCreate由系统回调并运行在主线程里，其他五个方法均由外界回调并运行在Binder线程池中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DbOpenHelper. java </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbOpenHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_NAME = <span class="string">"book_provider. db"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_TABLE_NAME = <span class="string">"book"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TALBE_NAME = <span class="string">"user"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB_VERSION = <span class="number">1</span>; <span class="comment">// 图书和用户信息表</span></span><br><span class="line">    <span class="keyword">private</span> String CREATE_BOOK_TABLE = <span class="string">"CREATE TABLE IF NOT EXISTS "</span> + BOOK_TABLE_NAME + <span class="string">"(_id INTEGER PRIMARY KEY,"</span> + <span class="string">"name TEXT)"</span>;</span><br><span class="line">    <span class="keyword">private</span> String CREATE_USER_TABLE = <span class="string">"CREATE TABLE IF NOT EXISTS "</span> + USER_TALBE_NAME + <span class="string">"(_id INTEGER PRIMARY KEY,"</span> + <span class="string">"name TEXT,"</span> + <span class="string">"sex INT)"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DbOpenHelper</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, DB_NAME, <span class="keyword">null</span>, DB_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">        db.execSQL(CREATE_BOOK_TABLE);</span><br><span class="line">        db.execSQL(CREATE_USER_TABLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123; <span class="comment">// TODO ignored</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ContentProvider. java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BookProvider"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"com.ajb.kotlintest.provider"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri BOOK_CONTENT_URI = Uri.parse(<span class="string">" content://"</span> + AUTHORITY + <span class="string">"/book"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri USER_CONTENT_URI = Uri.parse(<span class="string">" content://"</span> + AUTHORITY + <span class="string">"/user"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOOK_URI_CODE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USER_URI_CODE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher sUriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//使用 UriMatcher 的 addURI 方法将 Uri 和 Uri_Code 关联到一起</span></span><br><span class="line">        sUriMatcher.addURI(AUTHORITY, <span class="string">" book"</span>, BOOK_URI_CODE);</span><br><span class="line">        sUriMatcher.addURI(AUTHORITY, <span class="string">" user"</span>, USER_URI_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> SQLiteDatabase mDb;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" onCreate, current thread:"</span> + Thread.currentThread().getName());</span><br><span class="line">        mContext = getContext();</span><br><span class="line">        initProviderData();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initProviderData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mDb = <span class="keyword">new</span> DbOpenHelper(mContext).getWritableDatabase();</span><br><span class="line">        mDb.execSQL(<span class="string">" delete from "</span> + DbOpenHelper.BOOK_TABLE_NAME);</span><br><span class="line">        mDb.execSQL(<span class="string">" delete from "</span> + DbOpenHelper.USER_TALBE_NAME);</span><br><span class="line"><span class="comment">//ContentProvider创建时，初始化数据库。注意：这里仅仅是为了演示，实际使用中不推荐在主线程中进行耗时的数据库操作</span></span><br><span class="line">        mDb.execSQL(<span class="string">" insert into book values( 3,' Android');"</span>);</span><br><span class="line">        mDb.execSQL(<span class="string">" insert into book values( 4,' Ios');"</span>);</span><br><span class="line">        mDb.execSQL(<span class="string">" insert into book values( 5,' Html5');"</span>);</span><br><span class="line">        mDb.execSQL(<span class="string">" insert into user values( 1,' jake', 1);"</span>);</span><br><span class="line">        mDb.execSQL(<span class="string">" insert into user values( 2,' jasmine', 0);"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" query, current thread:"</span> + Thread.currentThread().getName());</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">" Unsupported URI: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mDb.query(table, projection, selection, selectionArgs, <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" getType"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" insert"</span>);</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">" Unsupported URI: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        mDb.insert(table, <span class="keyword">null</span>, values);</span><br><span class="line">        mContext.getContentResolver().notifyChange(uri, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" delete"</span>);</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">" Unsupported URI: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> count = mDb.delete(table, selection, selectionArgs);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[]</span></span></span><br><span class="line"><span class="function"><span class="params">            selectionArgs)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">" update"</span>);</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">" Unsupported URI: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> row = mDb.update(table, values, selection, selectionArgs);</span><br><span class="line">        <span class="keyword">if</span> (row &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> row;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTableName</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        String tableName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (sUriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> BOOK_URI_CODE:</span><br><span class="line">                tableName = DbOpenHelper.BOOK_TABLE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> USER_URI_CODE:</span><br><span class="line">                tableName = DbOpenHelper.USER_TALBE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tableName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContentProvider 通过 Uri 来区分外界要访问的的数据集合，为了知道外界要访问的是哪个表，我们需要为它们定义单独的 Uri 和 Uri_Code ，并将 Uri 和对应的 Uri_Code 相关联，我们可以使用 UriMatcher 的 addURI 方法将 Uri 和 Uri_Code 关联到一起。这样，当外界请求访问 BookProvider 时，我们就可以根据请求的 Uri 来得到 Uri_Code ，有了 Uri_Code 我们就可以知道外界想要访问哪个表，然后就可以进行相应的数据操作了，</p>
<p>接着我们需要注册这个 BookProvider，否则它无法向外界提供有效的数据。 如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider </span><br><span class="line">        android:name = &quot;.provider.BookProvider&quot; </span><br><span class="line">        android:authorities = &quot;com.ajb.kotlintest.provider&quot; </span><br><span class="line">        android:permission = &quot;com.ajb.kotlintest.PROVIDER&quot; </span><br><span class="line">        android:process = &quot;:provider&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>注册了ContentProvider以后，我们就可以在外部应用中访问它了。</p>
<p><strong>注意点：</strong>android:authorities 必须是唯一的，这里建议加上包名前缀。android:process让BookProvider运行在独立的进程中并给它添加了权限，这样外界应用如果想访问BookProvider，就必须声明“com.ajb.kotlin.PROVIDER”这个权限。ContentProvider的权限还可以细分为读权限和写权限，分别对应android:readPermission和android:writePermission属性，如果分别声明了读权限和写权限，那么外界应用也必须依次声明相应的权限才可以进行读/写操作，否则外界应用会异常终止。</p>
<h2 id="八、Messenger"><a href="#八、Messenger" class="headerlink" title="八、Messenger"></a>八、Messenger</h2><p> Messenger 的使用方法很简单，它对 AIDL 做了封装，使得我们可以更简便地进行进程间通信。同时，由于它一次处理一个请求，因此在服务端我们不用考虑线程同步的问题，这是因为服务端中不存在并发执行的情形。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessengerService"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_FROM_CLIENT = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MSG_FROM_CLIENT:</span><br><span class="line">                    Log.i(TAG, <span class="string">" receive msg from Client:"</span> + msg.getData().getString(<span class="string">" msg"</span>));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> MessengerHandler());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMessenger.getBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于 Messenger的介绍就这么多，更详细的资料请查看相关网络资料。</p>
<h2 id="九、-Socket"><a href="#九、-Socket" class="headerlink" title="九、 Socket"></a>九、 Socket</h2><p>我们也可以通过 Socket 来实现进程间的通信。 Socket 也称为“套接字”，它分为流式套接字( TCP 协议)和用户数据报套接字( UDP 协议)两种。 </p>
<p>TCP 协议是<strong>面向连接</strong>的协议，提供稳定的双向通信功能， TCP 连接的建立需要经过“三次握手”才能完成，为了提供稳定的数据传输功能，其本身提供了<strong>超时重传机制</strong>，因此具有很高的稳定性；</p>
<p>而 UDP 是<strong>无连接</strong>的，提供不稳定的单向通信功能，当然 UDP 也可以实现双向通信功能。在性能上， UDP 具有更好的效率，其缺点是<strong>不保证数据一定能够正确传输</strong>，尤其是在网络拥塞的情况下。关于 TCP 和 UDP 的介绍就这么多，更详细的资料请查看相关网络资料。</p>
<p>至此，Android IPC机制的介绍暂告一段落了。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bundle</td>
<td>简单易用</td>
<td>只能传输Bundle支持的数据类型</td>
<td>四大组件间的进程间通信</td>
</tr>
<tr>
<td>文件共享</td>
<td>简单易用</td>
<td>不适合高并发场景，并且无法做到进程间即时通信</td>
<td>无并发访问情形，交换简单的数据实时性不高的场景</td>
</tr>
<tr>
<td>AIDL</td>
<td>功能强大，支持一对多并发通信，支持实时通信</td>
<td>使用稍复杂，需要处理好线程同步</td>
<td>一对多通信且有RPC需求</td>
</tr>
<tr>
<td>Messenger</td>
<td>功能一般，支持一对多串行通信，支持实时通信</td>
<td>不能很处理高并发清醒，不支持RPC，数据通过Message进行传输，因此只能传输Bundle支持的数据类型</td>
<td>低并发的一对多即时通信，无RPC需求，或者无需返回结果的RPC需求</td>
</tr>
<tr>
<td>ContentProvider</td>
<td>在数据源访问方面功能强大，支持一对多并发数据共享，可通过Call方法扩展其他操作</td>
<td>可以理解为受约束的AIDL，主要提供数据源的CRUD操作</td>
<td>一对多的进程间数据共享</td>
</tr>
<tr>
<td>Socket</td>
<td>功能请打，可以通过网络传输字节流，支持一对多并发实时通信</td>
<td>实现细节稍微有点烦琐，不支持直接的RPC</td>
<td>网络数据交换</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://kuwork.github.io/2017/05/02/Android开发：Mac下快速处理图标大小/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuwork">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="K.W. 时间囊">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/02/Android开发：Mac下快速处理图标大小/" itemprop="url">
                  Android开发：Mac下快速处理图标大小
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-02T16:02:57+08:00">
                2017-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/3020228-2efb6d1270914def.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>笔者在Mac下进行开发，UI一般不会具体给到每一个尺寸的图标，自己动手丰衣足食咯。<br>具体的尺寸，先前的文章有给出，<a href="http://www.jianshu.com/p/b971818d9ab2" target="_blank" rel="noopener">Android开发命名规范及部分图标准则</a>。</p>
<p>原理是利用sips命令将图片居中放缩处理(没有做边距处理，需要原图有边距)，涉及简单的 mkdir、awk、xargs 命令。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-b5c1bab56e5064c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>创建一个makelogo.sh文件，写入下面的代码：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>! /bin/bash</span><br><span class="line"><span class="meta">#</span>测试Demo ./makelogo.sh 1 drawable ic_launcher-web.png ic_launcher.png</span><br><span class="line"><span class="meta">#</span> 1：APK LOGO 2：通知栏图标 3：ActionBar图标</span><br><span class="line">type=$1 </span><br><span class="line">dirname=$2</span><br><span class="line">pic=$3</span><br><span class="line">out=$4</span><br><span class="line">mkdir ./res 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">mkdir ./res/$&#123;dirname&#125;-xxhdpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">mkdir ./res/$&#123;dirname&#125;-xhdpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">mkdir ./res/$&#123;dirname&#125;-hdpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">mkdir ./res/$&#123;dirname&#125;-mdpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">mkdir ./res/$&#123;dirname&#125;-ldpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">echo '原图片信息如下：'</span><br><span class="line">ls -lh $pic</span><br><span class="line"></span><br><span class="line">echo '生成图片信息如下：'</span><br><span class="line">if [[ type -eq "1" ]]; then</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-xxxhdpi 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line"><span class="meta">  #</span> LOGO</span><br><span class="line">  sips $pic -Z 192 --out ./res/$&#123;dirname&#125;-xxxhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 144 --out ./res/$&#123;dirname&#125;-xxhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 96 --out ./res/$&#123;dirname&#125;-xhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 72 --out ./res/$&#123;dirname&#125;-hdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 48 --out ./res/$&#123;dirname&#125;-mdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 36 --out ./res/$&#123;dirname&#125;-ldpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">elif [[ type -eq "2" ]]; then</span><br><span class="line"><span class="meta">  #</span>Notification Icons</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-xxhdpi-v9 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-xxhdpi-v11 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-xhdpi-v9 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-xhdpi-v11 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-mdpi-v9 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">  mkdir ./res/$&#123;dirname&#125;-mdpi-v11 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">  sips $pic -z 75 75 -p 75 75 --out ./res/$&#123;dirname&#125;-xxhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 48 48 -p 75 48 --out ./res/$&#123;dirname&#125;-xxhdpi-v9/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 72 72 -p 72 72 --out ./res/$&#123;dirname&#125;-xxhdpi-v11/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 50 50 -p 50 50 --out ./res/$&#123;dirname&#125;-xhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 32 32 -p 50 32 --out ./res/$&#123;dirname&#125;-xhdpi-v9/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 48 48 -p 48 48 --out ./res/$&#123;dirname&#125;-xhdpi-v11/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 38 38 -p 38 38 --out ./res/$&#123;dirname&#125;-hdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 24 24 -p 38 24 --out ./res/$&#123;dirname&#125;-hdpi-v9/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 36 36 -p 36 36 --out ./res/$&#123;dirname&#125;-hdpi-v11/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 25 25 -p 25 25 --out ./res/$&#123;dirname&#125;-mdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 16 16 -p 25 16 --out ./res/$&#123;dirname&#125;-mdpi-v9/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -z 24 24 -p 24 24 --out ./res/$&#123;dirname&#125;-mdpi-v11/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line"></span><br><span class="line">elif [[ type -eq "3" ]]; then</span><br><span class="line"><span class="meta">  #</span> Actionbar 图标</span><br><span class="line">  sips $pic -Z 96 --out ./res/$&#123;dirname&#125;-xxhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 64 --out ./res/$&#123;dirname&#125;-xhdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 48 --out ./res/$&#123;dirname&#125;-hdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">  sips $pic -Z 32 --out ./res/$&#123;dirname&#125;-mdpi/$out |awk '&#123;print $1&#125;'|sed -n '2p'|xargs ls -lh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>赋予执行权限：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./makelogo.sh</span><br></pre></td></tr></table></figure></p>
<p>测试前文件如下:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-e60900621deb1908.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="运行前"></p>
<p>接下来测试一下，创建通知栏图标，一般放在drawable，需要在res的父目录执行此文件，将“actionbar_camera.png”重命名为“noti_camera.png”放入res各级目录中，执行如下命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./makelogo.sh 2 drawable actionbar_camera.png noti_camera.png</span><br></pre></td></tr></table></figure></p>
<p>执行结果:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-297ba2f3abe90ceb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>执行后目录结构:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3020228-767c244b556839b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Kuwork" />
          <p class="site-author-name" itemprop="name">Kuwork</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kuwork</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
